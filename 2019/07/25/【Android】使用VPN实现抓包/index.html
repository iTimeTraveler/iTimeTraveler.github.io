<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>ã€androidã€‘ ä½¿ç”¨vpnå®ç°æŠ“åŒ… | iTimeTraveler</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
    <meta name="keywords" content="VPN" />
  
  
  
  
  <meta name="description" content="VPNæŠ“åŒ…ä½¿ç”¨VPNæŠ€æœ¯å¯ä»¥ç›´æ¥è·å¾—ç½‘ç»œä¸‰å±‚IPæŠ¥æ–‡ï¼Œå¯ä»¥ä¸å¯ä»¥åŸºäºæ­¤å®ç°ç§»åŠ¨ç«¯æŠ“åŒ…å‘¢ï¼Ÿè‚¯å®šå¯ä»¥ï¼ŒAndroidå·²ç»æœ‰å¤§æ‰¹å¼€æºåº“åŸºäºè¯¥æ€è·¯å®ç°æŠ“åŒ…ã€‚æˆ‘ä»¬æ¥å­¦ä¹ ä¸‹åŸç†ã€‚ VpnServiceVpnServiceæ˜¯å¼€å‘Android VPNçš„åŸºç¡€ï¼Œä¸‹é¢æ˜¯å®˜æ–¹æ–‡æ¡£çš„é˜é‡Š  VpnService is a base class for applications to extend and build th">
<meta name="keywords" content="VPN">
<meta property="og:type" content="article">
<meta property="og:title" content="ã€Androidã€‘ ä½¿ç”¨VPNå®ç°æŠ“åŒ…">
<meta property="og:url" content="https://itimetraveler.github.io/2019/07/25/ã€Androidã€‘ä½¿ç”¨VPNå®ç°æŠ“åŒ…/index.html">
<meta property="og:site_name" content="iTimeTraveler">
<meta property="og:description" content="VPNæŠ“åŒ…ä½¿ç”¨VPNæŠ€æœ¯å¯ä»¥ç›´æ¥è·å¾—ç½‘ç»œä¸‰å±‚IPæŠ¥æ–‡ï¼Œå¯ä»¥ä¸å¯ä»¥åŸºäºæ­¤å®ç°ç§»åŠ¨ç«¯æŠ“åŒ…å‘¢ï¼Ÿè‚¯å®šå¯ä»¥ï¼ŒAndroidå·²ç»æœ‰å¤§æ‰¹å¼€æºåº“åŸºäºè¯¥æ€è·¯å®ç°æŠ“åŒ…ã€‚æˆ‘ä»¬æ¥å­¦ä¹ ä¸‹åŸç†ã€‚ VpnServiceVpnServiceæ˜¯å¼€å‘Android VPNçš„åŸºç¡€ï¼Œä¸‹é¢æ˜¯å®˜æ–¹æ–‡æ¡£çš„é˜é‡Š  VpnService is a base class for applications to extend and build th">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://itimetraveler.github.io/gallery/android_common/VPN-Tunnel.png">
<meta property="og:updated_time" content="2019-12-13T09:54:12.826Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="ã€Androidã€‘ ä½¿ç”¨VPNå®ç°æŠ“åŒ…">
<meta name="twitter:description" content="VPNæŠ“åŒ…ä½¿ç”¨VPNæŠ€æœ¯å¯ä»¥ç›´æ¥è·å¾—ç½‘ç»œä¸‰å±‚IPæŠ¥æ–‡ï¼Œå¯ä»¥ä¸å¯ä»¥åŸºäºæ­¤å®ç°ç§»åŠ¨ç«¯æŠ“åŒ…å‘¢ï¼Ÿè‚¯å®šå¯ä»¥ï¼ŒAndroidå·²ç»æœ‰å¤§æ‰¹å¼€æºåº“åŸºäºè¯¥æ€è·¯å®ç°æŠ“åŒ…ã€‚æˆ‘ä»¬æ¥å­¦ä¹ ä¸‹åŸç†ã€‚ VpnServiceVpnServiceæ˜¯å¼€å‘Android VPNçš„åŸºç¡€ï¼Œä¸‹é¢æ˜¯å®˜æ–¹æ–‡æ¡£çš„é˜é‡Š  VpnService is a base class for applications to extend and build th">
<meta name="twitter:image" content="https://itimetraveler.github.io/gallery/android_common/VPN-Tunnel.png">
  
    <link rel="alternate" href="/atom.xml" title="iTimeTraveler" type="application/atom+xml">
  

  

  <link rel="icon" href="/gallery/avatar/0.jpg">
  <link rel="apple-touch-icon" href="/gallery/avatar/0.jpg">
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link href="https://fonts.googleapis.com/css?family=Open+Sans|Montserrat:700" rel="stylesheet" type="text/css">
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,300,300italic,400italic" rel="stylesheet" type="text/css">
  <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">
  <style type="text/css">
    @font-face{font-family:futura-pt; src:url("css/fonts/FuturaPTBold.otf") format("woff");font-weight:500;font-style:normal;}
    @font-face{font-family:futura-pt-light; src:url("css/fonts/FuturaPTBook.otf") format("woff");font-weight:lighter;font-style:normal;}
    @font-face{font-family:futura-pt-italic; src:url("css/fonts/FuturaPTBookOblique.otf") format("woff");font-weight:400;font-style:italic;}
}

  </style>
  <link rel="stylesheet" href="../../../../css/style.css">

  <script src="../../../../js/jquery-3.1.1.min.js"></script>
  <script src="../../../../js/bootstrap.js"></script>

  <!-- Bootstrap core CSS -->
  <link rel="stylesheet" href="/css/bootstrap.css" >

  
    <link rel="stylesheet" href="../../../../css/dialog.css">
  

  

  
    <link rel="stylesheet" href="/css/header-post.css" >
  

  
  
  
    <link rel="stylesheet" href="/css/vdonate.css" >
  

</head>



  <body data-spy="scroll" data-target="#toc" data-offset="50">


  
  <div id="container">
    <div id="wrap">
      
        <header>

    <div id="allheader" class="navbar navbar-default navbar-static-top" role="navigation">
        <div class="navbar-inner">
          
          <div class="container"> 
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
              <span class="sr-only">Toggle navigation</span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>

            
              <a class="brand" style="
                 border-width: 0px;  margin-top: 8px;"  
                href="#" data-toggle="modal" data-target="#myModal" >
                  <img width="62px" height="75px" alt="Hike News" src="/gallery/avatar/0.jpg">
              </a>
            
            
            <div class="navbar-collapse collapse">
              <ul class="hnav navbar-nav">
                
                  <li> <a class="main-nav-link" href="../../../../index.html">é¦–é¡µ</a> </li>
                
                  <li> <a class="main-nav-link" href="../../../../archives">å½’æ¡£</a> </li>
                
                  <li> <a class="main-nav-link" href="../../../../categories">åˆ†ç±»</a> </li>
                
                  <li> <a class="main-nav-link" href="../../../../tags">æ ‡ç­¾</a> </li>
                
                  <li> <a class="main-nav-link" href="../../../../funnysite">é…·ç«™</a> </li>
                
                  <li> <a class="main-nav-link" href="../../../../collection">æ”¶è—</a> </li>
                
                  <li> <a class="main-nav-link" href="../../../../about">å…³äº</a> </li>
                
                  <li> <a class="main-nav-link" href="../../../../mybooks">ğŸ</a> </li>
                
                  <li><div id="search-form-wrap">

    <form class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="" />
        <button type="submit" class="search-form-submit"></button>
    </form>
    <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" placeholder="è¯·è¾“å…¥å…³é”®è¯..." />
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: 'æ–‡ç« ',
            PAGES: 'é¡µé¢',
            CATEGORIES: 'åˆ†ç±»',
            TAGS: 'æ ‡ç­¾',
            UNTITLED: '(æ— æ ‡é¢˜)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '../../../../content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>
<script src="../../../../js/insight.js"></script>

</div></li>
            </div>
          </div>
                
      </div>
    </div>

</header>



      
            
      <div id="content" class="outer">
        
          <section id="main" style="float:none;"><article id="post-ã€Androidã€‘ä½¿ç”¨VPNå®ç°æŠ“åŒ…" style="width: 75%; float:left;" class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="article-inner">
    
<div class="article-gallery">
  <div class="article-gallery-photos">
    
      <a class="article-gallery-img fancybox" href="../../../../gallery/android_common/VPN-Tunnel.png" rel="gallery_ck445is8z006jkis6rn46fms1">
        <img src="../../../../gallery/android_common/VPN-Tunnel.png" itemprop="image">
      </a>
    
  </div>
</div>

    
      <header class="article-header">
        
  
    <h1 class="thumb" class="article-title" itemprop="name">
      ã€Androidã€‘ ä½¿ç”¨VPNå®ç°æŠ“åŒ…
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="" class="article-date">
	  <time datetime="2019-07-25T14:20:55.000Z" itemprop="datePublished">2019-07-25</time>
	</a>

      
    <a class="article-category-link" href="../../../../categories/Android/">Android</a>

      
	<a class="article-views">
	<span id="busuanzi_container_page_pv">
		é˜…è¯»é‡<span id="busuanzi_value_page_pv"></span>
	</span>
	</a>

      

    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="VPNæŠ“åŒ…"><a href="#VPNæŠ“åŒ…" class="headerlink" title="VPNæŠ“åŒ…"></a>VPNæŠ“åŒ…</h2><p>ä½¿ç”¨VPNæŠ€æœ¯å¯ä»¥ç›´æ¥è·å¾—ç½‘ç»œä¸‰å±‚IPæŠ¥æ–‡ï¼Œå¯ä»¥ä¸å¯ä»¥åŸºäºæ­¤å®ç°ç§»åŠ¨ç«¯æŠ“åŒ…å‘¢ï¼Ÿè‚¯å®šå¯ä»¥ï¼ŒAndroidå·²ç»æœ‰å¤§æ‰¹å¼€æºåº“åŸºäºè¯¥æ€è·¯å®ç°æŠ“åŒ…ã€‚æˆ‘ä»¬æ¥å­¦ä¹ ä¸‹åŸç†ã€‚</p>
<h2 id="VpnService"><a href="#VpnService" class="headerlink" title="VpnService"></a>VpnService</h2><p>VpnServiceæ˜¯å¼€å‘Android VPNçš„åŸºç¡€ï¼Œä¸‹é¢æ˜¯<a href="https://developer.android.com/reference/android/net/VpnService" target="_blank" rel="noopener">å®˜æ–¹æ–‡æ¡£</a>çš„é˜é‡Š</p>
<blockquote>
<p>VpnService is a base class for applications to extend and build their own VPN solutions. In general, it creates a virtual network interface, configures addresses and routing rules, and returns a file descriptor to the application. Each read from the descriptor retrieves an outgoing packet which was routed to the interface. Each write to the descriptor injects an incoming packet just like it was received from the interface. The interface is running on Internet Protocol (IP), so packets are always started with IP headers. The application then completes a VPN connection by processing and exchanging packets with the remote server over a tunnel.</p>
</blockquote>
<p>ä¸Šé¢çš„é˜é‡Šçš„é‡ç‚¹æ˜¯ï¼š</p>
<ul>
<li>è™šæ‹Ÿä¸€ä¸ªç½‘å¡</li>
<li>è¿”å›æ–‡ä»¶æè¿°ç¬¦</li>
<li>è¯»å†™çš„å†…å®¹æ˜¯ipæ•°æ®æŠ¥</li>
</ul>
<p>é¦–å…ˆæ¨èAndroidå®˜æ–¹æä¾›äº†çš„Exampleï¼š<a href="https://android.googlesource.com/platform/development/+/master/samples/ToyVpn" target="_blank" rel="noopener">ToyVpn</a>ã€‚è¿™ä¸ªä¾‹å­æ¯”è¾ƒç®€å•ï¼Œå®æ“ä¸€éå¯ä»¥å¸®åŠ©ç†è§£VPNåŸç†ã€‚</p>
<p>åˆæ­¥æ­ä¸€ä¸ªvpnåº”ç”¨æ¡†æ¶ä¹Ÿå¯ä»¥å‚è€ƒ<a href="https://www.tuicool.com/articles/uuiMje" target="_blank" rel="noopener">è¿™ç¯‡æ–‡ç« </a>ï¼Œè¿™ä¸ªä»…ä»…æ˜¯æ­å»ºäº†æ¡†æ¶ï¼ŒåŠŸèƒ½ï¼ˆipæ•°æ®åŒ…çš„æ”¶å‘ï¼‰åˆ™æ²¡æœ‰å®ç°ã€‚</p>
<h2 id="æºç åˆ†æ"><a href="#æºç åˆ†æ" class="headerlink" title="æºç åˆ†æ"></a>æºç åˆ†æ</h2><p>Androidç³»ç»Ÿæä¾›çš„APIæ˜¯VpnServiceï¼Œæˆ‘ä»¬è°ƒç”¨<code>establish()</code>æ–¹æ³•ä¹‹åä¼šè¿”å›ä¸€ä¸ªFDã€‚ç„¶åæˆ‘ä»¬è¯»å–è¯¥FDå°±èƒ½è·å¾—ipæ•°æ®æŠ¥æ–‡ï¼Œé€šè¿‡å‘å¾€VPN Serverï¼Œå†è·å¾—Serverçš„å›å¤æŠ¥æ–‡ä¹‹åå†å†™å…¥è¯¥FDï¼Œå°±å¯ä»¥å®ç°VPNé€šä¿¡ã€‚</p>
<h3 id="VpnService-establish"><a href="#VpnService-establish" class="headerlink" title="VpnService#establish()"></a>VpnService#establish()</h3><p>[-&gt; frameworks/base/core/java/android/net/VpnService.java]</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* Create a VPN interface using the parameters supplied to this</span></span><br><span class="line"><span class="comment">* builder. The interface works on IP packets, and a file descriptor</span></span><br><span class="line"><span class="comment">* is returned for the application to access them. Each read</span></span><br><span class="line"><span class="comment">* retrieves an outgoing packet which was routed to the interface.</span></span><br><span class="line"><span class="comment">* Each write injects an incoming packet just like it was received</span></span><br><span class="line"><span class="comment">* from the interface. The file descriptor is put into non-blocking</span></span><br><span class="line"><span class="comment">* mode by default to avoid blocking Java threads. To use the file</span></span><br><span class="line"><span class="comment">* descriptor completely in native space, see</span></span><br><span class="line"><span class="comment">* &#123;<span class="doctag">@link</span> ParcelFileDescriptor#detachFd()&#125;. The application MUST</span></span><br><span class="line"><span class="comment">* close the file descriptor when the VPN connection is terminated.</span></span><br><span class="line"><span class="comment">* The VPN interface will be removed and the network will be</span></span><br><span class="line"><span class="comment">* restored by the system automatically.</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* &lt;p&gt;To avoid conflicts, there can be only one active VPN interface</span></span><br><span class="line"><span class="comment">* at the same time. Usually network parameters are never changed</span></span><br><span class="line"><span class="comment">* during the lifetime of a VPN connection. It is also common for an</span></span><br><span class="line"><span class="comment">* application to create a new file descriptor after closing the</span></span><br><span class="line"><span class="comment">* previous one. However, it is rare but not impossible to have two</span></span><br><span class="line"><span class="comment">* interfaces while performing a seamless handover. In this case, the</span></span><br><span class="line"><span class="comment">* old interface will be deactivated when the new one is created</span></span><br><span class="line"><span class="comment">* successfully. Both file descriptors are valid but now outgoing</span></span><br><span class="line"><span class="comment">* packets will be routed to the new interface. Therefore, after</span></span><br><span class="line"><span class="comment">* draining the old file descriptor, the application MUST close it</span></span><br><span class="line"><span class="comment">* and start using the new file descriptor. If the new interface</span></span><br><span class="line"><span class="comment">* cannot be created, the existing interface and its file descriptor</span></span><br><span class="line"><span class="comment">* remain untouched.</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* &lt;p&gt;An exception will be thrown if the interface cannot be created</span></span><br><span class="line"><span class="comment">* for any reason. However, this method returns &#123;<span class="doctag">@code</span> null&#125; if the</span></span><br><span class="line"><span class="comment">* application is not prepared or is revoked. This helps solve</span></span><br><span class="line"><span class="comment">* possible race conditions between other VPN applications.</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* <span class="doctag">@return</span> &#123;<span class="doctag">@link</span> ParcelFileDescriptor&#125; of the VPN interface, or</span></span><br><span class="line"><span class="comment">*         &#123;<span class="doctag">@code</span> null&#125; if the application is not prepared.</span></span><br><span class="line"><span class="comment">* <span class="doctag">@throws</span> IllegalArgumentException if a parameter is not accepted</span></span><br><span class="line"><span class="comment">*         by the operating system.</span></span><br><span class="line"><span class="comment">* <span class="doctag">@throws</span> IllegalStateException if a parameter cannot be applied</span></span><br><span class="line"><span class="comment">*         by the operating system.</span></span><br><span class="line"><span class="comment">* <span class="doctag">@throws</span> SecurityException if the service is not properly declared</span></span><br><span class="line"><span class="comment">*         in &#123;<span class="doctag">@code</span> AndroidManifest.xml&#125;.</span></span><br><span class="line"><span class="comment">* <span class="doctag">@see</span> VpnService</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ParcelFileDescriptor <span class="title">establish</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   mConfig.addresses = mAddresses;</span><br><span class="line">   mConfig.routes = mRoutes;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">try</span> &#123;</span><br><span class="line">       <span class="keyword">return</span> getService().establishVpn(mConfig);</span><br><span class="line">   &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(e);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* Use IConnectivityManager since those methods are hidden and not</span></span><br><span class="line"><span class="comment">* available in ConnectivityManager.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> IConnectivityManager <span class="title">getService</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> IConnectivityManager.Stub.asInterface(</span><br><span class="line">          ServiceManager.getService(Context.CONNECTIVITY_SERVICE));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å…¶å®æ˜¯è°ƒç”¨äº†ConnectivityService è¿™ä¸ªç³»ç»ŸæœåŠ¡çš„ <code>establishVpn(mConfig)</code>æ–¹æ³•ã€‚</p>
<h3 id="ConnectivityService-establishVpn"><a href="#ConnectivityService-establishVpn" class="headerlink" title="ConnectivityService#establishVpn()"></a>ConnectivityService#establishVpn()</h3><p>[-&gt; frameworks/base/services/core/java/com/android/server/ConnectivityService.java]</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> SparseArray&lt;Vpn&gt; mVpns = <span class="keyword">new</span> SparseArray&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * Configure a TUN interface and return its file descriptor. Parameters</span></span><br><span class="line"><span class="comment">  * are encoded and opaque to this class. This method is used by VpnBuilder</span></span><br><span class="line"><span class="comment">  * and not available in ConnectivityManager. Permissions are checked in</span></span><br><span class="line"><span class="comment">  * Vpn class.</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@hide</span></span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="meta">@Override</span></span><br><span class="line"> <span class="function"><span class="keyword">public</span> ParcelFileDescriptor <span class="title">establishVpn</span><span class="params">(VpnConfig config)</span> </span>&#123;</span><br><span class="line">     <span class="keyword">int</span> user = UserHandle.getUserId(Binder.getCallingUid());</span><br><span class="line">     <span class="keyword">synchronized</span> (mVpns) &#123;</span><br><span class="line">         throwIfLockdownEnabled();</span><br><span class="line">         <span class="comment">// mVpnså…¶å®æ˜¯ä¸ªVpnæ•°ç»„</span></span><br><span class="line">         <span class="keyword">return</span> mVpns.get(user).establish(config);</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<h3 id="Vpn-establish"><a href="#Vpn-establish" class="headerlink" title="Vpn#establish()"></a>Vpn#establish()</h3><p>[-&gt; frameworks/base/services/core/java/com/android/server/connectivity/Vpn.java]</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Establish a VPN network and return the file descriptor of the VPN interface. This methods</span></span><br><span class="line"><span class="comment"> * returns &#123;<span class="doctag">@code</span> null&#125; if the application is revoked or not prepared.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> config The parameters to configure the network.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> The file descriptor of the VPN interface.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> ParcelFileDescriptor <span class="title">establish</span><span class="params">(VpnConfig config)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Check if the caller is already prepared.</span></span><br><span class="line">    UserManager mgr = UserManager.get(mContext);</span><br><span class="line">    <span class="keyword">if</span> (Binder.getCallingUid() != mOwnerUID) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Check to ensure consent hasn't been revoked since we were prepared.</span></span><br><span class="line">    <span class="keyword">if</span> (!isVpnUserPreConsented(mPackage)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Check if the service is properly declared.</span></span><br><span class="line">    Intent intent = <span class="keyword">new</span> Intent(VpnConfig.SERVICE_INTERFACE);</span><br><span class="line">    intent.setClassName(mPackage, config.user);</span><br><span class="line">    <span class="keyword">long</span> token = Binder.clearCallingIdentity();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// Restricted users are not allowed to create VPNs, they are tied to Owner</span></span><br><span class="line">        UserInfo user = mgr.getUserInfo(mUserHandle);</span><br><span class="line">        <span class="keyword">if</span> (user.isRestricted()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(<span class="string">"Restricted users cannot establish VPNs"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ResolveInfo info = AppGlobals.getPackageManager().resolveService(intent,</span><br><span class="line">                <span class="keyword">null</span>, <span class="number">0</span>, mUserHandle);</span><br><span class="line">        <span class="keyword">if</span> (info == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(<span class="string">"Cannot find "</span> + config.user);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!BIND_VPN_SERVICE.equals(info.serviceInfo.permission)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(config.user + <span class="string">" does not require "</span> + BIND_VPN_SERVICE);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(<span class="string">"Cannot find "</span> + config.user);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        Binder.restoreCallingIdentity(token);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Save the old config in case we need to go back.</span></span><br><span class="line">    VpnConfig oldConfig = mConfig;</span><br><span class="line">    String oldInterface = mInterface;</span><br><span class="line">    Connection oldConnection = mConnection;</span><br><span class="line">    NetworkAgent oldNetworkAgent = mNetworkAgent;</span><br><span class="line">    Set&lt;UidRange&gt; oldUsers = mNetworkCapabilities.getUids();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è°ƒç”¨jniCreateæ–¹æ³•åˆ›å»ºäº†ä¸€ä¸ªFD</span></span><br><span class="line">    <span class="comment">// Configure the interface. Abort if any of these steps fails.</span></span><br><span class="line">    ParcelFileDescriptor tun = ParcelFileDescriptor.adoptFd(jniCreate(config.mtu));</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        String interfaze = jniGetName(tun.getFd());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// TEMP use the old jni calls until there is support for netd address setting</span></span><br><span class="line">        StringBuilder builder = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">        <span class="keyword">for</span> (LinkAddress address : config.addresses) &#123;</span><br><span class="line">            builder.append(<span class="string">" "</span>);</span><br><span class="line">            builder.append(address);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (jniSetAddresses(interfaze, builder.toString()) &lt; <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"At least one address must be specified"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        Connection connection = <span class="keyword">new</span> Connection();</span><br><span class="line">        <span class="keyword">if</span> (!mContext.bindServiceAsUser(intent, connection,</span><br><span class="line">                Context.BIND_AUTO_CREATE | Context.BIND_FOREGROUND_SERVICE,</span><br><span class="line">                <span class="keyword">new</span> UserHandle(mUserHandle))) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Cannot bind "</span> + config.user);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mConnection = connection;</span><br><span class="line">        mInterface = interfaze;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Fill more values.</span></span><br><span class="line">        config.user = mPackage;</span><br><span class="line">        config.interfaze = mInterface;</span><br><span class="line">        config.startTime = SystemClock.elapsedRealtime();</span><br><span class="line">        mConfig = config;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Set up forwarding and DNS rules.</span></span><br><span class="line">        <span class="comment">// First attempt to do a seamless handover that only changes the interface name and</span></span><br><span class="line">        <span class="comment">// parameters. If that fails, disconnect.</span></span><br><span class="line">        <span class="keyword">if</span> (oldConfig != <span class="keyword">null</span></span><br><span class="line">                &amp;&amp; updateLinkPropertiesInPlaceIfPossible(mNetworkAgent, oldConfig)) &#123;</span><br><span class="line">            <span class="comment">// Keep mNetworkAgent unchanged</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            mNetworkAgent = <span class="keyword">null</span>;</span><br><span class="line">            updateState(DetailedState.CONNECTING, <span class="string">"establish"</span>);</span><br><span class="line">            <span class="comment">// Set up forwarding and DNS rules.</span></span><br><span class="line">            agentConnect();</span><br><span class="line">            <span class="comment">// Remove the old tun's user forwarding rules</span></span><br><span class="line">            <span class="comment">// The new tun's user rules have already been added above so they will take over</span></span><br><span class="line">            <span class="comment">// as rules are deleted. This prevents data leakage as the rules are moved over.</span></span><br><span class="line">            agentDisconnect(oldNetworkAgent);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (oldConnection != <span class="keyword">null</span>) &#123;</span><br><span class="line">            mContext.unbindService(oldConnection);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (oldInterface != <span class="keyword">null</span> &amp;&amp; !oldInterface.equals(interfaze)) &#123;</span><br><span class="line">            jniReset(oldInterface);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            IoUtils.setBlocking(tun.getFileDescriptor(), config.blocking);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(</span><br><span class="line">                    <span class="string">"Cannot set tunnel's fd as blocking="</span> + config.blocking, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RuntimeException e) &#123;</span><br><span class="line">        IoUtils.closeQuietly(tun);</span><br><span class="line">        <span class="comment">// If this is not seamless handover, disconnect partially-established network when error</span></span><br><span class="line">        <span class="comment">// occurs.</span></span><br><span class="line">        <span class="keyword">if</span> (oldNetworkAgent != mNetworkAgent) &#123;</span><br><span class="line">            agentDisconnect();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// restore old state</span></span><br><span class="line">        mConfig = oldConfig;</span><br><span class="line">        mConnection = oldConnection;</span><br><span class="line">        mNetworkCapabilities.setUids(oldUsers);</span><br><span class="line">        mNetworkAgent = oldNetworkAgent;</span><br><span class="line">        mInterface = oldInterface;</span><br><span class="line">        <span class="keyword">throw</span> e;</span><br><span class="line">    &#125;</span><br><span class="line">    Log.i(TAG, <span class="string">"Established by "</span> + config.user + <span class="string">" on "</span> + mInterface);</span><br><span class="line">    <span class="keyword">return</span> tun;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>establish()</code>æ–¹æ³•é™¤äº†æƒé™æ ¡éªŒä¹‹å¤–ï¼Œä¸»è¦æ˜¯é€šè¿‡<code>jniCreate</code>æ–¹æ³•åˆ›å»ºäº†ä¸€ä¸ªFDå¹¶è¿”å›ï¼Œè¿™ä¸ªFDå…¶å®å°±æ˜¯tunè®¾å¤‡ã€‚è€Œæ­¤å¤„çš„<code>jniCreate</code>æ–¹æ³•æ˜¯nativeæ–¹æ³•ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">native</span> <span class="keyword">int</span> <span class="title">jniCreate</span><span class="params">(<span class="keyword">int</span> mtu)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">native</span> String <span class="title">jniGetName</span><span class="params">(<span class="keyword">int</span> tun)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">native</span> <span class="keyword">int</span> <span class="title">jniSetAddresses</span><span class="params">(String interfaze, String addresses)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">jniReset</span><span class="params">(String interfaze)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">native</span> <span class="keyword">int</span> <span class="title">jniCheck</span><span class="params">(String interfaze)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">native</span> <span class="keyword">boolean</span> <span class="title">jniAddAddress</span><span class="params">(String interfaze, String address, <span class="keyword">int</span> prefixLen)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">native</span> <span class="keyword">boolean</span> <span class="title">jniDelAddress</span><span class="params">(String interfaze, String address, <span class="keyword">int</span> prefixLen)</span></span>;</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°ä¸€ç³»åˆ—çš„nativeæ–¹æ³•ï¼Œè¿™äº›æ–¹æ³•éƒ½ä½äº<code>com_android_server_connectivity_Vpn.cpp</code>ä¸­ï¼š</p>
<h3 id="jniCreate"><a href="#jniCreate" class="headerlink" title="jniCreate()"></a>jniCreate()</h3><p>[-&gt; frameworks/base/services/core/jni/com_android_server_connectivity_Vpn.cpp]</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> JNINativeMethod gMethods[] = &#123;</span><br><span class="line">    &#123;<span class="string">"jniCreate"</span>, <span class="string">"(I)I"</span>, (<span class="keyword">void</span> *)create&#125;,</span><br><span class="line">    &#123;<span class="string">"jniGetName"</span>, <span class="string">"(I)Ljava/lang/String;"</span>, (<span class="keyword">void</span> *)getName&#125;,</span><br><span class="line">    &#123;<span class="string">"jniSetAddresses"</span>, <span class="string">"(Ljava/lang/String;Ljava/lang/String;)I"</span>, (<span class="keyword">void</span> *)setAddresses&#125;,</span><br><span class="line">    &#123;<span class="string">"jniReset"</span>, <span class="string">"(Ljava/lang/String;)V"</span>, (<span class="keyword">void</span> *)reset&#125;,</span><br><span class="line">    &#123;<span class="string">"jniCheck"</span>, <span class="string">"(Ljava/lang/String;)I"</span>, (<span class="keyword">void</span> *)check&#125;,</span><br><span class="line">    &#123;<span class="string">"jniAddAddress"</span>, <span class="string">"(Ljava/lang/String;Ljava/lang/String;I)Z"</span>, (<span class="keyword">void</span> *)addAddress&#125;,</span><br><span class="line">    &#123;<span class="string">"jniDelAddress"</span>, <span class="string">"(Ljava/lang/String;Ljava/lang/String;I)Z"</span>, (<span class="keyword">void</span> *)delAddress&#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ›å»ºtunè®¾å¤‡</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> jint <span class="title">create</span><span class="params">(JNIEnv *env, jobject <span class="comment">/* thiz */</span>, jint mtu)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> tun = create_interface(mtu);</span><br><span class="line">    <span class="keyword">if</span> (tun &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        throwException(env, tun, <span class="string">"Cannot create interface"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> tun;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">create_interface</span><span class="params">(<span class="keyword">int</span> mtu)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> tun = open(<span class="string">"/dev/tun"</span>, O_RDWR | O_NONBLOCK | O_CLOEXEC);</span><br><span class="line"></span><br><span class="line">    ifreq ifr4;</span><br><span class="line">    <span class="built_in">memset</span>(&amp;ifr4, <span class="number">0</span>, <span class="keyword">sizeof</span>(ifr4));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Allocate interface.</span></span><br><span class="line">    ifr4.ifr_flags = IFF_TUN | IFF_NO_PI;</span><br><span class="line">    <span class="keyword">if</span> (ioctl(tun, TUNSETIFF, &amp;ifr4)) &#123;</span><br><span class="line">        ALOGE(<span class="string">"Cannot allocate TUN: %s"</span>, strerror(errno));</span><br><span class="line">        <span class="keyword">goto</span> error;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Activate interface.</span></span><br><span class="line">    ifr4.ifr_flags = IFF_UP;</span><br><span class="line">    <span class="keyword">if</span> (ioctl(inet4, SIOCSIFFLAGS, &amp;ifr4)) &#123;</span><br><span class="line">        ALOGE(<span class="string">"Cannot activate %s: %s"</span>, ifr4.ifr_name, strerror(errno));</span><br><span class="line">        <span class="keyword">goto</span> error;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Set MTU if it is specified.</span></span><br><span class="line">    ifr4.ifr_mtu = mtu;</span><br><span class="line">    <span class="keyword">if</span> (mtu &gt; <span class="number">0</span> &amp;&amp; ioctl(inet4, SIOCSIFMTU, &amp;ifr4)) &#123;</span><br><span class="line">        ALOGE(<span class="string">"Cannot set MTU on %s: %s"</span>, ifr4.ifr_name, strerror(errno));</span><br><span class="line">        <span class="keyword">goto</span> error;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> tun;</span><br><span class="line"></span><br><span class="line">error:</span><br><span class="line">    close(tun);</span><br><span class="line">    <span class="keyword">return</span> SYSTEM_ERROR;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œå°±å¾ˆæ˜æ˜¾èƒ½çœ‹åˆ°æœ€ç»ˆè°ƒç”¨çš„æ˜¯<code>create_interface</code>æ–¹æ³•ï¼Œè¯¥æ–¹æ³•å…¶å®å°±æ˜¯æ‰“å¼€<code>/dev/tun</code>æ–‡ä»¶ï¼Œç„¶åè®¾ç½®ä¸€ä¸‹MTUå¹¶è¿”å›è¿™ä¸ªFDã€‚</p>
<p><code>/dev/tun</code>æ–‡ä»¶å°±æ˜¯Linuxä¸­çš„TUNè®¾å¤‡ã€‚</p>
<h2 id="TUN-TAPæ˜¯ä»€ä¹ˆ"><a href="#TUN-TAPæ˜¯ä»€ä¹ˆ" class="headerlink" title="TUN/TAPæ˜¯ä»€ä¹ˆ"></a>TUN/TAPæ˜¯ä»€ä¹ˆ</h2><p>tap/tun æ˜¯ Linux å†…æ ¸ 2.4.x ç‰ˆæœ¬ä¹‹åå®ç°çš„è™šæ‹Ÿç½‘ç»œè®¾å¤‡ï¼Œä¸åŒäºç‰©ç†ç½‘å¡ï¼Œtap/tun è™šæ‹Ÿç½‘å¡å®Œå…¨ç”±è½¯ä»¶æ¥å®ç°ï¼ŒåŠŸèƒ½å’Œç¡¬ä»¶å®ç°å®Œå…¨æ²¡æœ‰å·®åˆ«ï¼Œå®ƒä»¬éƒ½å±äºç½‘ç»œè®¾å¤‡ï¼Œéƒ½å¯ä»¥é…ç½® IPï¼Œéƒ½å½’ Linux ç½‘ç»œè®¾å¤‡ç®¡ç†æ¨¡å—ç»Ÿä¸€ç®¡ç†ã€‚<br><strong>TAP</strong> è®¾å¤‡ä¸ <strong>TUN</strong> è®¾å¤‡éƒ½æ˜¯è™šæ‹Ÿç½‘ç»œè®¾å¤‡ï¼Œå·¥ä½œæ–¹å¼å®Œå…¨ç›¸åŒï¼Œä½†å®ƒä»¬çš„å·¥ä½œå±‚æ¬¡ä¸å¤ªä¸€æ ·ï¼š</p>
<ul>
<li>tap æ˜¯ä¸€ä¸ªäºŒå±‚è®¾å¤‡ï¼ˆæˆ–è€…ä»¥å¤ªç½‘è®¾å¤‡ï¼‰ï¼Œåªèƒ½å¤„ç†äºŒå±‚çš„ä»¥å¤ªç½‘å¸§ï¼›</li>
<li>tun æ˜¯ä¸€ä¸ªç‚¹å¯¹ç‚¹çš„ä¸‰å±‚è®¾å¤‡ï¼ˆæˆ–ç½‘ç»œå±‚è®¾å¤‡ï¼‰ï¼Œåªèƒ½å¤„ç†ä¸‰å±‚çš„ IP æ•°æ®åŒ…ã€‚</li>
</ul>
<p>ä½œä¸ºç½‘ç»œè®¾å¤‡ï¼Œtap/tun ä¹Ÿéœ€è¦é…å¥—ç›¸åº”çš„é©±åŠ¨ç¨‹åºæ‰èƒ½å·¥ä½œã€‚tap/tun é©±åŠ¨ç¨‹åºåŒ…æ‹¬ä¸¤ä¸ªéƒ¨åˆ†ï¼Œä¸€ä¸ªæ˜¯å­—ç¬¦è®¾å¤‡é©±åŠ¨ï¼Œä¸€ä¸ªæ˜¯ç½‘å¡é©±åŠ¨ã€‚è¿™ä¸¤éƒ¨åˆ†é©±åŠ¨ç¨‹åºåˆ†å·¥ä¸å¤ªä¸€æ ·ï¼Œå­—ç¬¦é©±åŠ¨è´Ÿè´£æ•°æ®åŒ…åœ¨å†…æ ¸ç©ºé—´å’Œç”¨æˆ·ç©ºé—´çš„ä¼ é€ï¼Œç½‘å¡é©±åŠ¨è´Ÿè´£æ•°æ®åŒ…åœ¨ TCP/IP ç½‘ç»œåè®®æ ˆä¸Šçš„ä¼ è¾“å’Œå¤„ç†ã€‚</p>
<h3 id="å­—ç¬¦é©±åŠ¨-å†…æ ¸ç©ºé—´å’Œç”¨æˆ·ç©ºé—´çš„æ•°æ®ä¼ è¾“"><a href="#å­—ç¬¦é©±åŠ¨-å†…æ ¸ç©ºé—´å’Œç”¨æˆ·ç©ºé—´çš„æ•°æ®ä¼ è¾“" class="headerlink" title="å­—ç¬¦é©±åŠ¨ - å†…æ ¸ç©ºé—´å’Œç”¨æˆ·ç©ºé—´çš„æ•°æ®ä¼ è¾“"></a>å­—ç¬¦é©±åŠ¨ - å†…æ ¸ç©ºé—´å’Œç”¨æˆ·ç©ºé—´çš„æ•°æ®ä¼ è¾“</h3><p>åœ¨ Linux ä¸­ï¼Œç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´çš„æ•°æ®ä¼ è¾“æœ‰å¤šç§æ–¹å¼ï¼Œå­—ç¬¦è®¾å¤‡å°±æ˜¯å…¶ä¸­çš„ä¸€ç§ã€‚tap/tun é€šè¿‡é©±åŠ¨ç¨‹åºå’Œä¸€ä¸ªä¸ä¹‹å…³è”çš„å­—ç¬¦è®¾å¤‡ï¼Œæ¥å®ç°ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´çš„é€šä¿¡æ¥å£ã€‚</p>
<p>åœ¨ Linux å†…æ ¸ 2.6.x ä¹‹åçš„ç‰ˆæœ¬ä¸­ï¼Œtap/tun å¯¹åº”çš„å­—ç¬¦è®¾å¤‡æ–‡ä»¶åˆ†åˆ«ä¸ºï¼š</p>
<ul>
<li>tapï¼š/dev/tap0</li>
<li>tunï¼š/dev/tun0</li>
</ul>
<p>è®¾å¤‡æ–‡ä»¶å³å……å½“äº†ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´é€šä¿¡çš„æ¥å£ã€‚å½“åº”ç”¨ç¨‹åºæ‰“å¼€è®¾å¤‡æ–‡ä»¶æ—¶ï¼Œé©±åŠ¨ç¨‹åºå°±ä¼šåˆ›å»ºå¹¶æ³¨å†Œç›¸åº”çš„è™šæ‹Ÿè®¾å¤‡æ¥å£ï¼Œä¸€èˆ¬ä»¥ <code>tunX</code> æˆ– <code>tapX</code> å‘½åã€‚å½“åº”ç”¨ç¨‹åºå…³é—­æ–‡ä»¶æ—¶ï¼Œé©±åŠ¨ä¹Ÿä¼šè‡ªåŠ¨åˆ é™¤ <code>tunX</code> å’Œ <code>tapX</code> è®¾å¤‡ï¼Œè¿˜ä¼šåˆ é™¤å·²ç»å»ºç«‹èµ·æ¥çš„è·¯ç”±ç­‰ä¿¡æ¯ã€‚</p>
<p>tap/tun è®¾å¤‡æ–‡ä»¶å°±åƒä¸€ä¸ªç®¡é“ï¼Œä¸€ç«¯è¿æ¥ç€ç”¨æˆ·ç©ºé—´ï¼Œä¸€ç«¯è¿æ¥ç€å†…æ ¸ç©ºé—´ã€‚å½“ç”¨æˆ·ç¨‹åºå‘æ–‡ä»¶ <code>/dev/net/tun</code> æˆ– <code>/dev/tap0</code> å†™æ•°æ®æ—¶ï¼Œå†…æ ¸å°±å¯ä»¥ä»å¯¹åº”çš„ <code>tunX</code> æˆ– <code>tapX</code> æ¥å£è¯»åˆ°æ•°æ®ï¼Œåä¹‹ï¼Œå†…æ ¸å¯ä»¥é€šè¿‡ç›¸åçš„æ–¹å¼å‘ç”¨æˆ·ç¨‹åºå‘é€æ•°æ®ã€‚</p>
<h3 id="ç½‘å¡é©±åŠ¨-æ•°æ®åŒ…åœ¨-TCP-IP-åè®®æ ˆçš„ä¼ è¾“"><a href="#ç½‘å¡é©±åŠ¨-æ•°æ®åŒ…åœ¨-TCP-IP-åè®®æ ˆçš„ä¼ è¾“" class="headerlink" title="ç½‘å¡é©±åŠ¨ - æ•°æ®åŒ…åœ¨ TCP/IP åè®®æ ˆçš„ä¼ è¾“"></a>ç½‘å¡é©±åŠ¨ - æ•°æ®åŒ…åœ¨ TCP/IP åè®®æ ˆçš„ä¼ è¾“</h3><p>å‚è€ƒ<a href="https://blog.kghost.info/2013/03/27/linux-network-tun/" target="_blank" rel="noopener">ç½‘ç»œè™šæ‹ŸåŒ–æŠ€æœ¯ï¼ˆäºŒï¼‰: TUN/TAP MACVLAN MACVTAP</a>ï¼Œå…ˆæ¥çœ‹çœ‹ç‰©ç†ç½‘å¡æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼š</p>
<p><img src="/gallery/android_common/tunortap-eth0.png" alt="çœŸå®ç½‘å¡çš„å·¥ä½œæœºåˆ¶"></p>
<p>æ™®é€šç½‘å¡é€šè¿‡ç½‘çº¿æ”¶å‘æ•°æ®åŒ…ï¼Œæ‰€æœ‰ç‰©ç†ç½‘å¡æ”¶åˆ°çš„åŒ…ä¼šäº¤ç»™å†…æ ¸çš„ Network Stack å¤„ç†ï¼Œç„¶åé€šè¿‡ Socket API é€šçŸ¥ç»™ç”¨æˆ·ç¨‹åºã€‚</p>
<p>ä½†æ˜¯ TUN è®¾å¤‡é€šè¿‡ä¸€ä¸ª<code>/dev/tunX</code>æ–‡ä»¶æ”¶å‘æ•°æ®åŒ…ã€‚æ‰€æœ‰å¯¹è¯¥æ–‡ä»¶çš„å†™æ“ä½œä¼šé€šè¿‡ TUN è®¾å¤‡è½¬æ¢æˆä¸€ä¸ªæ•°æ®åŒ…é€ç»™å†…æ ¸ï¼›å½“å†…æ ¸å‘é€ä¸€ä¸ªåŒ…ç»™ TUN è®¾å¤‡æ—¶ï¼Œé€šè¿‡è¯»è¿™ä¸ªæ–‡ä»¶å¯ä»¥æ‹¿åˆ°åŒ…çš„å†…å®¹ã€‚</p>
<p>å¦‚æœæˆ‘ä»¬ä½¿ç”¨ TUN è®¾å¤‡æ­å»ºä¸€ä¸ªåŸºäº UDP VPNï¼Œé‚£ä¹ˆæ•´ä¸ªå¤„ç†è¿‡ç¨‹å°±æ˜¯è¿™æ ·ï¼š</p>
<p><img src="/gallery/android_common/tunortap-tun.png" alt="åŸºäº UDP çš„ VPN å·¥ä½œæœºåˆ¶"></p>
<p>æ•°æ®åŒ…ä¼šé€šè¿‡å†…æ ¸ç½‘ç»œæ ˆä¸¤æ¬¡ã€‚ä½†æ˜¯ç»è¿‡ App çš„å¤„ç†åï¼Œæ•°æ®åŒ…å¯èƒ½å·²ç»åŠ å¯†ï¼Œå¹¶ä¸”åŸæœ‰çš„ ip å¤´è¢«å°è£…åœ¨ udp å†…éƒ¨ï¼Œæ‰€ä»¥ç¬¬äºŒæ¬¡é€šè¿‡ç½‘ç»œæ ˆå†…æ ¸çœ‹åˆ°çš„æ·»åŠ äº†æ–°çš„IPå¤´å’ŒUDPå¤´çš„æ•°æ®åŒ…ã€‚</p>
<p><img src="/gallery/android_common/090751088583813.jpg" alt="ç¬¬äºŒæ¬¡è¿›å…¥ç½‘ç»œæ ˆå†…æ ¸åçš„IPæ•°æ®åŒ…å˜åŒ–"></p>
<p>tap/tun é€šè¿‡å®ç°ç›¸åº”çš„ç½‘å¡é©±åŠ¨ç¨‹åºæ¥å’Œç½‘ç»œåè®®æ ˆé€šä¿¡ã€‚ä¸€èˆ¬çš„æµç¨‹å’Œç‰©ç†ç½‘å¡å’Œåè®®æ ˆçš„äº¤äº’æµç¨‹æ˜¯ä¸€æ ·çš„ï¼Œä¸åŒçš„æ˜¯ç‰©ç†ç½‘å¡ä¸€ç«¯æ˜¯è¿æ¥ç‰©ç†ç½‘ç»œï¼Œè€Œ tap/tun è™šæ‹Ÿç½‘å¡ä¸€èˆ¬è¿æ¥åˆ°ç”¨æˆ·ç©ºé—´ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">+----------------------------------------------------------------+</span><br><span class="line">|                                                                |</span><br><span class="line">|  +--------------------+      +--------------------+            |</span><br><span class="line">|  | User Application A |      | User Application B |&lt;-----+     |</span><br><span class="line">|  +--------------------+      +--------------------+      |     |</span><br><span class="line">|               | <span class="number">1</span>                    | <span class="number">5</span>                 |     |</span><br><span class="line">|...............|......................|...................|.....|</span><br><span class="line">|               â†“                      â†“                   |     |</span><br><span class="line">|         +----------+           +----------+              |     |</span><br><span class="line">|         | socket A |           | socket B |              |     |</span><br><span class="line">|         +----------+           +----------+              |     |</span><br><span class="line">|                 | <span class="number">2</span>               | <span class="number">6</span>                    |     |</span><br><span class="line">|.................|.................|......................|.....|</span><br><span class="line">|                 â†“                 â†“                      |     |</span><br><span class="line">|             +------------------------+                 <span class="number">4</span> |     |</span><br><span class="line">|             | Newwork Protocol Stack |                   |     |</span><br><span class="line">|             +------------------------+                   |     |</span><br><span class="line">|                | <span class="number">7</span>                 | <span class="number">3</span>                   |     |</span><br><span class="line">|................|...................|.....................|.....|</span><br><span class="line">|                â†“                   â†“                     |     |</span><br><span class="line">|        +----------------+    +----------------+          |     |</span><br><span class="line">|        |      eth0      |    |      tun0      |          |     |</span><br><span class="line">|        +----------------+    +----------------+          |     |</span><br><span class="line">|    <span class="number">10.32</span>.0.11  |                   |   <span class="number">192.168</span>.3.11      |     |</span><br><span class="line">|                | <span class="number">8</span>                 +---------------------+     |</span><br><span class="line">|                |                                               |</span><br><span class="line">+----------------|-----------------------------------------------+</span><br><span class="line">                 â†“</span><br><span class="line">         Physical Network</span><br></pre></td></tr></table></figure>
<p>ä¸Šå›¾ä¸­æœ‰ä¸¤ä¸ªåº”ç”¨ç¨‹åºAå’ŒBï¼Œéƒ½åœ¨ç”¨æˆ·å±‚ï¼Œè€Œå…¶å®ƒçš„socketã€åè®®æ ˆï¼ˆNewwork Protocol Stackï¼‰å’Œç½‘ç»œè®¾å¤‡ï¼ˆeth0å’Œtun0ï¼‰éƒ¨åˆ†éƒ½åœ¨å†…æ ¸å±‚ï¼Œå…¶å®socketæ˜¯åè®®æ ˆçš„ä¸€éƒ¨åˆ†ï¼Œè¿™é‡Œåˆ†å¼€æ¥çš„ç›®çš„æ˜¯ä¸ºäº†çœ‹çš„æ›´ç›´è§‚ã€‚</p>
<a id="more"></a>
<p>tun0æ˜¯ä¸€ä¸ªTun/Tapè™šæ‹Ÿè®¾å¤‡ï¼Œä»ä¸Šå›¾ä¸­å¯ä»¥çœ‹å‡ºå®ƒå’Œç‰©ç†è®¾å¤‡eth0çš„å·®åˆ«ï¼Œå®ƒä»¬çš„ä¸€ç«¯è™½ç„¶éƒ½è¿ç€åè®®æ ˆï¼Œä½†å¦ä¸€ç«¯ä¸ä¸€æ ·ï¼Œeth0çš„å¦ä¸€ç«¯æ˜¯ç‰©ç†ç½‘ç»œï¼Œè¿™ä¸ªç‰©ç†ç½‘ç»œå¯èƒ½å°±æ˜¯ä¸€ä¸ªäº¤æ¢æœºï¼Œè€Œtun0çš„å¦ä¸€ç«¯æ˜¯ä¸€ä¸ªç”¨æˆ·å±‚çš„ç¨‹åºï¼Œåè®®æ ˆå‘ç»™tun0çš„æ•°æ®åŒ…èƒ½è¢«è¿™ä¸ªåº”ç”¨ç¨‹åºè¯»å–åˆ°ï¼Œå¹¶ä¸”åº”ç”¨ç¨‹åºèƒ½ç›´æ¥å‘tun0å†™æ•°æ®ã€‚</p>
<p>è¿™é‡Œå‡è®¾eth0é…ç½®çš„IPæ˜¯10.32.0.11ï¼Œè€Œtun0é…ç½®çš„IPæ˜¯192.168.3.11.</p>
<blockquote>
<p>è¿™é‡Œåˆ—ä¸¾çš„æ˜¯ä¸€ä¸ªå…¸å‹çš„tun/tapè®¾å¤‡çš„åº”ç”¨åœºæ™¯ï¼Œå‘åˆ°192.168.3.0/24ç½‘ç»œçš„æ•°æ®é€šè¿‡ç¨‹åºBè¿™ä¸ªéš§é“ï¼Œåˆ©ç”¨10.32.0.11å‘åˆ°è¿œç«¯ç½‘ç»œçš„10.33.0.1ï¼Œå†ç”±10.33.0.1è½¬å‘ç»™ç›¸åº”çš„è®¾å¤‡ï¼Œä»è€Œå®ç°VPNã€‚</p>
</blockquote>
<p>ä¸‹é¢æ¥çœ‹çœ‹æ•°æ®åŒ…çš„æµç¨‹ï¼š</p>
<ol>
<li>åº”ç”¨ç¨‹åºAæ˜¯ä¸€ä¸ªæ™®é€šçš„ç¨‹åºï¼Œé€šè¿‡socket Aå‘é€äº†ä¸€ä¸ªæ•°æ®åŒ…ï¼Œå‡è®¾è¿™ä¸ªæ•°æ®åŒ…çš„ç›®çš„IPåœ°å€æ˜¯192.168.3.1</li>
<li>socketå°†è¿™ä¸ªæ•°æ®åŒ…ä¸¢ç»™åè®®æ ˆ</li>
<li>åè®®æ ˆæ ¹æ®æ•°æ®åŒ…çš„ç›®çš„IPåœ°å€ï¼ŒåŒ¹é…æœ¬åœ°è·¯ç”±è§„åˆ™ï¼ŒçŸ¥é“è¿™ä¸ªæ•°æ®åŒ…åº”è¯¥ç”±tun0å‡ºå»ï¼Œäºæ˜¯å°†æ•°æ®åŒ…äº¤ç»™tun0</li>
<li>tun0æ”¶åˆ°æ•°æ®åŒ…ä¹‹åï¼Œå‘ç°å¦ä¸€ç«¯è¢«è¿›ç¨‹Bæ‰“å¼€äº†ï¼Œäºæ˜¯å°†æ•°æ®åŒ…ä¸¢ç»™äº†è¿›ç¨‹B</li>
<li>è¿›ç¨‹Bæ”¶åˆ°æ•°æ®åŒ…ä¹‹åï¼Œåšä¸€äº›è·Ÿä¸šåŠ¡ç›¸å…³çš„å¤„ç†ï¼Œç„¶åæ„é€ ä¸€ä¸ªæ–°çš„æ•°æ®åŒ…ï¼Œå°†åŸæ¥çš„æ•°æ®åŒ…åµŒå…¥åœ¨æ–°çš„æ•°æ®åŒ…ä¸­ï¼Œæœ€åé€šè¿‡socket Bå°†æ•°æ®åŒ…è½¬å‘å‡ºå»ï¼Œè¿™æ—¶å€™æ–°æ•°æ®åŒ…çš„æºåœ°å€å˜æˆäº†eth0çš„åœ°å€ï¼Œè€Œç›®çš„IPåœ°å€å˜æˆäº†ä¸€ä¸ªå…¶å®ƒçš„åœ°å€ï¼Œæ¯”å¦‚æ˜¯10.33.0.1.</li>
<li>socket Bå°†æ•°æ®åŒ…ä¸¢ç»™åè®®æ ˆ</li>
<li>åè®®æ ˆæ ¹æ®æœ¬åœ°è·¯ç”±ï¼Œå‘ç°è¿™ä¸ªæ•°æ®åŒ…åº”è¯¥è¦é€šè¿‡eth0å‘é€å‡ºå»ï¼Œäºæ˜¯å°†æ•°æ®åŒ…äº¤ç»™eth0</li>
<li>eth0é€šè¿‡ç‰©ç†ç½‘ç»œå°†æ•°æ®åŒ…å‘é€å‡ºå»</li>
</ol>
<p>10.33.0.1æ”¶åˆ°æ•°æ®åŒ…ä¹‹åï¼Œä¼šæ‰“å¼€æ•°æ®åŒ…ï¼Œè¯»å–é‡Œé¢çš„åŸå§‹æ•°æ®åŒ…ï¼Œå¹¶è½¬å‘ç»™æœ¬åœ°çš„192.168.3.1ï¼Œç„¶åç­‰æ”¶åˆ°192.168.3.1çš„åº”ç­”åï¼Œå†æ„é€ æ–°çš„åº”ç­”åŒ…ï¼Œå¹¶å°†åŸå§‹åº”ç­”åŒ…å°è£…åœ¨é‡Œé¢ï¼Œå†ç”±åŸè·¯å¾„è¿”å›ç»™åº”ç”¨ç¨‹åºBï¼Œåº”ç”¨ç¨‹åºBå–å‡ºé‡Œé¢çš„åŸå§‹åº”ç­”åŒ…ï¼Œæœ€åè¿”å›ç»™åº”ç”¨ç¨‹åºA</p>
<blockquote>
<p>è¿™é‡Œä¸è®¨è®ºTun/Tapè®¾å¤‡tun0æ˜¯æ€ä¹ˆå’Œç”¨æˆ·å±‚çš„è¿›ç¨‹Bè¿›è¡Œé€šä¿¡çš„ï¼Œå¯¹äºLinuxå†…æ ¸æ¥è¯´ï¼Œæœ‰å¾ˆå¤šç§åŠæ³•æ¥è®©å†…æ ¸ç©ºé—´å’Œç”¨æˆ·ç©ºé—´çš„è¿›ç¨‹äº¤æ¢æ•°æ®ã€‚</p>
</blockquote>
<p>ä»ä¸Šé¢çš„æµç¨‹ä¸­å¯ä»¥çœ‹å‡ºï¼Œæ•°æ®åŒ…é€‰æ‹©èµ°å“ªä¸ªç½‘ç»œè®¾å¤‡å®Œå…¨ç”±è·¯ç”±è¡¨æ§åˆ¶ï¼Œæ‰€ä»¥å¦‚æœæˆ‘ä»¬æƒ³è®©æŸäº›ç½‘ç»œæµé‡èµ°åº”ç”¨ç¨‹åºBçš„è½¬å‘æµç¨‹ï¼Œå°±éœ€è¦é…ç½®è·¯ç”±è¡¨è®©è¿™éƒ¨åˆ†æ•°æ®èµ°tun0ã€‚</p>
<h2 id="å‘"><a href="#å‘" class="headerlink" title="å‘"></a>å‘</h2><p>æ ¹æ®<a href="https://nicelee.top/blog/2019/02/14/java-android-vpnservice/" target="_blank" rel="noopener">Android VpnServiceåˆæ¢</a></p>
<ul>
<li>ä»€ä¹ˆIPåŒ…ä¼šå¾€è™šæ‹Ÿç½‘å¡å‘ï¼Ÿæˆ–è€…è¯´ï¼Œè™šæ‹Ÿç½‘å¡å‡ºå…¥çš„IPæŠ¥æ–‡æ€ä¹ˆæ‰ç®—æœ‰æ•ˆçš„ï¼Ÿ<ul>
<li>åªæœ‰æœ¬åœ°åˆ°å¤–åœ°ï¼Œæˆ–è€…å¤–åœ°åˆ°æœ¬åœ°çš„æŠ¥æ–‡ï¼Œæ‰ä¼šé€”å¾„è™šæ‹Ÿç½‘å¡ã€‚</li>
<li>æ¯”å¦‚è¯´ï¼Œ æœ¬åœ°6666ç«¯å£ï¼Œå¾€æœ¬åœ°9999ç«¯å£å‘é€äº†ä¸€ä¸ªUDPåŒ…ï¼Œå…¶å¯¹åº”çš„IPæŠ¥æ–‡ä¸ä¼šç»è¿‡è™šæ‹Ÿç½‘å¡ï¼Œä¸è¦æŒ‡æœ›è¯»<strong>ParcelFileDescriptor</strong>å®ä¾‹èƒ½å¤Ÿå¾—åˆ°è¿™ä»½IPæŠ¥æ–‡ã€‚</li>
<li>æ¯”å¦‚è¯´ï¼Œ æœ¬åœ°6666ç«¯å£ï¼Œå¾€å¤–åœ°<code>8.8.8.8:53</code>å‘é€äº†ä¸€ä¸ªUDPåŒ…ã€‚è™šæ‹Ÿç½‘å¡æ”¶åˆ°åï¼Œå°†å…¶ç›®çš„åœ°æ”¹ä¸ºæŒ‡å‘æœ¬åœ°<strong>UDPServer</strong>ï¼Œ<code>6.6.6.6:6666</code>ï¼Œé‡æ–°å†™å…¥è™šæ‹Ÿç½‘å¡ã€‚<br>ä½†è¿™æ—¶æœ¬åœ°<strong>UDPServer</strong>å¹¶ä¸ä¼šæ”¶åˆ°è¿™ä¸ªæŠ¥æ–‡ï¼Œåªæœ‰å°†è¿™ä¸ªIPæŠ¥æ–‡çš„æºåœ°å€æ›´æ”¹ä¸€ä¸‹ï¼Œä¾‹å¦‚ç”±æœ¬åœ°ipæ”¹ä¸º<strong>8.8.8.8</strong>(åŸç›®çš„åœ°å€)ï¼Œè¿™ä¸ªæŠ¥æ–‡æ‰ä¼šè¢«æœ¬åœ°<strong>UDPServer</strong>æ”¶åˆ°ã€‚</li>
</ul>
</li>
<li>å…³äºDNSæŠ¥æ–‡<ul>
<li>ä¼¼ä¹å¦‚æœä¸åœ¨Builderç”Ÿæˆæ—¶æŒ‡å®šDNSæœåŠ¡å™¨ï¼Œæ‰‹æœºæœ¬èº«å¦æœ‰ä¸€å¥—æœºåˆ¶ï¼Œä½¿å¾—ç³»ç»Ÿé»˜è®¤çš„DNSæŸ¥è¯¢ä¸ä¼šç»è¿‡è™šæ‹Ÿç½‘å¡ã€‚å¦‚æœæœ‰éœ€è¦ï¼Œä¸å¦¨å†åŠ ä¸€æ¡ï¼š<br><code>builder.addDnsServer(&quot;114.114.114.114&quot;)</code></li>
</ul>
</li>
</ul>
<p>è¿™ä¸ªè®¨è®ºä¹Ÿå¾ˆæœ‰ä¿¡æ¯é‡ï¼š<a href="https://www.v2ex.com/t/589264" target="_blank" rel="noopener">VpnService èƒ½å¦åŸæ ·å°†ä¸‰å±‚çš„ IP æŠ¥æ–‡å‘å‡ºå»ï¼Ÿ</a></p>
<h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><ul>
<li><a href="http://arloor.com/posts/other/android-vpnservice-and-vpn-dev/" target="_blank" rel="noopener">å®‰å“Vpnå¼€å‘æ€è·¯</a></li>
<li><a href="https://blog.csdn.net/jsqfengbao/article/details/52462125" target="_blank" rel="noopener">ä½¿ç”¨Androidç³»ç»Ÿè‡ªå¸¦çš„VpnServiceæˆªå–æµé‡</a></li>
<li><a href="https://segmentfault.com/a/1190000009249039" target="_blank" rel="noopener">Linuxè™šæ‹Ÿç½‘ç»œè®¾å¤‡ä¹‹tun/tap</a></li>
<li><a href="https://www.thegeekstuff.com/2014/06/android-vpn-service/?utm_source=tuicool&amp;utm_medium=referral" target="_blank" rel="noopener">Android VPN Service Explained with Packet Bypass Example Program</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      
        <div id="donation_div"></div>

<script src="../../../../js/vdonate.js"></script>
<script>
var a = new Donate({
  title: 'å¦‚æœè§‰å¾—æˆ‘çš„æ–‡ç« å¯¹æ‚¨æœ‰ç”¨ï¼Œè¯·éšæ„æ‰“èµã€‚æ‚¨çš„æ”¯æŒå°†é¼“åŠ±æˆ‘ç»§ç»­åˆ›ä½œ!', // å¯é€‰å‚æ•°ï¼Œæ‰“èµæ ‡é¢˜
  btnText: 'æ‰“èµæ”¯æŒ', // å¯é€‰å‚æ•°ï¼Œæ‰“èµæŒ‰é’®æ–‡å­—
  el: document.getElementById('donation_div'),
  wechatImage: 'https://raw.githubusercontent.com/iTimeTraveler/iTimeTraveler.github.io/site/source/about/donate/images/WeChanQR.png',
  alipayImage: 'https://raw.githubusercontent.com/iTimeTraveler/iTimeTraveler.github.io/site/source/about/donate/images/AliPayQR.jpg'
});
</script>
      
      
      <div>
        <ul class="post-copyright">
          <li class="post-copyright-author">
          <strong>æœ¬æ–‡ä½œè€…:  </strong>Mr.Seven</a>
          </li>
          <li class="post-copyright-link">
          <strong>æœ¬æ–‡é“¾æ¥:  </strong>
          <a href="/2019/07/25/ã€Androidã€‘ä½¿ç”¨VPNå®ç°æŠ“åŒ…/" target="_blank" title="ã€Androidã€‘ ä½¿ç”¨VPNå®ç°æŠ“åŒ…">https://itimetraveler.github.io/2019/07/25/ã€Androidã€‘ä½¿ç”¨VPNå®ç°æŠ“åŒ…/</a>
          </li>
          <li class="post-copyright-license">
            <strong>ç‰ˆæƒå£°æ˜:   </strong>
            æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a rel="license" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank" title="Attribution-NonCommercial-NoDerivatives 4.0 International (CC BY-NC-ND 4.0)">CC BY-NC-ND 4.0</a>
            è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜å‡ºå¤„
          </li>
         
        </ul>
<div>

      
      
        
	<div id="comment">
		<!-- æ¥å¿…åŠ›Cityç‰ˆå®‰è£…ä»£ç  -->
		<div id="lv-container" data-id="city" data-uid="MTAyMC8yOTQ4MS82MDQ5">
		<script type="text/javascript">
		   (function(d, s) {
		       var j, e = d.getElementsByTagName(s)[0];

		       if (typeof LivereTower === 'function') { return; }

		       j = d.createElement(s);
		       j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
		       j.async = true;

		       e.parentNode.insertBefore(j, e);
		   })(document, 'script');
		</script>
		<noscript>ä¸ºæ­£å¸¸ä½¿ç”¨æ¥å¿…åŠ›è¯„è®ºåŠŸèƒ½è¯·æ¿€æ´»JavaScript</noscript>
		</div>
		<!-- Cityç‰ˆå®‰è£…ä»£ç å·²å®Œæˆ -->
	</div>



      
      
        
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="../../../../tags/Android/">Android</a></li></ul>

      

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="../ç§»åŠ¨ç«¯æ¥å…¥Cronetç½‘ç»œåº“å®è·µ/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">ä¸Šä¸€ç¯‡</strong>
      <div class="article-nav-title">
        
          ç§»åŠ¨ç«¯(Androidã€iOS)æ¥å…¥Cronetå®è·µ
        
      </div>
    </a>
  
  
    <a href="../../../06/07/Android ADBåŸç†æ¢ç©¶/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">ä¸‹ä¸€ç¯‡</strong>
      <div class="article-nav-title">ã€Androidã€‘ADBå·¥å…·åŸç†æ¢ç©¶</div>
    </a>
  
</nav>

  
</article>

<!-- Table of Contents -->

  <aside id="toc-sidebar">
    <div id="toc" class="toc-article">
    <strong class="toc-title">æ–‡ç« ç›®å½•</strong>
    
        <ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#VPNæŠ“åŒ…"><span class="nav-number">1.</span> <span class="nav-text">VPNæŠ“åŒ…</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#VpnService"><span class="nav-number">2.</span> <span class="nav-text">VpnService</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#æºç åˆ†æ"><span class="nav-number">3.</span> <span class="nav-text">æºç åˆ†æ</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#VpnService-establish"><span class="nav-number">3.1.</span> <span class="nav-text">VpnService#establish()</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ConnectivityService-establishVpn"><span class="nav-number">3.2.</span> <span class="nav-text">ConnectivityService#establishVpn()</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Vpn-establish"><span class="nav-number">3.3.</span> <span class="nav-text">Vpn#establish()</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#jniCreate"><span class="nav-number">3.4.</span> <span class="nav-text">jniCreate()</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#TUN-TAPæ˜¯ä»€ä¹ˆ"><span class="nav-number">4.</span> <span class="nav-text">TUN/TAPæ˜¯ä»€ä¹ˆ</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#å­—ç¬¦é©±åŠ¨-å†…æ ¸ç©ºé—´å’Œç”¨æˆ·ç©ºé—´çš„æ•°æ®ä¼ è¾“"><span class="nav-number">4.1.</span> <span class="nav-text">å­—ç¬¦é©±åŠ¨ - å†…æ ¸ç©ºé—´å’Œç”¨æˆ·ç©ºé—´çš„æ•°æ®ä¼ è¾“</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ç½‘å¡é©±åŠ¨-æ•°æ®åŒ…åœ¨-TCP-IP-åè®®æ ˆçš„ä¼ è¾“"><span class="nav-number">4.2.</span> <span class="nav-text">ç½‘å¡é©±åŠ¨ - æ•°æ®åŒ…åœ¨ TCP/IP åè®®æ ˆçš„ä¼ è¾“</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#å‘"><span class="nav-number">5.</span> <span class="nav-text">å‘</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#å‚è€ƒèµ„æ–™"><span class="nav-number">6.</span> <span class="nav-text">å‚è€ƒèµ„æ–™</span></a></li></ol>
    
    </div>
  </aside>

</section>
        
      </div>
      
      <footer id="footer">
  

  <div class="container">
      	<div class="row">
	      <p> Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/iTimeTraveler/hexo-theme-hiker" target="_blank">Hexo-theme-hiker</a> </p>
	      <p id="copyRightEn">Copyright &copy; 2013 - 2019 iTimeTraveler All Rights Reserved.</p>
	      
	      
    		<p class="busuanzi_uv">
				è®¿å®¢æ•° : <span id="busuanzi_value_site_uv"></span> |  
				è®¿é—®é‡ : <span id="busuanzi_value_site_pv"></span>
		    </p>
  		   
		</div>

		
  </div>
</footer>


<!-- min height -->

<script>
    var wrapdiv = document.getElementById("wrap");
    var contentdiv = document.getElementById("content");
    var allheader = document.getElementById("allheader");

    wrapdiv.style.minHeight = document.body.offsetHeight + "px";
    if (allheader != null) {
      contentdiv.style.minHeight = document.body.offsetHeight - allheader.offsetHeight - document.getElementById("footer").offsetHeight + "px";
    } else {
      contentdiv.style.minHeight = document.body.offsetHeight - document.getElementById("footer").offsetHeight + "px";
    }
</script>
    </div>
    <!-- <nav id="mobile-nav">
  
    <a href="../../../../index.html" class="mobile-nav-link">Home</a>
  
    <a href="../../../../archives" class="mobile-nav-link">Archives</a>
  
    <a href="../../../../categories" class="mobile-nav-link">Categories</a>
  
    <a href="../../../../tags" class="mobile-nav-link">Tags</a>
  
    <a href="../../../../funnysite" class="mobile-nav-link">é…·ç«™</a>
  
    <a href="../../../../collection" class="mobile-nav-link">æ”¶è—</a>
  
    <a href="../../../../about" class="mobile-nav-link">About</a>
  
    <a href="../../../../mybooks" class="mobile-nav-link">ğŸ</a>
  
</nav> -->
    

<!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  <link rel="stylesheet" href="../../../../fancybox/jquery.fancybox.css">
  <script src="../../../../fancybox/jquery.fancybox.pack.js"></script>


<script src="../../../../js/scripts.js"></script>




  <script src="../../../../js/dialog.js"></script>








	<div style="display: none;">
    <script src="https://s95.cnzz.com/z_stat.php?id=1260716016&web_id=1260716016" language="JavaScript"></script>
  </div>



	<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js">
	</script>






  </div>

  <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" style="display: none;">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title" id="myModalLabel">è®¾ç½®</h2>
      </div>
      <hr style="margin-top:0px; margin-bottom:0px; width:80%; border-top: 3px solid #000;">
      <hr style="margin-top:2px; margin-bottom:0px; width:80%; border-top: 1px solid #000;">


      <div class="modal-body">
          <div style="margin:6px;">
            <a data-toggle="collapse" data-parent="#accordion" href="#collapseOne" onclick="javascript:setFontSize();" aria-expanded="true" aria-controls="collapseOne">
              æ­£æ–‡å­—å·å¤§å°
            </a>
          </div>
          <div id="collapseOne" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingOne">
          <div class="panel-body">
            æ‚¨å·²è°ƒæ•´é¡µé¢å­—ä½“å¤§å°
          </div>
        </div>
      


          <div style="margin:6px;">
            <a data-toggle="collapse" data-parent="#accordion" href="#collapseTwo" onclick="javascript:setBackground();" aria-expanded="true" aria-controls="collapseTwo">
              å¤œé—´æŠ¤çœ¼æ¨¡å¼
            </a>
        </div>
          <div id="collapseTwo" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingTwo">
          <div class="panel-body">
            å¤œé—´æ¨¡å¼å·²ç»å¼€å¯ï¼Œå†æ¬¡å•å‡»æŒ‰é’®å³å¯å…³é—­ 
          </div>
        </div>

        <div>
            <a data-toggle="collapse" data-parent="#accordion" href="#collapseThree" aria-expanded="true" aria-controls="collapseThree">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å…³ äº&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</a>
        </div>
         <div id="collapseThree" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingThree">
          <div class="panel-body">
            iTimeTraveler
          </div>
          <div class="panel-body">
            Copyright Â© 2019 Mr.Seven All Rights Reserved.
          </div>
        </div>
      </div>


      <hr style="margin-top:0px; margin-bottom:0px; width:80%; border-top: 1px solid #000;">
      <hr style="margin-top:2px; margin-bottom:0px; width:80%; border-top: 3px solid #000;">
      <div class="modal-footer">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">Ã—</span></button>
      </div>
    </div>
  </div>
</div>
  
  <a id="rocket" href="#top" class=""></a>
  <script type="text/javascript" src="/js/totop.js?v=1.0.0" async=""></script>
  
    <a id="menu-switch"><i class="fa fa-bars fa-lg"></i></a>
  
</body>
</html>