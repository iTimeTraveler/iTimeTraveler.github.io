<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>ã€androidã€‘okhttpæºç åˆ†æ | iTimeTraveler</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
    <meta name="keywords" content="OkHttp" />
  
  
  
  
  <meta name="description" content="Androidä¸ºæˆ‘ä»¬æä¾›äº†ä¸¤ç§HTTPäº¤äº’çš„æ–¹å¼ï¼šHttpURLConnection å’Œ Apache HttpClientï¼Œè™½ç„¶ä¸¤è€…éƒ½æ”¯æŒHTTPSï¼Œæµçš„ä¸Šä¼ å’Œä¸‹è½½ï¼Œé…ç½®è¶…æ—¶ï¼ŒIPv6å’Œè¿æ¥æ± ï¼Œå·²è¶³å¤Ÿæ»¡è¶³æˆ‘ä»¬å„ç§HTTPè¯·æ±‚çš„éœ€æ±‚ã€‚ä½†æ›´é«˜æ•ˆçš„ä½¿ç”¨HTTP å¯ä»¥è®©æ‚¨çš„åº”ç”¨è¿è¡Œæ›´å¿«ã€æ›´èŠ‚çœæµé‡ã€‚è€ŒOkHttpåº“å°±æ˜¯ä¸ºæ­¤è€Œç”Ÿã€‚åœ¨å¼€å§‹åˆ†æOkHttpä¹‹å‰æˆ‘ä»¬å…ˆäº†è§£ä¸€ä¸‹ HttpURLConnection">
<meta name="keywords" content="OkHttp">
<meta property="og:type" content="article">
<meta property="og:title" content="ã€Androidã€‘OkHttpæºç åˆ†æ">
<meta property="og:url" content="http://github.com/2018/01/25/ã€Androidã€‘OkHttpæºç åˆ†æ/index.html">
<meta property="og:site_name" content="iTimeTraveler">
<meta property="og:description" content="Androidä¸ºæˆ‘ä»¬æä¾›äº†ä¸¤ç§HTTPäº¤äº’çš„æ–¹å¼ï¼šHttpURLConnection å’Œ Apache HttpClientï¼Œè™½ç„¶ä¸¤è€…éƒ½æ”¯æŒHTTPSï¼Œæµçš„ä¸Šä¼ å’Œä¸‹è½½ï¼Œé…ç½®è¶…æ—¶ï¼ŒIPv6å’Œè¿æ¥æ± ï¼Œå·²è¶³å¤Ÿæ»¡è¶³æˆ‘ä»¬å„ç§HTTPè¯·æ±‚çš„éœ€æ±‚ã€‚ä½†æ›´é«˜æ•ˆçš„ä½¿ç”¨HTTP å¯ä»¥è®©æ‚¨çš„åº”ç”¨è¿è¡Œæ›´å¿«ã€æ›´èŠ‚çœæµé‡ã€‚è€ŒOkHttpåº“å°±æ˜¯ä¸ºæ­¤è€Œç”Ÿã€‚åœ¨å¼€å§‹åˆ†æOkHttpä¹‹å‰æˆ‘ä»¬å…ˆäº†è§£ä¸€ä¸‹ HttpURLConnection">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://raw.githubusercontent.com/iTimeTraveler/iTimeTraveler.github.io/master/gallery/android_common/okhttp_interceptors.png">
<meta property="og:updated_time" content="2018-03-14T08:13:59.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="ã€Androidã€‘OkHttpæºç åˆ†æ">
<meta name="twitter:description" content="Androidä¸ºæˆ‘ä»¬æä¾›äº†ä¸¤ç§HTTPäº¤äº’çš„æ–¹å¼ï¼šHttpURLConnection å’Œ Apache HttpClientï¼Œè™½ç„¶ä¸¤è€…éƒ½æ”¯æŒHTTPSï¼Œæµçš„ä¸Šä¼ å’Œä¸‹è½½ï¼Œé…ç½®è¶…æ—¶ï¼ŒIPv6å’Œè¿æ¥æ± ï¼Œå·²è¶³å¤Ÿæ»¡è¶³æˆ‘ä»¬å„ç§HTTPè¯·æ±‚çš„éœ€æ±‚ã€‚ä½†æ›´é«˜æ•ˆçš„ä½¿ç”¨HTTP å¯ä»¥è®©æ‚¨çš„åº”ç”¨è¿è¡Œæ›´å¿«ã€æ›´èŠ‚çœæµé‡ã€‚è€ŒOkHttpåº“å°±æ˜¯ä¸ºæ­¤è€Œç”Ÿã€‚åœ¨å¼€å§‹åˆ†æOkHttpä¹‹å‰æˆ‘ä»¬å…ˆäº†è§£ä¸€ä¸‹ HttpURLConnection">
<meta name="twitter:image" content="https://raw.githubusercontent.com/iTimeTraveler/iTimeTraveler.github.io/master/gallery/android_common/okhttp_interceptors.png">
  
    <link rel="alternate" href="/atom.xml" title="iTimeTraveler" type="application/atom+xml">
  

  

  <link rel="icon" href="/gallery/avatar/0.jpg">
  <link rel="apple-touch-icon" href="/gallery/avatar/0.jpg">
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link href="https://fonts.googleapis.com/css?family=Open+Sans|Montserrat:700" rel="stylesheet" type="text/css">
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,300,300italic,400italic" rel="stylesheet" type="text/css">
  <link href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">
  <style type="text/css">
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/9749f0/00000000000000000001008f/27/l?subset_id=2&fvd=n5) format("woff2");font-weight:500;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/90cf9f/000000000000000000010091/27/l?subset_id=2&fvd=n7) format("woff2");font-weight:500;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/8a5494/000000000000000000013365/27/l?subset_id=2&fvd=n4) format("woff2");font-weight:lighter;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/d337d8/000000000000000000010095/27/l?subset_id=2&fvd=i4) format("woff2");font-weight:400;font-style:italic;}</style>
  <link rel="stylesheet" href="../../../../css/style.css">

  <script src="../../../../js/jquery-3.1.1.min.js"></script>
  <script src="../../../../js/bootstrap.js"></script>

  <!-- Bootstrap core CSS -->
  <link rel="stylesheet" href="/css/bootstrap.css" >

  
    <link rel="stylesheet" href="../../../../css/dialog.css">
  

  

  
    <link rel="stylesheet" href="/css/header-post.css" >
  

  
  
  
    <link rel="stylesheet" href="/css/vdonate.css" >
  

</head>



  <body data-spy="scroll" data-target="#toc" data-offset="50">


  
  <div id="container">
    <div id="wrap">
      
        <header>

    <div id="allheader" class="navbar navbar-default navbar-static-top" role="navigation">
        <div class="navbar-inner">
          
          <div class="container"> 
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
              <span class="sr-only">Toggle navigation</span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>

            
              <a class="brand" style="
                 border-width: 0px;  margin-top: 8px;"  
                href="#" data-toggle="modal" data-target="#myModal" >
                  <img width="62px" height="75px" alt="Hike News" src="/gallery/avatar/0.jpg">
              </a>
            
            
            <div class="navbar-collapse collapse">
              <ul class="hnav navbar-nav">
                
                  <li> <a class="main-nav-link" href="../../../../index.html">é¦–é¡µ</a> </li>
                
                  <li> <a class="main-nav-link" href="../../../../archives">å½’æ¡£</a> </li>
                
                  <li> <a class="main-nav-link" href="../../../../categories">åˆ†ç±»</a> </li>
                
                  <li> <a class="main-nav-link" href="../../../../tags">æ ‡ç­¾</a> </li>
                
                  <li> <a class="main-nav-link" href="../../../../funnysite">é…·ç«™</a> </li>
                
                  <li> <a class="main-nav-link" href="../../../../collection">æ”¶è—</a> </li>
                
                  <li> <a class="main-nav-link" href="../../../../about">å…³äº</a> </li>
                
                  <li> <a class="main-nav-link" href="../../../../mybooks">ğŸ</a> </li>
                
                  <li><div id="search-form-wrap">

    <form class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="" />
        <button type="submit" class="search-form-submit"></button>
    </form>
    <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" placeholder="è¯·è¾“å…¥å…³é”®è¯..." />
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: 'æ–‡ç« ',
            PAGES: 'é¡µé¢',
            CATEGORIES: 'åˆ†ç±»',
            TAGS: 'æ ‡ç­¾',
            UNTITLED: '(æ— æ ‡é¢˜)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '../../../../content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>
<script src="../../../../js/insight.js"></script>

</div></li>
            </div>
          </div>
                
      </div>
    </div>

</header>



      
            
      <div id="content" class="outer">
        
          <section id="main" style="float:none;"><article id="post-ã€Androidã€‘OkHttpæºç åˆ†æ" style="width: 75%; float:left;" class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="article-inner">
    
<div class="article-gallery">
  <div class="article-gallery-photos">
    
      <a class="article-gallery-img fancybox" href="https://raw.githubusercontent.com/iTimeTraveler/iTimeTraveler.github.io/master/gallery/android_common/okhttp_interceptors.png" rel="gallery_cjjo152b9004g3ys65bziwc03">
        <img src="https://raw.githubusercontent.com/iTimeTraveler/iTimeTraveler.github.io/master/gallery/android_common/okhttp_interceptors.png" itemprop="image">
      </a>
    
  </div>
</div>

    
      <header class="article-header">
        
  
    <h1 class="thumb" class="article-title" itemprop="name">
      ã€Androidã€‘OkHttpæºç åˆ†æ
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="" class="article-date">
	  <time datetime="2018-01-25T14:20:55.000Z" itemprop="datePublished">2018-01-25</time>
	</a>

      
    <a class="article-category-link" href="../../../../categories/Android/">Android</a><a class="article-category-link" href="../../../../categories/Android/æºç åˆ†æ/">æºç åˆ†æ</a>

      
	<a class="article-views">
	<span id="busuanzi_container_page_pv">
		é˜…è¯»é‡<span id="busuanzi_value_page_pv"></span>
	</span>
	</a>

    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <p>Androidä¸ºæˆ‘ä»¬æä¾›äº†ä¸¤ç§HTTPäº¤äº’çš„æ–¹å¼ï¼š<a href="https://developer.android.com/reference/java/net/HttpURLConnection.html" target="_blank" rel="noopener">HttpURLConnection</a> å’Œ Apache HttpClientï¼Œè™½ç„¶ä¸¤è€…éƒ½æ”¯æŒHTTPSï¼Œæµçš„ä¸Šä¼ å’Œä¸‹è½½ï¼Œé…ç½®è¶…æ—¶ï¼ŒIPv6å’Œè¿æ¥æ± ï¼Œå·²è¶³å¤Ÿæ»¡è¶³æˆ‘ä»¬å„ç§HTTPè¯·æ±‚çš„éœ€æ±‚ã€‚ä½†æ›´é«˜æ•ˆçš„ä½¿ç”¨HTTP å¯ä»¥è®©æ‚¨çš„åº”ç”¨è¿è¡Œæ›´å¿«ã€æ›´èŠ‚çœæµé‡ã€‚è€Œ<a href="https://github.com/square/okhttp">OkHttp</a>åº“å°±æ˜¯ä¸ºæ­¤è€Œç”Ÿã€‚åœ¨å¼€å§‹åˆ†æOkHttpä¹‹å‰æˆ‘ä»¬å…ˆäº†è§£ä¸€ä¸‹ HttpURLConnection å’Œ HttpClient ä¸¤è€…ä¹‹é—´å…³ç³»ï¼Œä»¥åŠå®ƒä»¬å’Œ OkHttp ä¹‹é—´çš„å…³ç³»ã€‚</p>
<h2 id="HttpClient-vs-HttpURLConnection"><a href="#HttpClient-vs-HttpURLConnection" class="headerlink" title="HttpClient vs HttpURLConnection"></a>HttpClient vs HttpURLConnection</h2><p>åœ¨Android API Level 9ï¼ˆAndroid 2.2ï¼‰ä¹‹å‰åªèƒ½ä½¿ç”¨<code>HttpClient</code>ç±»å‘é€httpè¯·æ±‚ã€‚<code>HttpClient</code>æ˜¯Apacheç”¨äºå‘é€httpè¯·æ±‚çš„å®¢æˆ·ç«¯ï¼Œå…¶æä¾›äº†å¼ºå¤§çš„APIæ”¯æŒï¼Œè€Œä¸”åŸºæœ¬æ²¡æœ‰ä»€ä¹ˆbugï¼Œä½†æ˜¯ç”±äºå…¶å¤ªè¿‡å¤æ‚ï¼ŒAndroidå›¢é˜Ÿåœ¨ä¿æŒå‘åå…¼å®¹çš„æƒ…å†µä¸‹ï¼Œå¾ˆéš¾å¯¹<code>DefaultHttpClient</code>è¿›è¡Œå¢å¼ºã€‚ä¸ºæ­¤ï¼ŒAndroidå›¢é˜Ÿä»Android API Level 9å¼€å§‹è‡ªå·±å®ç°äº†ä¸€ä¸ªå‘é€httpè¯·æ±‚çš„å®¢æˆ·ç«¯ç±» â€”â€” <code>HttpURLConnection</code>ã€‚</p>
<p>ç›¸æ¯”äº<code>DefaultHttpClient</code>ï¼Œ<code>HttpURLConnection</code>æ¯”è¾ƒè½»é‡çº§ï¼Œè™½ç„¶åŠŸèƒ½æ²¡æœ‰<code>DefaultHttpClient</code>é‚£ä¹ˆå¼ºå¤§ï¼Œä½†æ˜¯èƒ½å¤Ÿæ»¡è¶³å¤§éƒ¨åˆ†çš„éœ€æ±‚ï¼Œæ‰€ä»¥Androidæ¨èä½¿ç”¨<code>HttpURLConnection</code>ä»£æ›¿<code>DefaultHttpClient</code>ï¼Œå¹¶ä¸å¼ºåˆ¶ä½¿ç”¨<code>HttpURLConnection</code>ã€‚</p>
<p><strong>ä½†ä»Android API Level 23ï¼ˆAndroid 6.0ï¼‰å¼€å§‹ï¼Œä¸èƒ½å†åœ¨Androidä¸­ä½¿ç”¨<code>HttpClient</code></strong>ï¼Œå¼ºåˆ¶ä½¿ç”¨<code>HttpURLConnection</code>ã€‚å‚è€ƒå®˜ç½‘ï¼š<a href="https://developer.android.com/about/versions/marshmallow/android-6.0-changes.html" target="_blank" rel="noopener">Android 6.0 Changes - Google Developer</a></p>
<blockquote>
<p>Android 6.0 ç‰ˆç§»é™¤äº†å¯¹ Apache HTTP clientçš„æ”¯æŒã€‚å¦‚æœæ‚¨çš„åº”ç”¨ä½¿ç”¨è¯¥å®¢æˆ·ç«¯ï¼Œå¹¶ä»¥ Android 2.3ï¼ˆAPI level 9ï¼‰æˆ–æ›´é«˜ç‰ˆæœ¬ä¸ºç›®æ ‡å¹³å°ï¼Œè¯·æ”¹ç”¨ <code>HttpURLConnection</code> ç±»ã€‚æ­¤ API æ•ˆç‡æ›´é«˜ï¼Œå› ä¸ºå®ƒå¯ä»¥é€šè¿‡é€æ˜å‹ç¼©å’Œå“åº”ç¼“å­˜å‡å°‘ç½‘ç»œä½¿ç”¨ï¼Œå¹¶å¯æœ€å¤§é™åº¦é™ä½è€—ç”µé‡ã€‚è¦ç»§ç»­ä½¿ç”¨ Apache HTTP APIï¼Œæ‚¨å¿…é¡»å…ˆåœ¨ <code>build.gradle</code> æ–‡ä»¶ä¸­å£°æ˜ä»¥ä¸‹ç¼–è¯‘æ—¶ä¾èµ–é¡¹ï¼š</p>
</blockquote>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">android &#123;</span><br><span class="line">    useLibrary <span class="string">'org.apache.http.legacy'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<h3 id="äºŒè€…å¯¹æ¯”"><a href="#äºŒè€…å¯¹æ¯”" class="headerlink" title="äºŒè€…å¯¹æ¯”"></a>äºŒè€…å¯¹æ¯”</h3><ul>
<li><p><strong>HttpURLConnection</strong> </p>
<p>åœ¨Android2.2ä¹‹å‰ï¼šHttpURLConnection æœ‰ä¸ªé‡å¤§ Bugï¼šè°ƒç”¨ close() å‡½æ•°ä¼šå½±å“è¿æ¥æ± ,å¯¼è‡´è¿æ¥å¤ç”¨å¤±æ•ˆï¼›æ‰€ä»¥<strong>Android2.2ä¹‹å‰ä¸å»ºè®®ä½¿ç”¨HttpURLConnection</strong>ã€‚åœ¨Android2.2ä¹‹åï¼šHttpURLConnectioné»˜è®¤å¼€å¯äº† gzip å‹ç¼©&amp;æé«˜äº†HTTPS çš„æ€§èƒ½</p>
</li>
<li><p><strong>HttpClient</strong> </p>
<p>ä¼˜ç‚¹ï¼šç›¸æ¯”äºHttpURLConnectionï¼Œæ›´åŠ é«˜æ•ˆç®€æ´<br>ç¼ºç‚¹ï¼šç»“æ„è¿‡äºå¤æ‚ï¼›ç»´æŠ¤æˆæœ¬é«˜</p>
<blockquote>
<p>åœ¨5.0ç‰ˆæœ¬åè¢«Androidå®˜æ–¹å¼ƒç”¨</p>
</blockquote>
</li>
</ul>
<p>å°½ç®¡Googleåœ¨å¤§éƒ¨åˆ†å®‰å“ç‰ˆæœ¬ä¸­æ¨èä½¿ç”¨HttpURLConnectionï¼Œä½†æ˜¯è¿™ä¸ªç±»ç›¸æ¯”HttpClientå®åœ¨æ˜¯å¤ªéš¾ç”¨ï¼Œå¤ªå¼±çˆ†äº†ã€‚OkHttpæ˜¯ä¸€ä¸ªç›¸å¯¹æˆç†Ÿçš„è§£å†³æ–¹æ¡ˆï¼Œæˆ‘ä»¬è·Ÿè¸ªè¿™ç¯‡æ–‡ç« ï¼š<a href="http://blog.csdn.net/charon_chui/article/details/46895773" target="_blank" rel="noopener">Android HttpURLConnectionæºç åˆ†æ</a>ã€‚å°±ä¼šå‘ç°Android4.4ä¹‹åçš„HttpURLConnectionå…¶å®æ˜¯åŸºäº<code>OkHttp</code>å®ç°çš„ã€‚æ‰€ä»¥æˆ‘ä»¬æ›´æœ‰ç†ç”±ç›¸ä¿¡OkHttpçš„å¼ºå¤§ã€‚</p>
<h3 id="äºŒè€…ä¸ç½‘ç»œè¯·æ±‚åº“ä¹‹é—´çš„å…³ç³»"><a href="#äºŒè€…ä¸ç½‘ç»œè¯·æ±‚åº“ä¹‹é—´çš„å…³ç³»" class="headerlink" title="äºŒè€…ä¸ç½‘ç»œè¯·æ±‚åº“ä¹‹é—´çš„å…³ç³»"></a>äºŒè€…ä¸ç½‘ç»œè¯·æ±‚åº“ä¹‹é—´çš„å…³ç³»</h3><p>ç½‘ç»œè¯·æ±‚æ¡†æ¶æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªå°†ç½‘ç»œè¯·æ±‚çš„ç›¸å…³æ–¹æ³•ï¼ˆ HttpClientæˆ–HttpURLConnectionï¼‰å°è£…å¥½çš„ç±»åº“ï¼Œå¹¶å®ç°å¦å¼€çº¿ç¨‹è¿›è¡Œè¯·æ±‚å’Œå¤„ç†æ•°æ®ï¼Œä»è€Œå®ç°æ•´ä¸ªç½‘ç»œè¯·æ±‚æ¨¡å—çš„åŠŸèƒ½ã€‚å…·ä½“çš„å…³ç³»å¯çœ‹ä¸‹å›¾: </p>
<p><img src="https://raw.githubusercontent.com/iTimeTraveler/iTimeTraveler.github.io/master/gallery/android_common/20160810152440105.jpg" alt=""></p>
<p>è€Œ<code>OkHttp</code>æ˜¯åŸºäºhttpåè®®å°è£…çš„ä¸€å¥—è¯·æ±‚å®¢æˆ·ç«¯ï¼Œè™½ç„¶å®ƒä¹Ÿå¯ä»¥å¼€çº¿ç¨‹ï¼Œä½†æ ¹æœ¬ä¸Šå®ƒæ›´åå‘çœŸæ­£çš„è¯·æ±‚ï¼Œè·Ÿ<code>HttpClient</code>ï¼Œ<code>HttpUrlConnection</code>çš„èŒè´£æ˜¯ä¸€æ ·çš„ã€‚</p>
<h2 id="OkHttpç®€ä»‹"><a href="#OkHttpç®€ä»‹" class="headerlink" title="OkHttpç®€ä»‹"></a>OkHttpç®€ä»‹</h2><p><a href="https://github.com/square/okhttp">OkHttp</a> åº“çš„è®¾è®¡å’Œå®ç°çš„é¦–è¦ç›®æ ‡æ˜¯é«˜æ•ˆã€‚è¿™ä¹Ÿæ˜¯é€‰æ‹© OkHttp çš„é‡è¦ç†ç”±ä¹‹ä¸€ã€‚OkHttp æä¾›äº†å¯¹æœ€æ–°çš„ HTTP åè®®ç‰ˆæœ¬ HTTP/2 å’Œ SPDY çš„æ”¯æŒï¼Œè¿™ä½¿å¾—å¯¹åŒä¸€ä¸ªä¸»æœºå‘å‡ºçš„æ‰€æœ‰è¯·æ±‚éƒ½å¯ä»¥å…±äº«ç›¸åŒçš„Socketè¿æ¥ã€‚å¦‚æœ HTTP/2 å’Œ SPDY ä¸å¯ç”¨ï¼ŒOkHttp ä¼šä½¿ç”¨è¿æ¥æ± æ¥å¤ç”¨è¿æ¥ä»¥æé«˜æ•ˆç‡ã€‚OkHttp æä¾›äº†å¯¹ GZIP çš„é»˜è®¤æ”¯æŒæ¥é™ä½ä¼ è¾“å†…å®¹çš„å¤§å°ã€‚OkHttp ä¹Ÿæä¾›äº†å¯¹ HTTP å“åº”çš„ç¼“å­˜æœºåˆ¶ï¼Œå¯ä»¥é¿å…ä¸å¿…è¦çš„ç½‘ç»œè¯·æ±‚ã€‚å½“ç½‘ç»œå‡ºç°é—®é¢˜æ—¶ï¼ŒOkHttp ä¼šè‡ªåŠ¨é‡è¯•ä¸€ä¸ªä¸»æœºçš„å¤šä¸ª IP åœ°å€ã€‚</p>
<p>OkHttpæ˜¯ä¸€ä¸ªé«˜æ•ˆçš„HTTPåº“ï¼š</p>
<blockquote>
<ul>
<li>æ”¯æŒ HTTP/2å’ŒSPDY ï¼Œå…±äº«åŒä¸€ä¸ªSocketæ¥å¤„ç†åŒä¸€ä¸ªæœåŠ¡å™¨çš„æ‰€æœ‰è¯·æ±‚</li>
<li>å¦‚æœ HTTP/2å’ŒSPDY ä¸å¯ç”¨ï¼Œåˆ™é€šè¿‡è¿æ¥æ± æ¥å‡å°‘è¯·æ±‚å»¶æ—¶</li>
<li>æ— ç¼çš„æ”¯æŒGZIPæ¥å‡å°‘æ•°æ®æµé‡</li>
<li>ç¼“å­˜å“åº”æ•°æ®æ¥å‡å°‘é‡å¤çš„ç½‘ç»œè¯·æ±‚</li>
</ul>
</blockquote>
<h2 id="å¦‚ä½•ä½¿ç”¨"><a href="#å¦‚ä½•ä½¿ç”¨" class="headerlink" title="å¦‚ä½•ä½¿ç”¨"></a>å¦‚ä½•ä½¿ç”¨</h2><p>OkHttpçš„ä½¿ç”¨æ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œæ•´ä½“æ­¥éª¤æ˜¯ï¼š</p>
<ol>
<li>åˆå§‹åŒ– OkHttpClient</li>
<li>åˆå§‹åŒ–ä¸€ä¸ª Request</li>
<li>ç”± OkHttpClient å’Œ Request ç”Ÿæˆä¸€ä¸ª Call</li>
<li>Call è°ƒç”¨ enqueue ï¼ˆå¼‚æ­¥ï¼‰æˆ–è€… execute æ–¹æ³•ï¼ˆåŒæ­¥ï¼‰</li>
</ol>
<h3 id="åŒæ­¥Getè¯·æ±‚"><a href="#åŒæ­¥Getè¯·æ±‚" class="headerlink" title="åŒæ­¥Getè¯·æ±‚"></a>åŒæ­¥Getè¯·æ±‚</h3><p>è¿™æ˜¯OkHttp æœ€åŸºæœ¬çš„ HTTP è¯·æ±‚ï¼Œæ³¨æ„åˆ«æ”¾åˆ°UIçº¿ç¨‹æ‰§è¡Œã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SyncGet</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="comment">//1. åˆå§‹åŒ–OkHttpClient</span></span><br><span class="line">        OkHttpClient client = <span class="keyword">new</span> OkHttpClient();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//2. åˆå§‹åŒ–ä¸€ä¸ªRequest</span></span><br><span class="line">        Request request = <span class="keyword">new</span> Request.Builder()</span><br><span class="line">                .url(<span class="string">"http://www.baidu.com"</span>)</span><br><span class="line">                .header(<span class="string">"User-Agent"</span>, <span class="string">"My super agent"</span>)</span><br><span class="line">                .addHeader(<span class="string">"Accept"</span>, <span class="string">"text/html"</span>)</span><br><span class="line">                .build();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//3. ç”±OkHttpClientå’ŒRequestç”Ÿæˆä¸€ä¸ªCall</span></span><br><span class="line">        <span class="comment">//4. callè°ƒç”¨enqueueæˆ–è€…execute</span></span><br><span class="line">        Response response = client.newCall(request).execute();</span><br><span class="line">        <span class="keyword">if</span> (!response.isSuccessful()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"æœåŠ¡å™¨ç«¯é”™è¯¯: "</span> + response);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Headers responseHeaders = response.headers();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; responseHeaders.size(); i++) &#123;</span><br><span class="line">            System.out.println(responseHeaders.name(i) + <span class="string">": "</span> + responseHeaders.value(i));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        System.out.println(response.body().string());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="å¼‚æ­¥Getè¯·æ±‚"><a href="#å¼‚æ­¥Getè¯·æ±‚" class="headerlink" title="å¼‚æ­¥Getè¯·æ±‚"></a>å¼‚æ­¥Getè¯·æ±‚</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AsyncGet</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        OkHttpClient client = <span class="keyword">new</span> OkHttpClient();</span><br><span class="line"></span><br><span class="line">        Request request = <span class="keyword">new</span> Request.Builder()</span><br><span class="line">                .url(<span class="string">"http://www.baidu.com"</span>)</span><br><span class="line">                .build();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//Call è°ƒç”¨ enqueue æ–¹æ³•</span></span><br><span class="line">        client.newCall(request).enqueue(<span class="keyword">new</span> Callback() &#123;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFailure</span><span class="params">(Request request, IOException e)</span> </span>&#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResponse</span><span class="params">(Response response)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (!response.isSuccessful()) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"æœåŠ¡å™¨ç«¯é”™è¯¯: "</span> + response);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                System.out.println(response.body().string());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Postè¯·æ±‚"><a href="#Postè¯·æ±‚" class="headerlink" title="Postè¯·æ±‚"></a>Postè¯·æ±‚</h3><p>HTTP POST å’Œ PUT è¯·æ±‚å¯ä»¥åŒ…å«è¦æäº¤çš„å†…å®¹ã€‚åªéœ€è¦åœ¨åˆ›å»º <code>Request</code> å¯¹è±¡æ—¶ï¼Œé€šè¿‡ <code>post()</code> å’Œ <code>put()</code> æ–¹æ³•æ¥æŒ‡å®šè¦æäº¤çš„å†…å®¹å³å¯ã€‚ä¸‹é¢çš„ä»£ç é€šè¿‡ <code>RequestBody</code> çš„ <code>create()</code> æ–¹æ³•æ¥åˆ›å»ºåª’ä½“ç±»å‹ä¸º<strong>application/ json</strong> çš„å†…å®¹å¹¶æäº¤ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> MediaType JSON = MediaType.parse(<span class="string">"application/json; charset=utf-8"</span>);</span><br><span class="line">OkHttpClient client = <span class="keyword">new</span> OkHttpClient();</span><br><span class="line"></span><br><span class="line"><span class="comment">//postè¯·æ±‚</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">post</span><span class="params">(String url, String json)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    RequestBody body = RequestBody.create(JSON, json);</span><br><span class="line">    Request request = <span class="keyword">new</span> Request.Builder()</span><br><span class="line">            .url(url)</span><br><span class="line">            .post(body)</span><br><span class="line">            .build();</span><br><span class="line">    Response response = client.newCall(request).execute();</span><br><span class="line">    <span class="keyword">return</span> response.body().string();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å…·ä½“çš„ä½¿ç”¨æ–¹æ³•å¯ä»¥å‚è€ƒIBMçš„è¿™ç¯‡æ–‡ç« ï¼š<a href="https://www.ibm.com/developerworks/cn/java/j-lo-okhttp/" target="_blank" rel="noopener">OkHttpï¼šJavaå¹³å°ä¸Šçš„æ–°ä¸€ä»£HTTPå®¢æˆ·ç«¯</a> ï¼Œä¸‹é¢æˆ‘ä»¬è½¬å…¥æºç çš„åˆ†æã€‚</p>
<h2 id="æºç åˆ†æ"><a href="#æºç åˆ†æ" class="headerlink" title="æºç åˆ†æ"></a>æºç åˆ†æ</h2><p>æˆ‘ä»¬ä»åˆ›å»º <code>OkHttpClient</code> å¯¹è±¡å¼€å§‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">OkHttpClient client = <span class="keyword">new</span> OkHttpClient();</span><br></pre></td></tr></table></figure>
<h3 id="OkHttpClient"><a href="#OkHttpClient" class="headerlink" title="OkHttpClient"></a>OkHttpClient</h3><p>çœ‹çœ‹å…¶æ„é€ å‡½æ•°ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">OkHttpClient</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>(<span class="keyword">new</span> Builder());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åŸæ¥æ˜¯æ–¹ä¾¿æˆ‘ä»¬ä½¿ç”¨ï¼Œæä¾›äº†ä¸€ä¸ªâ€œå¿«æ·æ“ä½œâ€ï¼Œå…¨éƒ¨ä½¿ç”¨äº†é»˜è®¤çš„é…ç½®ã€‚<code>OkHttpClient.Builder</code> ç±»æˆå‘˜å¾ˆå¤šï¼Œåé¢æˆ‘ä»¬å†æ…¢æ…¢åˆ†æï¼Œè¿™é‡Œå…ˆæš‚æ—¶ç•¥è¿‡ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//OkHttpClient.javaç±»ä¸­</span></span><br><span class="line">OkHttpClient(Builder builder) &#123;</span><br><span class="line">  <span class="keyword">this</span>.dispatcher = builder.dispatcher; <span class="comment">// åˆ†å‘å™¨</span></span><br><span class="line">  <span class="keyword">this</span>.proxy = builder.proxy; <span class="comment">// ä»£ç†</span></span><br><span class="line">  <span class="keyword">this</span>.protocols = builder.protocols; <span class="comment">// åè®®</span></span><br><span class="line">  <span class="keyword">this</span>.connectionSpecs = builder.connectionSpecs;</span><br><span class="line">  <span class="keyword">this</span>.interceptors = Util.immutableList(builder.interceptors); <span class="comment">// æ‹¦æˆªå™¨</span></span><br><span class="line">  <span class="keyword">this</span>.networkInterceptors = Util.immutableList(builder.networkInterceptors); <span class="comment">// ç½‘ç»œæ‹¦æˆªå™¨</span></span><br><span class="line">  <span class="keyword">this</span>.eventListenerFactory = builder.eventListenerFactory;</span><br><span class="line">  <span class="keyword">this</span>.proxySelector = builder.proxySelector; <span class="comment">// ä»£ç†é€‰æ‹©</span></span><br><span class="line">  <span class="keyword">this</span>.cookieJar = builder.cookieJar; <span class="comment">// cookie</span></span><br><span class="line">  <span class="keyword">this</span>.cache = builder.cache; <span class="comment">// ç¼“å­˜</span></span><br><span class="line">  <span class="keyword">this</span>.internalCache = builder.internalCache;</span><br><span class="line">  <span class="keyword">this</span>.socketFactory = builder.socketFactory;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">boolean</span> isTLS = <span class="keyword">false</span>;</span><br><span class="line">  <span class="keyword">for</span> (ConnectionSpec spec : connectionSpecs) &#123;</span><br><span class="line">    isTLS = isTLS || spec.isTls();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (builder.sslSocketFactory != <span class="keyword">null</span> || !isTLS) &#123;</span><br><span class="line">    <span class="keyword">this</span>.sslSocketFactory = builder.sslSocketFactory;</span><br><span class="line">    <span class="keyword">this</span>.certificateChainCleaner = builder.certificateChainCleaner;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    X509TrustManager trustManager = systemDefaultTrustManager();</span><br><span class="line">    <span class="keyword">this</span>.sslSocketFactory = systemDefaultSslSocketFactory(trustManager);</span><br><span class="line">    <span class="keyword">this</span>.certificateChainCleaner = CertificateChainCleaner.get(trustManager);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.hostnameVerifier = builder.hostnameVerifier;</span><br><span class="line">  <span class="keyword">this</span>.certificatePinner = builder.certificatePinner.withCertificateChainCleaner(</span><br><span class="line">      certificateChainCleaner);</span><br><span class="line">  <span class="keyword">this</span>.proxyAuthenticator = builder.proxyAuthenticator;</span><br><span class="line">  <span class="keyword">this</span>.authenticator = builder.authenticator;</span><br><span class="line">  <span class="keyword">this</span>.connectionPool = builder.connectionPool; <span class="comment">// è¿æ¥å¤ç”¨æ± </span></span><br><span class="line">  <span class="keyword">this</span>.dns = builder.dns;</span><br><span class="line">  <span class="keyword">this</span>.followSslRedirects = builder.followSslRedirects;</span><br><span class="line">  <span class="keyword">this</span>.followRedirects = builder.followRedirects;</span><br><span class="line">  <span class="keyword">this</span>.retryOnConnectionFailure = builder.retryOnConnectionFailure;</span><br><span class="line">  <span class="keyword">this</span>.connectTimeout = builder.connectTimeout; <span class="comment">// è¿æ¥è¶…æ—¶æ—¶é—´</span></span><br><span class="line">  <span class="keyword">this</span>.readTimeout = builder.readTimeout; <span class="comment">// è¯»å–è¶…æ—¶æ—¶é—´</span></span><br><span class="line">  <span class="keyword">this</span>.writeTimeout = builder.writeTimeout; <span class="comment">// å†™å…¥è¶…æ—¶æ—¶é—´</span></span><br><span class="line">  <span class="keyword">this</span>.pingInterval = builder.pingInterval;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>çœ‹åˆ°è¿™ï¼Œå¦‚æœä½ è¿˜ä¸æ˜ç™½çš„è¯ï¼Œä¹Ÿæ²¡å…³ç³»ï¼Œåœ¨<code>OkHttp</code>ä¸­åªæ˜¯è®¾ç½®ç”¨çš„çš„å„ä¸ªä¸œè¥¿ã€‚</p>
<p>çœŸæ­£çš„æµç¨‹è¦ä»é‡Œé¢çš„<code>newCall()</code>æ–¹æ³•ä¸­è¯´èµ·ï¼Œå› ä¸ºæˆ‘ä»¬ä½¿ç”¨OkHttpå‘èµ· HTTP è¯·æ±‚çš„æ–¹å¼ä¸€èˆ¬å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Request request = <span class="keyword">new</span> Request.Builder()</span><br><span class="line">      .url(<span class="string">"http://www.baidu.com"</span>)</span><br><span class="line">      .build();</span><br><span class="line"></span><br><span class="line"><span class="comment">//å‘èµ·åŒæ­¥è¯·æ±‚</span></span><br><span class="line">Response response = client.newCall(request).execute();</span><br></pre></td></tr></table></figure>
<p>å½“é€šè¿‡<strong>å»ºé€ è€…æ¨¡å¼</strong>åˆ›å»ºäº†<code>Request</code>ä¹‹åï¼ˆè¿™ä¸ªæ²¡ä»€ä¹ˆå¥½è¯´ï¼‰ï¼Œç´§æ¥ç€å°±é€šè¿‡<code>client.newCall(request).execute()</code>æ¥è·å¾—<code>Response</code>ã€‚è¿™å¥ä»£ç å°±å¼€å¯äº†æ•´ä¸ªGETè¯·æ±‚çš„æµç¨‹ï¼š</p>
<p>é‚£æˆ‘ä»¬ç°åœ¨å°±æ¥çœ‹çœ‹å®ƒæ˜¯å¦‚ä½•é€šè¿‡<code>newCall()</code>åˆ›å»º Call çš„ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span> </span><br><span class="line"><span class="function"><span class="keyword">public</span> Call <span class="title">newCall</span><span class="params">(Request request)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> RealCall.newRealCall(<span class="keyword">this</span>, request, <span class="keyword">false</span> <span class="comment">/* for web socket */</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Call"><a href="#Call" class="headerlink" title="Call"></a>Call</h3><p>åœ¨è¿™é‡Œå†å¤šè¯´ä¸€ä¸‹å…³äºCallè¿™ä¸ªç±»çš„ä½œç”¨ï¼Œ<strong>OkHttp ä½¿ç”¨è°ƒç”¨ï¼ˆCallï¼‰æ¥å¯¹å‘é€ HTTP è¯·æ±‚å’Œè·å–å“åº”çš„è¿‡ç¨‹è¿›è¡ŒæŠ½è±¡ã€‚</strong>åœ¨Callä¸­æŒæœ‰ä¸€ä¸ªHttpEngineã€‚æ¯ä¸€ä¸ªä¸åŒçš„Calléƒ½æœ‰è‡ªå·±ç‹¬ç«‹çš„HttpEngineã€‚åœ¨HttpEngineä¸­ä¸»è¦æ˜¯å„ç§é“¾è·¯å’Œåœ°å€çš„é€‰æ‹©ï¼Œè¿˜æœ‰ä¸€ä¸ªTransportæ¯”è¾ƒé‡è¦ã€‚<code>Call</code>æ¥å£å®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Call</span> <span class="keyword">extends</span> <span class="title">Cloneable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function">Request <span class="title">request</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="function">Response <span class="title">execute</span><span class="params">()</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">enqueue</span><span class="params">(Callback responseCallback)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">cancel</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">boolean</span> <span class="title">isExecuted</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">boolean</span> <span class="title">isCanceled</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="function">Call <span class="title">clone</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">interface</span> <span class="title">Factory</span> </span>&#123;</span><br><span class="line">		<span class="function">Call <span class="title">newCall</span><span class="params">(Request request)</span></span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>OkHttpClient</code> å®ç°äº† <code>Call.Factory</code>ï¼Œè´Ÿè´£æ ¹æ®è¯·æ±‚åˆ›å»ºæ–°çš„ <code>Call</code>ã€‚</p>
<blockquote>
<p><code>CallFactory</code> è´Ÿè´£åˆ›å»º HTTP è¯·æ±‚ï¼ŒHTTP è¯·æ±‚è¢«æŠ½è±¡ä¸ºäº† <code>okhttp3.Call</code> ç±»ï¼Œå®ƒè¡¨ç¤ºä¸€ä¸ªå·²ç»å‡†å¤‡å¥½ï¼Œå¯ä»¥éšæ—¶æ‰§è¡Œçš„ HTTP è¯·æ±‚</p>
</blockquote>
<h3 id="RealCall"><a href="#RealCall" class="headerlink" title="RealCall"></a>RealCall</h3><p>RealCallæ˜¯<code>Call</code>æ¥å£çš„å®ç°ï¼Œæˆ‘ä»¬ç»§ç»­æ¥ç€ä¸Šé¢çœ‹RealCallçš„<code>newRealCall()</code>æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> RealCall <span class="title">newRealCall</span><span class="params">(OkHttpClient client, Request originalRequest, <span class="keyword">boolean</span> forWebSocket)</span> </span>&#123;</span><br><span class="line">	<span class="comment">// Safely publish the Call instance to the EventListener.</span></span><br><span class="line">	RealCall call = <span class="keyword">new</span> RealCall(client, originalRequest, forWebSocket);</span><br><span class="line">	call.eventListener = client.eventListenerFactory().create(call);</span><br><span class="line">	<span class="keyword">return</span> call;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="title">RealCall</span><span class="params">(OkHttpClient client, Request originalRequest, <span class="keyword">boolean</span> forWebSocket)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">this</span>.client = client;</span><br><span class="line">	<span class="keyword">this</span>.originalRequest = originalRequest;</span><br><span class="line">	<span class="keyword">this</span>.forWebSocket = forWebSocket;</span><br><span class="line">	<span class="keyword">this</span>.retryAndFollowUpInterceptor = <span class="keyword">new</span> RetryAndFollowUpInterceptor(client, forWebSocket);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å…¶å®å°±æ˜¯é€šè¿‡æ„é€ å‡½æ•°newäº†ä¸€ä¸ª<code>RealCall</code>å¯¹è±¡ï¼Œæ„é€ å‡½æ•°å¦‚ä¸‹ï¼Œä¸ç”¨çœ‹å¾ˆç»†ï¼Œç•¥è¿‡ã€‚æˆ‘ä»¬<strong>é‡ç‚¹çœ‹çœ‹ <code>RealCall#execute</code></strong>ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//RealCallç±»ä¸­</span></span><br><span class="line"><span class="meta">@Override</span> </span><br><span class="line"><span class="function"><span class="keyword">public</span> Response <span class="title">execute</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">	<span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">		<span class="comment">//1. æ¯ä¸ªCallåªèƒ½è¢«æ‰§è¡Œä¸€æ¬¡ã€‚å¦‚æœè¯¥ call å·²ç»è¢«æ‰§è¡Œè¿‡äº†ï¼Œå°±è®¾ç½® executed ä¸º true</span></span><br><span class="line">		<span class="keyword">if</span> (executed) <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Already Executed"</span>);</span><br><span class="line">		executed = <span class="keyword">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	captureCallStackTrace();</span><br><span class="line">	eventListener.callStart(<span class="keyword">this</span>);</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		<span class="comment">//2. åŠ å…¥ runningSyncCalls é˜Ÿåˆ—ä¸­</span></span><br><span class="line">		client.dispatcher().executed(<span class="keyword">this</span>);</span><br><span class="line">		<span class="comment">//3. å¾—åˆ°å“åº” result</span></span><br><span class="line">		Response result = getResponseWithInterceptorChain();</span><br><span class="line">		<span class="keyword">if</span> (result == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"Canceled"</span>);</span><br><span class="line">		<span class="keyword">return</span> result;</span><br><span class="line">	&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">		eventListener.callFailed(<span class="keyword">this</span>, e);</span><br><span class="line">		<span class="keyword">throw</span> e;</span><br><span class="line">	&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">		<span class="comment">//4. ä» runningSyncCalls é˜Ÿåˆ—ä¸­ç§»é™¤</span></span><br><span class="line">		client.dispatcher().finished(<span class="keyword">this</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œæˆ‘ä»¬åšäº† 4 ä»¶äº‹ï¼š</p>
<ol>
<li>æ£€æŸ¥è¿™ä¸ª call æ˜¯å¦å·²ç»è¢«æ‰§è¡Œäº†ï¼Œæ¯ä¸ª call åªèƒ½è¢«æ‰§è¡Œä¸€æ¬¡ï¼Œå¦‚æœæƒ³è¦ä¸€ä¸ªå®Œå…¨ä¸€æ ·çš„ callï¼Œå¯ä»¥åˆ©ç”¨ <code>call#clone</code> æ–¹æ³•è¿›è¡Œå…‹éš†ã€‚</li>
<li>åˆ©ç”¨ <code>client.dispatcher().executed(this)</code> æ¥è¿›è¡Œå®é™…æ‰§è¡Œï¼Œ<code>dispatcher</code> æ˜¯åˆšæ‰çœ‹åˆ°çš„ <code>OkHttpClient.Builder</code> çš„æˆå‘˜ä¹‹ä¸€ï¼Œå®ƒçš„æ–‡æ¡£è¯´è‡ªå·±æ˜¯å¼‚æ­¥ HTTP è¯·æ±‚çš„æ‰§è¡Œç­–ç•¥ï¼Œç°åœ¨çœ‹æ¥ï¼ŒåŒæ­¥è¯·æ±‚å®ƒä¹Ÿæœ‰æºå’Œã€‚</li>
<li>è°ƒç”¨ <code>getResponseWithInterceptorChain()</code> å‡½æ•°è·å– HTTP è¿”å›ç»“æœï¼Œä»å‡½æ•°åå¯ä»¥çœ‹å‡ºï¼Œè¿™ä¸€æ­¥è¿˜ä¼šè¿›è¡Œä¸€ç³»åˆ—â€œæ‹¦æˆªâ€æ“ä½œã€‚</li>
<li>æœ€åè¿˜è¦é€šçŸ¥ <code>dispatcher</code> è‡ªå·±å·²ç»æ‰§è¡Œå®Œæ¯•ã€‚</li>
</ol>
<p><code>dispatcher</code> è¿™é‡Œæˆ‘ä»¬ä¸è¿‡åº¦å…³æ³¨ï¼Œåœ¨åŒæ­¥æ‰§è¡Œçš„æµç¨‹ä¸­ï¼Œæ¶‰åŠåˆ° dispatcher çš„å†…å®¹åªä¸è¿‡æ˜¯å‘ŠçŸ¥å®ƒæˆ‘ä»¬çš„æ‰§è¡ŒçŠ¶æ€ï¼Œæ¯”å¦‚å¼€å§‹æ‰§è¡Œäº†ï¼ˆè°ƒç”¨ <code>executed</code>ï¼‰ï¼Œæ¯”å¦‚æ‰§è¡Œå®Œæ¯•äº†ï¼ˆè°ƒç”¨ <code>finished</code>ï¼‰ï¼Œåœ¨å¼‚æ­¥æ‰§è¡Œæµç¨‹ä¸­å®ƒä¼šæœ‰æ›´å¤šçš„å‚ä¸ã€‚</p>
<p>çœŸæ­£å‘å‡ºç½‘ç»œè¯·æ±‚ï¼Œè§£æè¿”å›ç»“æœçš„ï¼Œè¿˜æ˜¯ <code>getResponseWithInterceptorChain</code>ã€‚æˆ‘ä»¬å¯ä»¥çœ‹åˆ°è¿™æ–¹æ³•æ˜¯ç›´æ¥è¿”å› <code>Response</code> å¯¹è±¡çš„ï¼Œæ‰€ä»¥ï¼Œåœ¨è¿™ä¸ªæ–¹æ³•ä¸­ä¸€å®šåšäº†å¾ˆå¤šå¾ˆå¤šçš„äº‹æƒ…ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//RealCallç±»ä¸­</span></span><br><span class="line"><span class="function">Response <span class="title">getResponseWithInterceptorChain</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="comment">// Build a full stack of interceptors.</span></span><br><span class="line">    List&lt;Interceptor&gt; interceptors = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    interceptors.addAll(client.interceptors());    <span class="comment">// åŠ å…¥ç”¨æˆ·è‡ªå®šä¹‰çš„æ‹¦æˆªå™¨</span></span><br><span class="line">    interceptors.add(retryAndFollowUpInterceptor);   <span class="comment">// é‡è¯•å’Œé‡å®šå‘æ‹¦æˆªå™¨</span></span><br><span class="line">    interceptors.add(<span class="keyword">new</span> BridgeInterceptor(client.cookieJar()));  <span class="comment">// åŠ å…¥è½¬åŒ–è¯·æ±‚å“åº”çš„æ‹¦æˆªå™¨</span></span><br><span class="line">    interceptors.add(<span class="keyword">new</span> CacheInterceptor(client.internalCache()));  <span class="comment">// åŠ å…¥ç¼“å­˜æ‹¦æˆªå™¨</span></span><br><span class="line">    interceptors.add(<span class="keyword">new</span> ConnectInterceptor(client));  <span class="comment">// åŠ å…¥è¿æ¥æ‹¦æˆªå™¨</span></span><br><span class="line">    <span class="keyword">if</span> (!forWebSocket) &#123;</span><br><span class="line">      interceptors.addAll(client.networkInterceptors());   <span class="comment">// åŠ å…¥ç”¨æˆ·è‡ªå®šä¹‰çš„ç½‘ç»œæ‹¦æˆªå™¨</span></span><br><span class="line">    &#125;</span><br><span class="line">    interceptors.add(<span class="keyword">new</span> CallServerInterceptor(forWebSocket));   <span class="comment">// åŠ å…¥å‘å‡ºè¯·æ±‚å’Œè¯»å–å“åº”çš„æ‹¦æˆªå™¨</span></span><br><span class="line"></span><br><span class="line">    Interceptor.Chain chain = <span class="keyword">new</span> RealInterceptorChain(interceptors, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="number">0</span>,</span><br><span class="line">        originalRequest, <span class="keyword">this</span>, eventListener, client.connectTimeoutMillis(),</span><br><span class="line">        client.readTimeoutMillis(), client.writeTimeoutMillis());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ©ç”¨ chain æ¥é“¾å¼è°ƒç”¨æ‹¦æˆªå™¨ï¼Œæœ€åçš„è¿”å›ç»“æœå°±æ˜¯ Response å¯¹è±¡</span></span><br><span class="line">    <span class="keyword">return</span> chain.proceed(originalRequest);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨ <a href="https://publicobject.com/2016/07/03/the-last-httpurlconnection/" target="_blank" rel="noopener">OkHttp å¼€å‘è€…ä¹‹ä¸€ä»‹ç» OkHttp çš„æ–‡ç« </a>é‡Œé¢ï¼Œä½œè€…è®²åˆ°ï¼š</p>
<blockquote>
<p>the whole thing is just a stack of built-in interceptors.</p>
</blockquote>
<p>å¯è§ <code>Interceptor</code> æ˜¯ OkHttp æœ€æ ¸å¿ƒçš„ä¸€ä¸ªä¸œè¥¿ï¼Œä¸è¦è¯¯ä»¥ä¸ºå®ƒåªè´Ÿè´£æ‹¦æˆªè¯·æ±‚è¿›è¡Œä¸€äº›é¢å¤–çš„å¤„ç†ï¼ˆä¾‹å¦‚ cookieï¼‰ï¼Œ<strong>å®é™…ä¸Šå®ƒæŠŠå®é™…çš„ç½‘ç»œè¯·æ±‚ã€ç¼“å­˜ã€é€æ˜å‹ç¼©ç­‰åŠŸèƒ½éƒ½ç»Ÿä¸€äº†èµ·æ¥</strong>ï¼Œæ¯ä¸€ä¸ªåŠŸèƒ½éƒ½åªæ˜¯ä¸€ä¸ª <code>Interceptor</code>ï¼Œå®ƒä»¬å†è¿æ¥æˆä¸€ä¸ª <code>Interceptor.Chain</code>ï¼Œç¯ç¯ç›¸æ‰£ï¼Œæœ€ç»ˆåœ†æ»¡å®Œæˆä¸€æ¬¡ç½‘ç»œè¯·æ±‚ã€‚</p>
<p>ä» <code>getResponseWithInterceptorChain</code> å‡½æ•°æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œ<code>Interceptor.Chain</code> çš„åˆ†å¸ƒä¾æ¬¡æ˜¯ï¼š</p>
<p><img src="https://raw.githubusercontent.com/iTimeTraveler/iTimeTraveler.github.io/master/gallery/android_common/okhttp_interceptors-details.png" alt=""></p>
<ol>
<li><code>client.interceptors()</code> ï¼Œé¦–å…ˆåŠ å…¥ <code>interceptors</code> çš„æ˜¯ç”¨æˆ·è‡ªå®šä¹‰çš„æ‹¦æˆªå™¨ï¼Œæ¯”å¦‚ä¿®æ”¹è¯·æ±‚å¤´çš„æ‹¦æˆªå™¨ç­‰ï¼›</li>
<li><strong>RetryAndFollowUpInterceptor</strong> ï¼šæ˜¯ç”¨æ¥é‡è¯•å’Œé‡å®šå‘çš„æ‹¦æˆªå™¨ï¼Œåœ¨ä¸‹é¢æˆ‘ä»¬ä¼šè®²åˆ°ï¼›</li>
<li><strong>BridgeInterceptor</strong>ï¼šæ˜¯ç”¨æ¥å°†ç”¨æˆ·å‹å¥½çš„è¯·æ±‚è½¬åŒ–ä¸ºå‘æœåŠ¡å™¨çš„è¯·æ±‚ï¼Œä¹‹ååˆæŠŠæœåŠ¡å™¨çš„å“åº”è½¬åŒ–ä¸ºå¯¹ç”¨æˆ·å‹å¥½çš„å“åº”ï¼›</li>
<li><strong>CacheInterceptor</strong>ï¼šæ˜¯ç¼“å­˜æ‹¦æˆªå™¨ï¼Œè‹¥å­˜åœ¨ç¼“å­˜å¹¶ä¸”å¯ç”¨å°±ç›´æ¥è¿”å›è¯¥ç¼“å­˜ï¼Œå¦åˆ™ä¼šå‘æœåŠ¡å™¨è¯·æ±‚ï¼›</li>
<li><strong>ConnectInterceptor</strong>ï¼šç”¨æ¥å»ºç«‹è¿æ¥çš„æ‹¦æˆªå™¨ï¼›</li>
<li><code>client.networkInterceptors()</code> åŠ å…¥ç”¨æˆ·è‡ªå®šä¹‰çš„ <code>networkInterceptors</code> ;</li>
<li><strong>CallServerInterceptor</strong>ï¼šæ˜¯çœŸæ­£å‘æœåŠ¡å™¨å‘å‡ºè¯·æ±‚ä¸”å¾—åˆ°å“åº”çš„æ‹¦æˆªå™¨ï¼›</li>
</ol>
<p>åœ¨è¿™é‡Œï¼Œä½ç½®å†³å®šäº†åŠŸèƒ½ï¼Œæœ€åä¸€ä¸ª Interceptor ä¸€å®šæ˜¯è´Ÿè´£å’ŒæœåŠ¡å™¨å®é™…é€šè®¯çš„ï¼Œé‡å®šå‘ã€ç¼“å­˜ç­‰ä¸€å®šæ˜¯åœ¨å®é™…é€šè®¯ä¹‹å‰çš„ã€‚</p>
<p><a href="https://zh.wikipedia.org/wiki/%E8%B4%A3%E4%BB%BB%E9%93%BE%E6%A8%A1%E5%BC%8F" target="_blank" rel="noopener">è´£ä»»é“¾æ¨¡å¼</a>åœ¨è¿™ä¸ª <code>Interceptor</code> é“¾æ¡ä¸­å¾—åˆ°äº†å¾ˆå¥½çš„å®è·µã€‚</p>
<blockquote>
<p><strong>è´£ä»»é“¾æ¨¡å¼</strong>åœ¨<a href="https://zh.wikipedia.org/wiki/%E7%89%A9%E4%BB%B6%E5%B0%8E%E5%90%91%E7%A8%8B%E5%BC%8F%E8%A8%AD%E8%A8%88" target="_blank" rel="noopener">é¢å‘å¯¹è±¡ç¨‹å¼è®¾è®¡</a>é‡Œæ˜¯ä¸€ç§<a href="https://zh.wikipedia.org/wiki/%E8%BD%AF%E4%BB%B6%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F" target="_blank" rel="noopener">è½¯ä»¶è®¾è®¡æ¨¡å¼</a>ï¼Œå®ƒåŒ…å«äº†ä¸€äº›å‘½ä»¤å¯¹è±¡å’Œä¸€ç³»åˆ—çš„å¤„ç†å¯¹è±¡ã€‚æ¯ä¸€ä¸ªå¤„ç†å¯¹è±¡å†³å®šå®ƒèƒ½å¤„ç†å“ªäº›å‘½ä»¤å¯¹è±¡ï¼Œå®ƒä¹ŸçŸ¥é“å¦‚ä½•å°†å®ƒä¸èƒ½å¤„ç†çš„å‘½ä»¤å¯¹è±¡ä¼ é€’ç»™è¯¥é“¾ä¸­çš„ä¸‹ä¸€ä¸ªå¤„ç†å¯¹è±¡ã€‚è¯¥æ¨¡å¼è¿˜æè¿°äº†å¾€è¯¥å¤„ç†é“¾çš„æœ«å°¾æ·»åŠ æ–°çš„å¤„ç†å¯¹è±¡çš„æ–¹æ³•ã€‚</p>
</blockquote>
<p>å¦å¤–å‚è€ƒæ–‡ç« ï¼š<a href="https://github.com/simple-android-framework-exchange/android_design_patterns_analysis/tree/master/chain-of-responsibility/AigeStudio#android%E6%BA%90%E7%A0%81%E4%B8%AD%E7%9A%84%E6%A8%A1%E5%BC%8F%E5%AE%9E%E7%8E%B0">Androidè®¾è®¡æ¨¡å¼ä¹‹è´£ä»»é“¾æ¨¡å¼</a>ä¸­ç›¸å…³çš„åˆ†æï¼š</p>
<blockquote>
<p>Androidä¸­å…³äºè´£ä»»é“¾æ¨¡å¼æ¯”è¾ƒæ˜æ˜¾çš„ä½“ç°å°±æ˜¯åœ¨äº‹ä»¶åˆ†å‘è¿‡ç¨‹ä¸­å¯¹äº‹ä»¶çš„æŠ•é€’ï¼Œå…¶å®ä¸¥æ ¼æ¥è¯´ï¼Œäº‹ä»¶æŠ•é€’çš„æ¨¡å¼å¹¶ä¸æ˜¯ä¸¥æ ¼çš„è´£ä»»é“¾æ¨¡å¼ï¼Œä½†æ˜¯å…¶æ˜¯è´£ä»»é“¾æ¨¡å¼çš„ä¸€ç§å˜ç§ä½“ç°ã€‚</p>
</blockquote>
<p>å¯¹äºæŠŠ <code>Request</code> å˜æˆ <code>Response</code> è¿™ä»¶äº‹æ¥è¯´ï¼Œæ¯ä¸ª <code>Interceptor</code> éƒ½å¯èƒ½å®Œæˆè¿™ä»¶äº‹ï¼Œæ‰€ä»¥æˆ‘ä»¬å¾ªç€é“¾æ¡è®©æ¯ä¸ª <code>Interceptor</code> è‡ªè¡Œå†³å®šèƒ½å¦å®Œæˆä»»åŠ¡ä»¥åŠæ€ä¹ˆå®Œæˆä»»åŠ¡ï¼ˆè‡ªåŠ›æ›´ç”Ÿæˆ–è€…äº¤ç»™ä¸‹ä¸€ä¸ª <code>Interceptor</code>ï¼‰ã€‚è¿™æ ·ä¸€æ¥ï¼Œå®Œæˆç½‘ç»œè¯·æ±‚è¿™ä»¶äº‹å°±å½»åº•ä» <code>RealCall</code> ç±»ä¸­å‰¥ç¦»äº†å‡ºæ¥ï¼Œç®€åŒ–äº†å„è‡ªçš„è´£ä»»å’Œé€»è¾‘ã€‚</p>
<p>æœ€ååœ¨èšåˆäº†è¿™äº›æ‹¦æˆªå™¨ä¹‹åï¼Œåˆ©ç”¨ <code>RealInterceptorChain</code> æ¥é“¾å¼è°ƒç”¨è¿™äº›æ‹¦æˆªå™¨ã€‚</p>
<h3 id="RealInterceptorChain"><a href="#RealInterceptorChain" class="headerlink" title="RealInterceptorChain"></a>RealInterceptorChain</h3><p><code>RealInterceptorChain</code> å¯ä»¥è¯´æ˜¯çœŸæ­£æŠŠè¿™äº›æ‹¦æˆªå™¨ä¸²èµ·æ¥çš„ä¸€ä¸ªè§’è‰²ã€‚ä¸€ä¸ªä¸ªæ‹¦æˆªå™¨å°±åƒä¸€é¢—é¢—ç å­ï¼Œè€Œ <code>RealInterceptorChain</code>å°±æ˜¯æŠŠè¿™äº›ç å­ä¸²è¿èµ·æ¥çš„é‚£æ ¹ç»³å­ã€‚</p>
<p>è¿›å…¥ <code>RealInterceptorChain</code> ï¼Œä¸»è¦æ˜¯ <code>proceed()</code> è¿™ä¸ªæ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span> </span><br><span class="line"><span class="function"><span class="keyword">public</span> Response <span class="title">proceed</span><span class="params">(Request request)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> proceed(request, streamAllocation, httpCodec, connection);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> Response <span class="title">proceed</span><span class="params">(Request request, StreamAllocation streamAllocation, HttpCodec httpCodec,</span></span></span><br><span class="line"><span class="function"><span class="params">  RealConnection connection)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (index &gt;= interceptors.size()) <span class="keyword">throw</span> <span class="keyword">new</span> AssertionError();</span><br><span class="line"></span><br><span class="line">	calls++;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// If we already have a stream, confirm that the incoming request will use it.</span></span><br><span class="line">	<span class="keyword">if</span> (<span class="keyword">this</span>.httpCodec != <span class="keyword">null</span> &amp;&amp; !<span class="keyword">this</span>.connection.supportsUrl(request.url())) &#123;</span><br><span class="line">	  <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"network interceptor "</span> + interceptors.get(index - <span class="number">1</span>)</span><br><span class="line">	      + <span class="string">" must retain the same host and port"</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// If we already have a stream, confirm that this is the only call to chain.proceed().</span></span><br><span class="line">	<span class="keyword">if</span> (<span class="keyword">this</span>.httpCodec != <span class="keyword">null</span> &amp;&amp; calls &gt; <span class="number">1</span>) &#123;</span><br><span class="line">	  <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"network interceptor "</span> + interceptors.get(index - <span class="number">1</span>)</span><br><span class="line">	      + <span class="string">" must call proceed() exactly once"</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// å¾—åˆ°ä¸‹ä¸€æ¬¡å¯¹åº”çš„ RealInterceptorChain</span></span><br><span class="line">	<span class="comment">// Call the next interceptor in the chain.</span></span><br><span class="line">	RealInterceptorChain next = <span class="keyword">new</span> RealInterceptorChain(interceptors, streamAllocation, httpCodec,</span><br><span class="line">	    connection, index + <span class="number">1</span>, request, call, eventListener, connectTimeout, readTimeout,</span><br><span class="line">	    writeTimeout);</span><br><span class="line">	<span class="comment">// å½“å‰çš„ interceptor</span></span><br><span class="line">	Interceptor interceptor = interceptors.get(index);</span><br><span class="line">	<span class="comment">// è¿›è¡Œæ‹¦æˆªå¤„ç†ï¼Œå¹¶ä¸”åœ¨ interceptor é“¾å¼è°ƒç”¨ next çš„ proceed æ–¹æ³•</span></span><br><span class="line">	Response response = interceptor.intercept(next);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Confirm that the next interceptor made its required call to chain.proceed().</span></span><br><span class="line">	<span class="keyword">if</span> (httpCodec != <span class="keyword">null</span> &amp;&amp; index + <span class="number">1</span> &lt; interceptors.size() &amp;&amp; next.calls != <span class="number">1</span>) &#123;</span><br><span class="line">	  <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"network interceptor "</span> + interceptor</span><br><span class="line">	      + <span class="string">" must call proceed() exactly once"</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Confirm that the intercepted response isn't null.</span></span><br><span class="line">	<span class="keyword">if</span> (response == <span class="keyword">null</span>) &#123;</span><br><span class="line">	  <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"interceptor "</span> + interceptor + <span class="string">" returned null"</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (response.body() == <span class="keyword">null</span>) &#123;</span><br><span class="line">	  <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(</span><br><span class="line">	      <span class="string">"interceptor "</span> + interceptor + <span class="string">" returned a response with no body"</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> response;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨ä»£ç ä¸­æ˜¯ä¸€æ¬¡æ¬¡é“¾å¼è°ƒç”¨æ‹¦æˆªå™¨ï¼Œ</p>
<ol>
<li>ä¸‹ä¸€ä¸ªæ‹¦æˆªå™¨å¯¹åº”çš„<code>RealIterceptorChain</code>å¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡ä¼šä¼ é€’ç»™å½“å‰çš„æ‹¦æˆªå™¨</li>
<li>å¾—åˆ°å½“å‰çš„æ‹¦æˆªå™¨ï¼šinterceptorsæ˜¯å­˜æ”¾æ‹¦æˆªå™¨çš„ArryList</li>
<li>è°ƒç”¨å½“å‰æ‹¦æˆªå™¨çš„<code>intercept()</code>æ–¹æ³•ï¼Œå¹¶å°†ä¸‹ä¸€ä¸ªæ‹¦æˆªå™¨çš„<code>RealIterceptorChain</code>å¯¹è±¡ä¼ é€’ä¸‹å»</li>
</ol>
<p>ç¤ºæ„å›¾å¦‚ä¸‹ï¼š</p>
<p><img src="https://raw.githubusercontent.com/iTimeTraveler/iTimeTraveler.github.io/master/gallery/android_common/20170722185657.png" alt=""></p>
<p>ä¸‹é¢æ ¹æ®ä¸Šé¢çš„è´£ä»»é“¾æˆ‘ä»¬é€ä¸ªåˆ†æä¸€ä¸‹å¯¹åº”çš„æ‹¦æˆªå™¨<code>Interceptor</code>ã€‚</p>
<h3 id="æ‹¦æˆªå™¨Interceptor"><a href="#æ‹¦æˆªå™¨Interceptor" class="headerlink" title="æ‹¦æˆªå™¨Interceptor"></a>æ‹¦æˆªå™¨Interceptor</h3><p>æ‹¦æˆªå™¨æ˜¯ OkHttp æä¾›çš„å¯¹ HTTP è¯·æ±‚å’Œå“åº”è¿›è¡Œç»Ÿä¸€å¤„ç†çš„å¼ºå¤§æœºåˆ¶ã€‚æ‹¦æˆªå™¨åœ¨å®ç°å’Œä½¿ç”¨ä¸Šç±»ä¼¼äº Servlet è§„èŒƒä¸­çš„è¿‡æ»¤å™¨ã€‚å¤šä¸ªæ‹¦æˆªå™¨å¯ä»¥é“¾æ¥èµ·æ¥ï¼Œå½¢æˆä¸€ä¸ªé“¾æ¡ã€‚æ‹¦æˆªå™¨ä¼šæŒ‰ç…§åœ¨é“¾æ¡ä¸Šçš„é¡ºåºä¾æ¬¡æ‰§è¡Œã€‚ æ‹¦æˆªå™¨åœ¨æ‰§è¡Œæ—¶ï¼Œå¯ä»¥å…ˆå¯¹è¯·æ±‚çš„ <code>Request</code> å¯¹è±¡è¿›è¡Œä¿®æ”¹ï¼›å†å¾—åˆ°å“åº”çš„ <code>Response</code> å¯¹è±¡ä¹‹åï¼Œå¯ä»¥è¿›è¡Œä¿®æ”¹ä¹‹åå†è¿”å›ã€‚</p>
<p>æ‹¦æˆªå™¨<code>Interceptor</code>æ¥å£å®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Interceptor</span> </span>&#123;</span><br><span class="line">	<span class="function">Response <span class="title">intercept</span><span class="params">(Chain chain)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">interface</span> <span class="title">Chain</span> </span>&#123;</span><br><span class="line">		<span class="function">Request <span class="title">request</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">		<span class="function">Response <span class="title">proceed</span><span class="params">(Request request)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/**</span></span><br><span class="line"><span class="comment">		 * Returns the connection the request will be executed on. This is only available in the chains</span></span><br><span class="line"><span class="comment">		 * of network interceptors; for application interceptors this is always null.</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		<span class="meta">@Nullable</span> <span class="function">Connection <span class="title">connection</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">		<span class="function">Call <span class="title">call</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">		<span class="function"><span class="keyword">int</span> <span class="title">connectTimeoutMillis</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">		<span class="function">Chain <span class="title">withConnectTimeout</span><span class="params">(<span class="keyword">int</span> timeout, TimeUnit unit)</span></span>;</span><br><span class="line"></span><br><span class="line">		<span class="function"><span class="keyword">int</span> <span class="title">readTimeoutMillis</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">		<span class="function">Chain <span class="title">withReadTimeout</span><span class="params">(<span class="keyword">int</span> timeout, TimeUnit unit)</span></span>;</span><br><span class="line"></span><br><span class="line">		<span class="function"><span class="keyword">int</span> <span class="title">writeTimeoutMillis</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">		<span class="function">Chain <span class="title">withWriteTimeout</span><span class="params">(<span class="keyword">int</span> timeout, TimeUnit unit)</span></span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>é™¤äº†åœ¨clientä¸­è‡ªå®šä¹‰è®¾ç½®çš„interceptor,ç¬¬ä¸€ä¸ªè°ƒç”¨çš„å°±æ˜¯<code>RetryAndFollowUpInterceptor</code></strong>ã€‚</p>
<h4 id="RetryAndFollowUpInterceptorï¼ˆé‡è¯•å’Œé‡å®šå‘æ‹¦æˆªå™¨ï¼‰"><a href="#RetryAndFollowUpInterceptorï¼ˆé‡è¯•å’Œé‡å®šå‘æ‹¦æˆªå™¨ï¼‰" class="headerlink" title="RetryAndFollowUpInterceptorï¼ˆé‡è¯•å’Œé‡å®šå‘æ‹¦æˆªå™¨ï¼‰"></a>RetryAndFollowUpInterceptorï¼ˆé‡è¯•å’Œé‡å®šå‘æ‹¦æˆªå™¨ï¼‰</h4><p>æˆ‘ä»¬ç€é‡çœ‹çœ‹å®ƒçš„<code>intercept()</code>æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span> </span><br><span class="line"><span class="function"><span class="keyword">public</span> Response <span class="title">intercept</span><span class="params">(Chain chain)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    Request request = chain.request();</span><br><span class="line">    RealInterceptorChain realChain = (RealInterceptorChain) chain;</span><br><span class="line">    Call call = realChain.call();</span><br><span class="line">    EventListener eventListener = realChain.eventListener();</span><br><span class="line"></span><br><span class="line">    streamAllocation = <span class="keyword">new</span> StreamAllocation(client.connectionPool(), createAddress(request.url()),</span><br><span class="line">        call, eventListener, callStackTrace);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> followUpCount = <span class="number">0</span>;</span><br><span class="line">    Response priorResponse = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">      <span class="comment">// å¦‚æœå–æ¶ˆï¼Œå°±é‡Šæ”¾èµ„æº</span></span><br><span class="line">      <span class="keyword">if</span> (canceled) &#123;</span><br><span class="line">        streamAllocation.release();</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"Canceled"</span>);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      Response response;</span><br><span class="line">      <span class="keyword">boolean</span> releaseConnection = <span class="keyword">true</span>;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// è°ƒç”¨ä¸‹ä¸€ä¸ªæ‹¦æˆªå™¨</span></span><br><span class="line">        response = realChain.proceed(request, streamAllocation, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">        releaseConnection = <span class="keyword">false</span>;</span><br><span class="line">      &#125; <span class="keyword">catch</span> (RouteException e) &#123;</span><br><span class="line">        <span class="comment">// The attempt to connect via a route failed. The request will not have been sent.</span></span><br><span class="line">        <span class="comment">// è·¯ç”±è¿æ¥å¤±è´¥ï¼Œè¯·æ±‚å°†ä¸ä¼šè¢«å‘é€</span></span><br><span class="line">        <span class="keyword">if</span> (!recover(e.getLastConnectException(), <span class="keyword">false</span>, request)) &#123;</span><br><span class="line">          <span class="keyword">throw</span> e.getLastConnectException();</span><br><span class="line">        &#125;</span><br><span class="line">        releaseConnection = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        <span class="comment">// An attempt to communicate with a server failed. The request may have been sent.</span></span><br><span class="line">        <span class="comment">// æœåŠ¡å™¨è¿æ¥å¤±è´¥ï¼Œè¯·æ±‚å¯èƒ½å·²è¢«å‘é€</span></span><br><span class="line">        <span class="keyword">boolean</span> requestSendStarted = !(e <span class="keyword">instanceof</span> ConnectionShutdownException);</span><br><span class="line">        <span class="keyword">if</span> (!recover(e, requestSendStarted, request)) <span class="keyword">throw</span> e;</span><br><span class="line">        releaseConnection = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">// We're throwing an unchecked exception. Release any resources.</span></span><br><span class="line">        <span class="comment">// æŠ›å‡ºæœªæ£€æŸ¥çš„å¼‚å¸¸ï¼Œé‡Šæ”¾èµ„æº</span></span><br><span class="line">        <span class="keyword">if</span> (releaseConnection) &#123;</span><br><span class="line">          streamAllocation.streamFailed(<span class="keyword">null</span>);</span><br><span class="line">          streamAllocation.release();</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Attach the prior response if it exists. Such responses never have a body.</span></span><br><span class="line">      <span class="keyword">if</span> (priorResponse != <span class="keyword">null</span>) &#123;</span><br><span class="line">        response = response.newBuilder()</span><br><span class="line">            .priorResponse(priorResponse.newBuilder()</span><br><span class="line">                    .body(<span class="keyword">null</span>)</span><br><span class="line">                    .build())</span><br><span class="line">            .build();</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// å¦‚æœä¸éœ€è¦é‡å®šå‘ï¼Œé‚£ä¹ˆ followUp ä¸ºç©ºï¼Œä¼šæ ¹æ®å“åº”ç åˆ¤æ–­</span></span><br><span class="line">      Request followUp = followUpRequest(response);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// é‡Šæ”¾èµ„æºï¼Œè¿”å› response</span></span><br><span class="line">      <span class="keyword">if</span> (followUp == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!forWebSocket) &#123;</span><br><span class="line">          streamAllocation.release();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> response;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// å…³é—­ response çš„ body</span></span><br><span class="line">      closeQuietly(response.body());</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (++followUpCount &gt; MAX_FOLLOW_UPS) &#123;</span><br><span class="line">        streamAllocation.release();</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ProtocolException(<span class="string">"Too many follow-up requests: "</span> + followUpCount);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (followUp.body() <span class="keyword">instanceof</span> UnrepeatableRequestBody) &#123;</span><br><span class="line">        streamAllocation.release();</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> HttpRetryException(<span class="string">"Cannot retry streamed HTTP body"</span>, response.code());</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// æ¯”è¾ƒresponse å’Œ followUp æ˜¯å¦ä¸ºåŒä¸€ä¸ªè¿æ¥</span></span><br><span class="line">      <span class="comment">// è‹¥ä¸ºé‡å®šå‘å°±é”€æ¯æ—§è¿æ¥ï¼Œåˆ›å»ºæ–°è¿æ¥</span></span><br><span class="line">      <span class="keyword">if</span> (!sameConnection(response, followUp.url())) &#123;</span><br><span class="line">        streamAllocation.release();</span><br><span class="line">        streamAllocation = <span class="keyword">new</span> StreamAllocation(client.connectionPool(),</span><br><span class="line">            createAddress(followUp.url()), call, eventListener, callStackTrace);</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (streamAllocation.codec() != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Closing the body of "</span> + response</span><br><span class="line">            + <span class="string">" didn't close its backing stream. Bad interceptor?"</span>);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// å°†é‡å®šå‘æ“ä½œå¾—åˆ°çš„æ–°è¯·æ±‚è®¾ç½®ç»™ request</span></span><br><span class="line">      request = followUp;</span><br><span class="line">      priorResponse = response;</span><br><span class="line">    &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>æ€»ä½“æ¥è¯´ï¼Œ<code>RetryAndFollowUpInterceptor</code> æ˜¯ç”¨æ¥å¤±è´¥é‡è¯•ä»¥åŠé‡å®šå‘çš„æ‹¦æˆªå™¨ã€‚</p>
<h4 id="BridgeInterceptorï¼ˆè¯·æ±‚æ„é€ æ‹¦æˆªå™¨ï¼‰"><a href="#BridgeInterceptorï¼ˆè¯·æ±‚æ„é€ æ‹¦æˆªå™¨ï¼‰" class="headerlink" title="BridgeInterceptorï¼ˆè¯·æ±‚æ„é€ æ‹¦æˆªå™¨ï¼‰"></a>BridgeInterceptorï¼ˆè¯·æ±‚æ„é€ æ‹¦æˆªå™¨ï¼‰</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span> </span><br><span class="line"><span class="function"><span class="keyword">public</span> Response <span class="title">intercept</span><span class="params">(Chain chain)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    Request userRequest = chain.request();</span><br><span class="line">    Request.Builder requestBuilder = userRequest.newBuilder();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å°†ç”¨æˆ·å‹å¥½çš„ request æ„é€ ä¸ºå‘é€ç»™æœåŠ¡å™¨çš„ request</span></span><br><span class="line">    RequestBody body = userRequest.body();</span><br><span class="line">    <span class="comment">// è‹¥æœ‰è¯·æ±‚ä½“ï¼Œåˆ™æ„é€ </span></span><br><span class="line">    <span class="keyword">if</span> (body != <span class="keyword">null</span>) &#123;</span><br><span class="line">      MediaType contentType = body.contentType();</span><br><span class="line">      <span class="keyword">if</span> (contentType != <span class="keyword">null</span>) &#123;</span><br><span class="line">        requestBuilder.header(<span class="string">"Content-Type"</span>, contentType.toString());</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">long</span> contentLength = body.contentLength();</span><br><span class="line">      <span class="keyword">if</span> (contentLength != -<span class="number">1</span>) &#123;</span><br><span class="line">        requestBuilder.header(<span class="string">"Content-Length"</span>, Long.toString(contentLength));</span><br><span class="line">        requestBuilder.removeHeader(<span class="string">"Transfer-Encoding"</span>);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        requestBuilder.header(<span class="string">"Transfer-Encoding"</span>, <span class="string">"chunked"</span>);</span><br><span class="line">        requestBuilder.removeHeader(<span class="string">"Content-Length"</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (userRequest.header(<span class="string">"Host"</span>) == <span class="keyword">null</span>) &#123;</span><br><span class="line">      requestBuilder.header(<span class="string">"Host"</span>, hostHeader(userRequest.url(), <span class="keyword">false</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Keep Alive</span></span><br><span class="line">    <span class="keyword">if</span> (userRequest.header(<span class="string">"Connection"</span>) == <span class="keyword">null</span>) &#123;</span><br><span class="line">      requestBuilder.header(<span class="string">"Connection"</span>, <span class="string">"Keep-Alive"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If we add an "Accept-Encoding: gzip" header field we're responsible for also decompressing</span></span><br><span class="line">    <span class="comment">// the transfer stream.</span></span><br><span class="line">    <span class="comment">// ä½¿ç”¨ gzip å‹ç¼©</span></span><br><span class="line">    <span class="keyword">boolean</span> transparentGzip = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (userRequest.header(<span class="string">"Accept-Encoding"</span>) == <span class="keyword">null</span> &amp;&amp; userRequest.header(<span class="string">"Range"</span>) == <span class="keyword">null</span>) &#123;</span><br><span class="line">      transparentGzip = <span class="keyword">true</span>;</span><br><span class="line">      requestBuilder.header(<span class="string">"Accept-Encoding"</span>, <span class="string">"gzip"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è®¾ç½® cookie</span></span><br><span class="line">    List&lt;Cookie&gt; cookies = cookieJar.loadForRequest(userRequest.url());</span><br><span class="line">    <span class="keyword">if</span> (!cookies.isEmpty()) &#123;</span><br><span class="line">      requestBuilder.header(<span class="string">"Cookie"</span>, cookieHeader(cookies));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// UA: User-Agent</span></span><br><span class="line">    <span class="keyword">if</span> (userRequest.header(<span class="string">"User-Agent"</span>) == <span class="keyword">null</span>) &#123;</span><br><span class="line">      requestBuilder.header(<span class="string">"User-Agent"</span>, Version.userAgent());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// æ„é€ å®Œåï¼Œå°† request äº¤ç»™ä¸‹ä¸€ä¸ªæ‹¦æˆªå™¨å»å¤„ç†ã€‚æœ€ååˆå¾—åˆ°æœåŠ¡ç«¯å“åº” networkResponse</span></span><br><span class="line">    Response networkResponse = chain.proceed(requestBuilder.build());</span><br><span class="line">    <span class="comment">// ä¿å­˜ networkResponse çš„ cookie</span></span><br><span class="line">    HttpHeaders.receiveHeaders(cookieJar, userRequest.url(), networkResponse.headers());</span><br><span class="line">    <span class="comment">// å°† networkResponse è½¬æ¢ä¸ºå¯¹ç”¨æˆ·å‹å¥½çš„ response</span></span><br><span class="line">    Response.Builder responseBuilder = networkResponse.newBuilder()</span><br><span class="line">        .request(userRequest);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// å¦‚æœ networkResponse ä½¿ç”¨ gzip å¹¶ä¸”æœ‰å“åº”ä½“çš„è¯ï¼Œç»™ç”¨æˆ·å‹å¥½çš„ response è®¾ç½®å“åº”ä½“</span></span><br><span class="line">    <span class="keyword">if</span> (transparentGzip</span><br><span class="line">        &amp;&amp; <span class="string">"gzip"</span>.equalsIgnoreCase(networkResponse.header(<span class="string">"Content-Encoding"</span>))</span><br><span class="line">        &amp;&amp; HttpHeaders.hasBody(networkResponse)) &#123;</span><br><span class="line">      GzipSource responseBody = <span class="keyword">new</span> GzipSource(networkResponse.body().source());</span><br><span class="line">      Headers strippedHeaders = networkResponse.headers().newBuilder()</span><br><span class="line">          .removeAll(<span class="string">"Content-Encoding"</span>)</span><br><span class="line">          .removeAll(<span class="string">"Content-Length"</span>)</span><br><span class="line">          .build();</span><br><span class="line">      responseBuilder.headers(strippedHeaders);</span><br><span class="line">      String contentType = networkResponse.header(<span class="string">"Content-Type"</span>);</span><br><span class="line">      responseBuilder.body(<span class="keyword">new</span> RealResponseBody(contentType, -<span class="number">1L</span>, Okio.buffer(responseBody)));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> responseBuilder.build();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨ <code>BridgeInterceptor</code> è¿™ä¸€æ­¥ï¼Œ</p>
<ul>
<li>å…ˆæŠŠç”¨æˆ·å‹å¥½çš„è¯·æ±‚è¿›è¡Œé‡æ–°æ„é€ ï¼Œå˜æˆäº†å‘æœåŠ¡å™¨å‘é€çš„è¯·æ±‚ã€‚</li>
<li>ä¹‹åè°ƒç”¨ <code>chain.proceed(requestBuilder.build())</code> è¿›è¡Œä¸‹ä¸€ä¸ªæ‹¦æˆªå™¨çš„å¤„ç†ã€‚</li>
<li>ç­‰åˆ°åé¢çš„æ‹¦æˆªå™¨éƒ½å¤„ç†å®Œæ¯•ï¼Œå¾—åˆ°å“åº”ã€‚å†æŠŠ <code>networkResponse</code> è½¬åŒ–æˆå¯¹ç”¨æˆ·å‹å¥½çš„ <code>response</code> ã€‚</li>
</ul>
<h4 id="CacheInterceptorï¼ˆç¼“å­˜æ‹¦æˆªå™¨ï¼‰"><a href="#CacheInterceptorï¼ˆç¼“å­˜æ‹¦æˆªå™¨ï¼‰" class="headerlink" title="CacheInterceptorï¼ˆç¼“å­˜æ‹¦æˆªå™¨ï¼‰"></a>CacheInterceptorï¼ˆç¼“å­˜æ‹¦æˆªå™¨ï¼‰</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span> </span><br><span class="line"><span class="function"><span class="keyword">public</span> Response <span class="title">intercept</span><span class="params">(Chain chain)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="comment">// å°è¯•ä»ç¼“å­˜ä¸­æŸ¥æ‰¾ request å¯¹åº”çš„ response</span></span><br><span class="line">    Response cacheCandidate = cache != <span class="keyword">null</span></span><br><span class="line">        ? cache.get(chain.request())</span><br><span class="line">        : <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è·å–å½“å‰æ—¶é—´ï¼Œä¼šå’Œä¹‹å‰ç¼“å­˜çš„æ—¶é—´è¿›è¡Œæ¯”è¾ƒ</span></span><br><span class="line">    <span class="keyword">long</span> now = System.currentTimeMillis();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¾—åˆ°ç¼“å­˜ç­–ç•¥</span></span><br><span class="line">    CacheStrategy strategy = <span class="keyword">new</span> CacheStrategy.Factory(now, chain.request(), cacheCandidate).get();</span><br><span class="line">    Request networkRequest = strategy.networkRequest;</span><br><span class="line">    Response cacheResponse = strategy.cacheResponse;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¿½è¸ªç¼“å­˜ï¼Œå…¶å®å°±æ˜¯è®¡æ•°</span></span><br><span class="line">    <span class="keyword">if</span> (cache != <span class="keyword">null</span>) &#123;</span><br><span class="line">      cache.trackResponse(strategy);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç¼“å­˜æœªå‘½ä¸­ï¼Œå…³é—­</span></span><br><span class="line">    <span class="keyword">if</span> (cacheCandidate != <span class="keyword">null</span> &amp;&amp; cacheResponse == <span class="keyword">null</span>) &#123;</span><br><span class="line">      closeQuietly(cacheCandidate.body()); <span class="comment">// The cache candidate wasn't applicable. Close it.</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If we're forbidden from using the network and the cache is insufficient, fail.</span></span><br><span class="line">    <span class="comment">// ç¦æ­¢ç½‘ç»œå¹¶ä¸”æ²¡æœ‰ç¼“å­˜çš„è¯ï¼Œè¿”å›å¤±è´¥</span></span><br><span class="line">    <span class="keyword">if</span> (networkRequest == <span class="keyword">null</span> &amp;&amp; cacheResponse == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> Response.Builder()</span><br><span class="line">          .request(chain.request())</span><br><span class="line">          .protocol(Protocol.HTTP_1_1)</span><br><span class="line">          .code(<span class="number">504</span>)</span><br><span class="line">          .message(<span class="string">"Unsatisfiable Request (only-if-cached)"</span>)</span><br><span class="line">          .body(Util.EMPTY_RESPONSE)</span><br><span class="line">          .sentRequestAtMillis(-<span class="number">1L</span>)</span><br><span class="line">          .receivedResponseAtMillis(System.currentTimeMillis())</span><br><span class="line">          .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If we don't need the network, we're done.</span></span><br><span class="line">    <span class="comment">// å‘½ä¸­ç¼“å­˜ã€‚ä¸”ä¸éœ€è¦ç½‘ç»œè¯·æ±‚æ›´æ–°ï¼Œè¿”å›ç¼“å­˜</span></span><br><span class="line">    <span class="keyword">if</span> (networkRequest == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> cacheResponse.newBuilder()</span><br><span class="line">          .cacheResponse(stripBody(cacheResponse))</span><br><span class="line">          .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Response networkResponse = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// äº¤ç»™ä¸‹ä¸€ä¸ªæ‹¦æˆªå™¨ï¼Œè¿”å› networkResponse</span></span><br><span class="line">      networkResponse = chain.proceed(networkRequest);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      <span class="comment">// If we're crashing on I/O or otherwise, don't leak the cache body.</span></span><br><span class="line">      <span class="keyword">if</span> (networkResponse == <span class="keyword">null</span> &amp;&amp; cacheCandidate != <span class="keyword">null</span>) &#123;</span><br><span class="line">        closeQuietly(cacheCandidate.body());</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If we have a cache response too, then we're doing a conditional get.</span></span><br><span class="line">    <span class="comment">// å¦‚æœæˆ‘ä»¬åŒæ—¶æœ‰ç¼“å­˜å’Œ networkResponse ï¼Œæ ¹æ®æƒ…å†µä½¿ç”¨</span></span><br><span class="line">    <span class="keyword">if</span> (cacheResponse != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (networkResponse.code() == HTTP_NOT_MODIFIED) &#123;</span><br><span class="line">        Response response = cacheResponse.newBuilder()</span><br><span class="line">            .headers(combine(cacheResponse.headers(), networkResponse.headers()))</span><br><span class="line">            .sentRequestAtMillis(networkResponse.sentRequestAtMillis())</span><br><span class="line">            .receivedResponseAtMillis(networkResponse.receivedResponseAtMillis())</span><br><span class="line">            .cacheResponse(stripBody(cacheResponse))</span><br><span class="line">            .networkResponse(stripBody(networkResponse))</span><br><span class="line">            .build();</span><br><span class="line">        networkResponse.body().close();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ›´æ–°åŸæ¥çš„ç¼“å­˜è‡³æœ€æ–°</span></span><br><span class="line">        <span class="comment">// Update the cache after combining headers but before stripping the</span></span><br><span class="line">        <span class="comment">// Content-Encoding header (as performed by initContentStream()).</span></span><br><span class="line">        cache.trackConditionalCacheHit();</span><br><span class="line">        cache.update(cacheResponse, response);</span><br><span class="line">        <span class="keyword">return</span> response;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        closeQuietly(cacheResponse.body());</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Response response = networkResponse.newBuilder()</span><br><span class="line">        .cacheResponse(stripBody(cacheResponse))</span><br><span class="line">        .networkResponse(stripBody(networkResponse))</span><br><span class="line">        .build();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¦‚æœä¹‹å‰ä»æœªè¿›è¡Œç¼“å­˜ï¼Œä¿å­˜ç¼“å­˜</span></span><br><span class="line">    <span class="keyword">if</span> (cache != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (HttpHeaders.hasBody(response) &amp;&amp; CacheStrategy.isCacheable(response, networkRequest)) &#123;</span><br><span class="line">        <span class="comment">// Offer this request to the cache.</span></span><br><span class="line">        CacheRequest cacheRequest = cache.put(response);</span><br><span class="line">        <span class="keyword">return</span> cacheWritingResponse(cacheRequest, response);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (HttpMethod.invalidatesCache(networkRequest.method())) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          cache.remove(networkRequest);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException ignored) &#123;</span><br><span class="line">          <span class="comment">// The cache cannot be written.</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> response;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>CacheInterceptor</code> åšçš„äº‹æƒ…å°±æ˜¯æ ¹æ®è¯·æ±‚æ‹¿åˆ°ç¼“å­˜ï¼Œè‹¥æ²¡æœ‰ç¼“å­˜æˆ–è€…ç¼“å­˜å¤±æ•ˆï¼Œå°±è¿›å…¥ç½‘ç»œè¯·æ±‚é˜¶æ®µï¼Œå¦åˆ™ä¼šè¿”å›ç¼“å­˜ã€‚</p>
<h4 id="ConnectInterceptor"><a href="#ConnectInterceptor" class="headerlink" title="ConnectInterceptor"></a>ConnectInterceptor</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span> </span><br><span class="line"><span class="function"><span class="keyword">public</span> Response <span class="title">intercept</span><span class="params">(Chain chain)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    RealInterceptorChain realChain = (RealInterceptorChain) chain;</span><br><span class="line">    Request request = realChain.request();</span><br><span class="line">    StreamAllocation streamAllocation = realChain.streamAllocation();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// We need the network to satisfy this request. Possibly for validating a conditional GET.</span></span><br><span class="line">    <span class="keyword">boolean</span> doExtensiveHealthChecks = !request.method().equals(<span class="string">"GET"</span>);</span><br><span class="line">    <span class="comment">// åˆ›å»º httpCodec ï¼ˆæŠ½è±¡ç±»ï¼‰ï¼Œåˆ†åˆ«å¯¹åº”ç€ http1.1 å’Œ http 2</span></span><br><span class="line">    HttpCodec httpCodec = streamAllocation.newStream(client, chain, doExtensiveHealthChecks);</span><br><span class="line">    RealConnection connection = streamAllocation.connection();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// äº¤ç»™ä¸‹ä¸€ä¸ªæ‹¦æˆªå™¨ï¼Œå¾—åˆ°è¿”å›çš„ Response</span></span><br><span class="line">    <span class="keyword">return</span> realChain.proceed(request, streamAllocation, httpCodec, connection);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å®é™…ä¸Šå»ºç«‹è¿æ¥å°±æ˜¯è°ƒç”¨äº† <code>streamAllocation.newStream</code> åˆ›å»ºäº†ä¸€ä¸ª <code>HttpCodec</code> å¯¹è±¡ï¼Œå®ƒå°†åœ¨åé¢çš„æ­¥éª¤ä¸­è¢«ä½¿ç”¨ï¼Œé‚£å®ƒåˆæ˜¯ä½•æ–¹ç¥åœ£å‘¢ï¼Ÿå®ƒæ˜¯å¯¹ HTTP åè®®æ“ä½œçš„æŠ½è±¡ï¼Œæœ‰ä¸¤ä¸ªå®ç°ï¼š<code>Http1Codec</code> å’Œ <code>Http2Codec</code>ï¼Œé¡¾åæ€ä¹‰ï¼Œå®ƒä»¬åˆ†åˆ«å¯¹åº” HTTP/1.1 å’Œ HTTP/2 ç‰ˆæœ¬çš„å®ç°ã€‚</p>
<p>åœ¨ <code>Http1Codec</code> ä¸­ï¼Œå®ƒåˆ©ç”¨ <a href="https://github.com/square/okio/">Okio</a> å¯¹ <code>Socket</code> çš„è¯»å†™æ“ä½œè¿›è¡Œå°è£…ï¼ŒOkio ä»¥åæœ‰æœºä¼šå†è¿›è¡Œåˆ†æï¼Œç°åœ¨è®©æˆ‘ä»¬å¯¹å®ƒä»¬ä¿æŒä¸€ä¸ªç®€å•åœ°è®¤è¯†ï¼šå®ƒå¯¹ <code>java.io</code> å’Œ <code>java.nio</code> è¿›è¡Œäº†å°è£…ï¼Œè®©æˆ‘ä»¬æ›´ä¾¿æ·é«˜æ•ˆçš„è¿›è¡Œ IO æ“ä½œã€‚</p>
<p>è€Œåˆ›å»º <code>HttpCodec</code> å¯¹è±¡çš„è¿‡ç¨‹æ¶‰åŠåˆ° <code>StreamAllocation</code>ã€<code>RealConnection</code>ï¼Œä»£ç è¾ƒé•¿ï¼Œè¿™é‡Œå°±ä¸å±•å¼€ï¼Œè¿™ä¸ªè¿‡ç¨‹æ¦‚æ‹¬æ¥è¯´ï¼Œå°±æ˜¯æ‰¾åˆ°ä¸€ä¸ªå¯ç”¨çš„ <code>RealConnection</code>ï¼Œå†åˆ©ç”¨ <code>RealConnection</code> çš„è¾“å…¥è¾“å‡ºï¼ˆ<code>BufferedSource</code> å’Œ <code>BufferedSink</code>ï¼‰åˆ›å»º <code>HttpCodec</code> å¯¹è±¡ï¼Œä¾›åç»­æ­¥éª¤ä½¿ç”¨ã€‚</p>
<p>æˆ‘ä»¬æ¥çœ‹ä¸‹ <code>streamAllocation.newStream()</code> çš„ä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä½äºStreamAllocationç±»</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> HttpCodec <span class="title">newStream</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">      OkHttpClient client, Interceptor.Chain chain, <span class="keyword">boolean</span> doExtensiveHealthChecks)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> connectTimeout = chain.connectTimeoutMillis();</span><br><span class="line">    <span class="keyword">int</span> readTimeout = chain.readTimeoutMillis();</span><br><span class="line">    <span class="keyword">int</span> writeTimeout = chain.writeTimeoutMillis();</span><br><span class="line">    <span class="keyword">boolean</span> connectionRetryEnabled = client.retryOnConnectionFailure();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// åœ¨è¿æ¥æ± ä¸­æ‰¾åˆ°ä¸€ä¸ªå¯ç”¨çš„è¿æ¥ï¼Œç„¶ååˆ›å»ºå‡º HttpCodec å¯¹è±¡</span></span><br><span class="line">      RealConnection resultConnection = findHealthyConnection(connectTimeout, readTimeout,</span><br><span class="line">          writeTimeout, connectionRetryEnabled, doExtensiveHealthChecks);</span><br><span class="line">      HttpCodec resultCodec = resultConnection.newCodec(client, chain, <span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">synchronized</span> (connectionPool) &#123;</span><br><span class="line">        codec = resultCodec;</span><br><span class="line">        <span class="keyword">return</span> resultCodec;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> RouteException(e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>findHealthyConnection()</code>ï¼šå…ˆåœ¨è¿æ¥æ± ä¸­æ‰¾åˆ°å¯ç”¨çš„è¿æ¥ <code>resultConnection</code> ã€‚<br>  è¿™ä¸€æ­¥ä¼šä½¿ç”¨<code>Platform.get().connectSocket()</code>åˆ›å»ºTCPè¿æ¥ï¼Œå®Œæˆä¸‰æ¬¡æ¡æ‰‹ã€‚</li>
<li><p><code>resultConnection.newCodec()</code>ï¼šå†ç»“åˆ <code>sink</code> å’Œ <code>source</code> åˆ›å»ºå‡º <code>HttpCodec</code> çš„å¯¹è±¡ã€‚</p>
<p><code>HttpCodec</code> è´Ÿè´£å¯¹HTTPè¯·æ±‚å’Œå“åº”è¿›è¡Œç¼–è§£ç ã€‚æ³¨é‡Šå¦‚ä¸‹ï¼š</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** Encodes HTTP requests and decodes HTTP responses. */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">HttpCodec</span> </span>&#123; ... &#125;</span><br></pre></td></tr></table></figure>
<h4 id="CallServerInterceptor"><a href="#CallServerInterceptor" class="headerlink" title="CallServerInterceptor"></a>CallServerInterceptor</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span> </span><br><span class="line"><span class="function"><span class="keyword">public</span> Response <span class="title">intercept</span><span class="params">(Chain chain)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    RealInterceptorChain realChain = (RealInterceptorChain) chain;</span><br><span class="line">    HttpCodec httpCodec = realChain.httpStream();</span><br><span class="line">    StreamAllocation streamAllocation = realChain.streamAllocation();</span><br><span class="line">    RealConnection connection = (RealConnection) realChain.connection();</span><br><span class="line">    Request request = realChain.request();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">long</span> sentRequestMillis = System.currentTimeMillis();</span><br><span class="line"></span><br><span class="line">    realChain.eventListener().requestHeadersStart(realChain.call());</span><br><span class="line">    <span class="comment">// æ•´ç†è¯·æ±‚å¤´å¹¶å†™å…¥</span></span><br><span class="line">    httpCodec.writeRequestHeaders(request);</span><br><span class="line">    realChain.eventListener().requestHeadersEnd(realChain.call(), request);</span><br><span class="line"></span><br><span class="line">    Response.Builder responseBuilder = <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">// æ£€æŸ¥æ˜¯å¦ä¸ºæœ‰ body çš„è¯·æ±‚æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">if</span> (HttpMethod.permitsRequestBody(request.method()) &amp;&amp; request.body() != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="comment">// If there's a "Expect: 100-continue" header on the request, wait for a "HTTP/1.1 100</span></span><br><span class="line">      <span class="comment">// Continue" response before transmitting the request body. If we don't get that, return</span></span><br><span class="line">      <span class="comment">// what we did get (such as a 4xx response) without ever transmitting the request body.</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="string">"100-continue"</span>.equalsIgnoreCase(request.header(<span class="string">"Expect"</span>))) &#123;</span><br><span class="line">        httpCodec.flushRequest();</span><br><span class="line">        realChain.eventListener().responseHeadersStart(realChain.call());</span><br><span class="line">        responseBuilder = httpCodec.readResponseHeaders(<span class="keyword">true</span>);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (responseBuilder == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// Write the request body if the "Expect: 100-continue" expectation was met.</span></span><br><span class="line">        <span class="comment">// å†™å…¥è¯·æ±‚ä½“ request body</span></span><br><span class="line">        realChain.eventListener().requestBodyStart(realChain.call());</span><br><span class="line">        <span class="keyword">long</span> contentLength = request.body().contentLength();</span><br><span class="line">        CountingSink requestBodyOut =</span><br><span class="line">            <span class="keyword">new</span> CountingSink(httpCodec.createRequestBody(request, contentLength));</span><br><span class="line">        BufferedSink bufferedRequestBody = Okio.buffer(requestBodyOut);</span><br><span class="line"></span><br><span class="line">        request.body().writeTo(bufferedRequestBody);</span><br><span class="line">        bufferedRequestBody.close();</span><br><span class="line">        realChain.eventListener()</span><br><span class="line">            .requestBodyEnd(realChain.call(), requestBodyOut.successfulCount);</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!connection.isMultiplexed()) &#123;</span><br><span class="line">        <span class="comment">// If the "Expect: 100-continue" expectation wasn't met, prevent the HTTP/1 connection</span></span><br><span class="line">        <span class="comment">// from being reused. Otherwise we're still obligated to transmit the request body to</span></span><br><span class="line">        <span class="comment">// leave the connection in a consistent state.</span></span><br><span class="line">        streamAllocation.noNewStreams();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    httpCodec.finishRequest();</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// å¾—åˆ°å“åº”å¤´</span></span><br><span class="line">    <span class="keyword">if</span> (responseBuilder == <span class="keyword">null</span>) &#123;</span><br><span class="line">      realChain.eventListener().responseHeadersStart(realChain.call());</span><br><span class="line">      responseBuilder = httpCodec.readResponseHeaders(<span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ„é€  response</span></span><br><span class="line">    Response response = responseBuilder</span><br><span class="line">        .request(request)</span><br><span class="line">        .handshake(streamAllocation.connection().handshake())</span><br><span class="line">        .sentRequestAtMillis(sentRequestMillis)</span><br><span class="line">        .receivedResponseAtMillis(System.currentTimeMillis())</span><br><span class="line">        .build();</span><br><span class="line"></span><br><span class="line">    realChain.eventListener()</span><br><span class="line">        .responseHeadersEnd(realChain.call(), response);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> code = response.code();</span><br><span class="line">    <span class="comment">// å¦‚æœä¸º web socket ä¸”çŠ¶æ€ç æ˜¯ 101 ï¼Œé‚£ä¹ˆ body ä¸ºç©º</span></span><br><span class="line">    <span class="keyword">if</span> (forWebSocket &amp;&amp; code == <span class="number">101</span>) &#123;</span><br><span class="line">      <span class="comment">// Connection is upgrading, but we need to ensure interceptors see a non-null response body.</span></span><br><span class="line">      response = response.newBuilder()</span><br><span class="line">          .body(Util.EMPTY_RESPONSE)</span><br><span class="line">          .build();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// è¯»å– body</span></span><br><span class="line">      response = response.newBuilder()</span><br><span class="line">          .body(httpCodec.openResponseBody(response))</span><br><span class="line">          .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¦‚æœè¯·æ±‚å¤´ä¸­æœ‰ close é‚£ä¹ˆæ–­å¼€è¿æ¥</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="string">"close"</span>.equalsIgnoreCase(response.request().header(<span class="string">"Connection"</span>))</span><br><span class="line">        || <span class="string">"close"</span>.equalsIgnoreCase(response.header(<span class="string">"Connection"</span>))) &#123;</span><br><span class="line">      streamAllocation.noNewStreams();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æŠ›å‡ºåè®®å¼‚å¸¸</span></span><br><span class="line">    <span class="keyword">if</span> ((code == <span class="number">204</span> || code == <span class="number">205</span>) &amp;&amp; response.body().contentLength() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> ProtocolException(</span><br><span class="line">          <span class="string">"HTTP "</span> + code + <span class="string">" had non-zero Content-Length: "</span> + response.body().contentLength());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> response;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨ <code>CallServerInterceptor</code> ä¸­å¯è§ï¼Œå…³äºè¯·æ±‚å’Œå“åº”éƒ¨åˆ†éƒ½æ˜¯é€šè¿‡ <code>HttpCodec</code> æ¥å®ç°çš„ã€‚è€Œåœ¨ <code>HttpCodec</code> å†…éƒ¨åˆæ˜¯é€šè¿‡ <code>sink</code> å’Œ <code>source</code> æ¥å®ç°çš„ã€‚æ‰€ä»¥è¯´åˆ°åº•è¿˜æ˜¯ IO æµåœ¨èµ·ä½œç”¨ã€‚</p>
<p>ä¸Šé¢çš„æµç¨‹æˆ‘ä»¬æŠ“ä½ä¸»å¹²éƒ¨åˆ†ï¼š</p>
<ol>
<li>å‘æœåŠ¡å™¨å‘é€ request headerï¼›</li>
<li>å¦‚æœæœ‰ request bodyï¼Œå°±å‘æœåŠ¡å™¨å‘é€ï¼›</li>
<li>è¯»å– response headerï¼Œå…ˆæ„é€ ä¸€ä¸ª <code>Response</code> å¯¹è±¡ï¼›</li>
<li>å¦‚æœæœ‰ response bodyï¼Œå°±åœ¨ 3 çš„åŸºç¡€ä¸ŠåŠ ä¸Š body æ„é€ ä¸€ä¸ªæ–°çš„ <code>Response</code> å¯¹è±¡ï¼›</li>
</ol>
<p>è¿™é‡Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œæ ¸å¿ƒå·¥ä½œéƒ½ç”± <code>HttpCodec</code> å¯¹è±¡å®Œæˆï¼Œè€Œ <code>HttpCodec</code> å®é™…ä¸Šåˆ©ç”¨çš„æ˜¯ Okioï¼Œè€Œ Okio å®é™…ä¸Šè¿˜æ˜¯ç”¨çš„ <code>Socket</code>ï¼Œæ‰€ä»¥æ²¡ä»€ä¹ˆç¥ç§˜çš„ï¼Œåªä¸è¿‡ä¸€å±‚å¥—ä¸€å±‚ï¼Œå±‚æ•°æœ‰ç‚¹å¤šã€‚</p>
<h4 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h4><p>å…¶å® <code>Interceptor</code> çš„è®¾è®¡ä¹Ÿæ˜¯ä¸€ç§åˆ†å±‚çš„æ€æƒ³ï¼Œæ¯ä¸ª <code>Interceptor</code> å°±æ˜¯ä¸€å±‚ã€‚ä¸ºä»€ä¹ˆè¦å¥—è¿™ä¹ˆå¤šå±‚å‘¢ï¼Ÿåˆ†å±‚çš„æ€æƒ³åœ¨ TCP/IP åè®®ä¸­å°±ä½“ç°å¾—æ·‹æ¼“å°½è‡´ï¼Œåˆ†å±‚ç®€åŒ–äº†æ¯ä¸€å±‚çš„é€»è¾‘ï¼Œæ¯å±‚åªéœ€è¦å…³æ³¨è‡ªå·±çš„è´£ä»»ï¼ˆå•ä¸€åŸåˆ™æ€æƒ³ä¹Ÿåœ¨æ­¤ä½“ç°ï¼‰ï¼Œè€Œå„å±‚ä¹‹é—´é€šè¿‡çº¦å®šçš„æ¥å£/åè®®è¿›è¡Œåˆä½œï¼ˆé¢å‘æ¥å£ç¼–ç¨‹æ€æƒ³ï¼‰ï¼Œå…±åŒå®Œæˆå¤æ‚çš„ä»»åŠ¡ã€‚</p>
<p>åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬ä¹Ÿå®Œå…¨æ˜ç™½äº† OkHttp ä¸­çš„åˆ†å±‚æ€æƒ³ï¼Œæ¯ä¸€ä¸ª interceptor åªå¤„ç†è‡ªå·±çš„äº‹ï¼Œè€Œå‰©ä½™çš„å°±äº¤ç»™å…¶ä»–çš„ interceptor ã€‚è¿™ç§æ€æƒ³å¯ä»¥ç®€åŒ–ä¸€äº›ç¹çå¤æ‚çš„æµç¨‹ï¼Œä»è€Œè¾¾åˆ°é€»è¾‘æ¸…æ™°ã€äº’ä¸å¹²æ‰°çš„æ•ˆæœã€‚</p>
<h2 id="å¼‚æ­¥è¯·æ±‚"><a href="#å¼‚æ­¥è¯·æ±‚" class="headerlink" title="å¼‚æ­¥è¯·æ±‚"></a>å¼‚æ­¥è¯·æ±‚</h2><p>ä¸åŒæ­¥è¯·æ±‚ç›´æ¥è°ƒç”¨<strong>RealCall</strong>çš„ <code>execute()</code> æ–¹æ³•ä¸åŒçš„æ˜¯ï¼Œå¼‚æ­¥è¯·æ±‚æ˜¯è°ƒç”¨äº† <code>enqueue(Callback responseCallback)</code> è¿™ä¸ªæ–¹æ³•ã€‚é‚£ä¹ˆæˆ‘ä»¬å¯¹å¼‚æ­¥è¯·æ±‚æ¢ç©¶çš„å…¥å£å°±æ˜¯ <code>enqueue(Callback responseCallback)</code> äº†ã€‚</p>
<h3 id="RealCall-1"><a href="#RealCall-1" class="headerlink" title="RealCall"></a>RealCall</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">enqueue</span><span class="params">(Callback responseCallback)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (executed) <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Already Executed"</span>);</span><br><span class="line">        executed = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    captureCallStackTrace();</span><br><span class="line">    eventListener.callStart(<span class="keyword">this</span>);</span><br><span class="line">    <span class="comment">// åŠ å…¥åˆ° dispatcher ä¸­ï¼Œè¿™é‡ŒåŒ…è£…æˆäº† AsyncCall</span></span><br><span class="line">    client.dispatcher().enqueue(<span class="keyword">new</span> AsyncCall(responseCallback));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸»è¦çš„æ–¹æ³•å°±æ˜¯è°ƒç”¨äº† <code>Dispatcher</code> çš„ <code>enqueue(AsyncCall call)</code> æ–¹æ³•ã€‚è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä¼ å…¥çš„æ˜¯ <code>AsyncCall</code> å¯¹è±¡ï¼Œè€Œä¸æ˜¯åŒæ­¥ä¸­çš„ <code>RealCall</code> ã€‚</p>
<h3 id="Dispatcher"><a href="#Dispatcher" class="headerlink" title="Dispatcher"></a>Dispatcher</h3><p>æˆ‘ä»¬è·Ÿè¿›åˆ° <code>Dispatcher</code> çš„æºç ï¼Œè‡³äº <code>AsyncCall</code> æˆ‘ä»¬ä¼šåœ¨ä¸‹é¢è¯¦ç»†è®²åˆ°ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">enqueue</span><span class="params">(AsyncCall call)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// å¦‚æœå½“å‰æ­£åœ¨è¿è¡Œçš„å¼‚æ­¥ call æ•° &lt; 64 &amp;&amp; é˜Ÿåˆ—ä¸­è¯·æ±‚åŒä¸€ä¸ª host çš„å¼‚æ­¥ call æ•° &lt; 5</span></span><br><span class="line">    <span class="comment">// maxRequests = 64ï¼ŒmaxRequestsPerHost = 5</span></span><br><span class="line">	<span class="keyword">if</span> (runningAsyncCalls.size() &lt; maxRequests &amp;&amp; runningCallsForHost(call) &lt; maxRequestsPerHost) &#123;</span><br><span class="line">      <span class="comment">// åŠ å…¥æ­£åœ¨è¿è¡Œå¼‚æ­¥é˜Ÿåˆ—</span></span><br><span class="line">	  runningAsyncCalls.add(call);</span><br><span class="line">      <span class="comment">// åŠ å…¥åˆ°çº¿ç¨‹æ± ä¸­</span></span><br><span class="line">	  executorService().execute(call);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// åŠ å…¥é¢„å¤‡ç­‰å¾…çš„å¼‚æ­¥é˜Ÿåˆ—</span></span><br><span class="line">	  readyAsyncCalls.add(call);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ›å»ºçº¿ç¨‹æ± </span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> ExecutorService <span class="title">executorService</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (executorService == <span class="keyword">null</span>) &#123;</span><br><span class="line">        executorService = <span class="keyword">new</span> ThreadPoolExecutor(<span class="number">0</span>, Integer.MAX_VALUE, <span class="number">60</span>, TimeUnit.SECONDS,</span><br><span class="line">                <span class="keyword">new</span> SynchronousQueue&lt;Runnable&gt;(), Util.threadFactory(<span class="string">"OkHttp Dispatcher"</span>, <span class="keyword">false</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> executorService;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä» <code>enqueue(AsyncCall call)</code> ä¸­å¯ä»¥çŸ¥é“ï¼ŒOkHttp åœ¨è¿è¡Œä¸­çš„å¼‚æ­¥è¯·æ±‚æ•°æœ€å¤šä¸º 63 ï¼Œè€ŒåŒä¸€ä¸ª host çš„å¼‚æ­¥è¯·æ±‚æ•°æœ€å¤šä¸º 4 ã€‚å¦åˆ™ä¼šåŠ å…¥åˆ° <code>readyAsyncCalls</code> ä¸­ã€‚</p>
<p>åœ¨åŠ å…¥åˆ° <code>runningAsyncCalls</code> åï¼Œå°±ä¼šè¿›å…¥çº¿ç¨‹æ± ä¸­è¢«æ‰§è¡Œã€‚åˆ°äº†è¿™é‡Œï¼Œæˆ‘ä»¬å°±è¦åˆ° <code>AsyncCall</code> ä¸­ä¸€æ¢ç©¶ç«Ÿäº†ã€‚</p>
<h3 id="AsyncCall"><a href="#AsyncCall" class="headerlink" title="AsyncCall"></a>AsyncCall</h3><p><code>AsyncCall</code>æ˜¯<strong>RealCall</strong>ç±»ä¸­çš„å†…éƒ¨ç±»ï¼Œå®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">AsyncCall</span> <span class="keyword">extends</span> <span class="title">NamedRunnable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Callback responseCallback;</span><br><span class="line"></span><br><span class="line">    AsyncCall(Callback responseCallback) &#123;</span><br><span class="line">        <span class="keyword">super</span>(<span class="string">"OkHttp %s"</span>, redactedUrl());</span><br><span class="line">        <span class="keyword">this</span>.responseCallback = responseCallback;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">String <span class="title">host</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> originalRequest.url().host();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">Request <span class="title">request</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> originalRequest;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">RealCall <span class="title">get</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> RealCall.<span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">boolean</span> signalledCallback = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// è°ƒç”¨ä¸€è¿ä¸²çš„æ‹¦æˆªå™¨ï¼Œå¾—åˆ°å“åº”</span></span><br><span class="line">            Response response = getResponseWithInterceptorChain();</span><br><span class="line">            <span class="keyword">if</span> (retryAndFollowUpInterceptor.isCanceled()) &#123;</span><br><span class="line">                <span class="comment">// å›è°ƒå¤±è´¥</span></span><br><span class="line">                signalledCallback = <span class="keyword">true</span>;</span><br><span class="line">                responseCallback.onFailure(RealCall.<span class="keyword">this</span>, <span class="keyword">new</span> IOException(<span class="string">"Canceled"</span>));</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// å›è°ƒç»“æœ</span></span><br><span class="line">                signalledCallback = <span class="keyword">true</span>;</span><br><span class="line">                responseCallback.onResponse(RealCall.<span class="keyword">this</span>, response);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="keyword">if</span> (signalledCallback) &#123;</span><br><span class="line">                <span class="comment">// Do not signal the callback twice!</span></span><br><span class="line">                Platform.get().log(INFO, <span class="string">"Callback failure for "</span> + toLoggableString(), e);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// å›è°ƒå¤±è´¥</span></span><br><span class="line">                eventListener.callFailed(RealCall.<span class="keyword">this</span>, e);</span><br><span class="line">                responseCallback.onFailure(RealCall.<span class="keyword">this</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">// åœ¨ runningAsyncCalls ä¸­ç§»é™¤ï¼Œå¹¶æ¨è¿›å…¶ä»– call çš„å·¥ä½œ</span></span><br><span class="line">            client.dispatcher().finished(<span class="keyword">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨ <code>AsyncCall</code> çš„ <code>execute()</code> æ–¹æ³•ä¸­ï¼Œä¹Ÿæ˜¯è°ƒç”¨äº† <code>getResponseWithInterceptorChain()</code> æ–¹æ³•æ¥å¾—åˆ° <code>Response</code> å¯¹è±¡ã€‚ä»è¿™é‡Œå¼€å§‹ï¼Œå°±å’ŒåŒæ­¥è¯·æ±‚çš„æµç¨‹æ˜¯ä¸€æ ·çš„ï¼Œå°±æ²¡å¿…è¦è®²äº†ã€‚</p>
<p>åœ¨å¾—åˆ° <code>Response</code> åï¼Œè¿›è¡Œç»“æœçš„å›è°ƒã€‚æœ€åï¼Œè°ƒç”¨äº† <code>Dispatcher</code> çš„ <code>finished</code> æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Dispatcherç±»</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">finished</span><span class="params">(RealCall.AsyncCall call)</span> </span>&#123;</span><br><span class="line">    finished(runningAsyncCalls, call, <span class="keyword">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> &lt;T&gt; <span class="function"><span class="keyword">void</span> <span class="title">finished</span><span class="params">(Deque&lt;T&gt; calls, T call, <span class="keyword">boolean</span> promoteCalls)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> runningCallsCount;</span><br><span class="line">    Runnable idleCallback;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="comment">// ç§»é™¤è¯¥ call</span></span><br><span class="line">        <span class="keyword">if</span> (!calls.remove(call)) <span class="keyword">throw</span> <span class="keyword">new</span> AssertionError(<span class="string">"Call wasn't in-flight!"</span>);</span><br><span class="line">        <span class="comment">// å°† readyAsyncCalls ä¸­çš„ call ç§»åŠ¨åˆ° runningAsyncCalls ä¸­ï¼Œå¹¶åŠ å…¥åˆ°çº¿ç¨‹æ± ä¸­</span></span><br><span class="line">        <span class="keyword">if</span> (promoteCalls) promoteCalls();</span><br><span class="line">        runningCallsCount = runningCallsCount();</span><br><span class="line">        idleCallback = <span class="keyword">this</span>.idleCallback;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (runningCallsCount == <span class="number">0</span> &amp;&amp; idleCallback != <span class="keyword">null</span>) &#123;</span><br><span class="line">        idleCallback.run();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>OkHttp ä½œä¸ºä¸€ä¸ªç®€æ´é«˜æ•ˆçš„ HTTP å®¢æˆ·ç«¯ï¼Œå¯ä»¥åœ¨ Java å’Œ Android ç¨‹åºä¸­ä½¿ç”¨ã€‚ç›¸å¯¹äº Apache HttpClient æ¥è¯´ï¼ŒOkHttp çš„æ€§èƒ½æ›´å¥½ï¼Œå…¶ API è®¾è®¡ä¹Ÿæ›´åŠ ç®€å•å®ç”¨ã€‚</p>
<p>åœ¨æ–‡ç« æœ€åæˆ‘ä»¬å†æ¥å›é¡¾ä¸€ä¸‹å®Œæ•´çš„æµç¨‹å›¾ï¼š</p>
<p><img src="https://raw.githubusercontent.com/iTimeTraveler/iTimeTraveler.github.io/master/gallery/android_common/okhttp_full_process.png" alt=""></p>
<ul>
<li><code>OkHttpClient</code> å®ç° <code>Call.Factory</code>ï¼Œè´Ÿè´£ä¸º <code>Request</code> åˆ›å»º <code>Call</code>ï¼›</li>
<li><code>RealCall</code> ä¸ºå…·ä½“çš„ <code>Call</code> å®ç°ï¼Œå…¶ <code>enqueue()</code> å¼‚æ­¥æ¥å£é€šè¿‡ <code>Dispatcher</code> åˆ©ç”¨ <code>ExecutorService</code> å®ç°ï¼Œè€Œæœ€ç»ˆè¿›è¡Œç½‘ç»œè¯·æ±‚æ—¶å’ŒåŒæ­¥ <code>execute()</code> æ¥å£ä¸€è‡´ï¼Œéƒ½æ˜¯é€šè¿‡ <code>getResponseWithInterceptorChain()</code> å‡½æ•°å®ç°ï¼›</li>
<li><code>getResponseWithInterceptorChain()</code> ä¸­åˆ©ç”¨ <code>Interceptor</code> é“¾æ¡ï¼Œåˆ†å±‚å®ç°é‡è¯•é‡å®šå‘ã€ç¼“å­˜ã€é€æ˜å‹ç¼©ã€ç½‘ç»œ IO ç­‰åŠŸèƒ½ï¼›</li>
</ul>
<h2 id="HTTP-è¿æ¥"><a href="#HTTP-è¿æ¥" class="headerlink" title="HTTP è¿æ¥"></a>HTTP è¿æ¥</h2><p>è™½ç„¶åœ¨ä½¿ç”¨ OkHttp å‘é€ HTTP è¯·æ±‚æ—¶åªéœ€è¦æä¾› URL å³å¯ï¼ŒOkHttp åœ¨å®ç°ä¸­éœ€è¦ç»¼åˆè€ƒè™‘ 3 ç§ä¸åŒçš„è¦ç´ æ¥ç¡®å®šä¸ HTTP æœåŠ¡å™¨ä¹‹é—´å®é™…å»ºç«‹çš„ HTTP è¿æ¥ã€‚è¿™æ ·åšçš„ç›®çš„æ˜¯ä¸ºäº†è¾¾åˆ°æœ€ä½³çš„æ€§èƒ½ã€‚</p>
<p>é¦–å…ˆç¬¬ä¸€ä¸ªè€ƒè™‘çš„è¦ç´ æ˜¯ URL æœ¬èº«ã€‚URL ç»™å‡ºäº†è¦è®¿é—®çš„èµ„æºçš„è·¯å¾„ã€‚æ¯”å¦‚ URL <a href="http://www.baidu.com" target="_blank" rel="noopener">http://www.baidu.com</a> æ‰€å¯¹åº”çš„æ˜¯ç™¾åº¦é¦–é¡µçš„ HTTP æ–‡æ¡£ã€‚åœ¨ URL ä¸­æ¯”è¾ƒé‡è¦çš„éƒ¨åˆ†æ˜¯è®¿é—®æ—¶ä½¿ç”¨çš„æ¨¡å¼ï¼Œå³ HTTP è¿˜æ˜¯ HTTPSã€‚è¿™ä¼šç¡®å®š OkHttp æ‰€å»ºç«‹çš„æ˜¯æ˜æ–‡çš„ HTTP è¿æ¥ï¼Œè¿˜æ˜¯åŠ å¯†çš„ HTTPS è¿æ¥ã€‚</p>
<p>ç¬¬äºŒä¸ªè¦ç´ æ˜¯ HTTP æœåŠ¡å™¨çš„åœ°å€ï¼Œå¦‚ baidu.comã€‚æ¯ä¸ªåœ°å€éƒ½æœ‰å¯¹åº”çš„é…ç½®ï¼ŒåŒ…æ‹¬ç«¯å£å·ï¼ŒHTTPS è¿æ¥è®¾ç½®å’Œç½‘ç»œä¼ è¾“åè®®ã€‚åŒä¸€ä¸ªåœ°å€ä¸Šçš„ URL å¯ä»¥å…±äº«åŒä¸€ä¸ªåº•å±‚ TCP å¥—æ¥å­—è¿æ¥ã€‚é€šè¿‡å…±äº«è¿æ¥å¯ä»¥æœ‰æ˜¾è‘—çš„æ€§èƒ½æå‡ã€‚OkHttp æä¾›äº†ä¸€ä¸ªè¿æ¥æ± æ¥å¤ç”¨è¿æ¥ã€‚</p>
<p>ç¬¬ä¸‰ä¸ªè¦ç´ æ˜¯è¿æ¥ HTTP æœåŠ¡å™¨æ—¶ä½¿ç”¨çš„è·¯ç”±ã€‚è·¯ç”±åŒ…æ‹¬å…·ä½“è¿æ¥çš„ IP åœ°å€ï¼ˆé€šè¿‡ DNS æŸ¥è¯¢æ¥å‘ç°ï¼‰å’Œæ‰€ä½¿ç”¨çš„ä»£ç†æœåŠ¡å™¨ã€‚å¯¹äº HTTPS è¿æ¥è¿˜åŒ…æ‹¬é€šè®¯åå•†æ—¶ä½¿ç”¨çš„ TLS ç‰ˆæœ¬ã€‚å¯¹äºåŒä¸€ä¸ªåœ°å€ï¼Œå¯èƒ½æœ‰å¤šä¸ªä¸åŒçš„è·¯ç”±ã€‚OkHttp åœ¨é‡åˆ°è®¿é—®é”™è¯¯æ—¶ä¼šè‡ªåŠ¨å°è¯•å¤‡é€‰è·¯ç”±ã€‚</p>
<p>å½“é€šè¿‡ OkHttp æ¥è¯·æ±‚æŸä¸ª URL æ—¶ï¼ŒOkHttp é¦–å…ˆä» URL ä¸­å¾—åˆ°åœ°å€ä¿¡æ¯ï¼Œå†ä»è¿æ¥æ± ä¸­æ ¹æ®åœ°å€æ¥è·å–è¿æ¥ã€‚å¦‚æœåœ¨è¿æ¥æ± ä¸­æ²¡æœ‰æ‰¾åˆ°è¿æ¥ï¼Œåˆ™é€‰æ‹©ä¸€ä¸ªè·¯ç”±æ¥å°è¯•è¿æ¥ã€‚å°è¯•è¿æ¥éœ€è¦é€šè¿‡ DNS æŸ¥è¯¢æ¥å¾—åˆ°æœåŠ¡å™¨çš„ IP åœ°å€ï¼Œä¹Ÿä¼šç”¨åˆ°ä»£ç†æœåŠ¡å™¨å’Œ TLS ç‰ˆæœ¬ç­‰ä¿¡æ¯ã€‚å½“å®é™…çš„è¿æ¥å»ºç«‹ä¹‹åï¼ŒOkHttp å‘é€ HTTP è¯·æ±‚å¹¶è·å–å“åº”ã€‚å½“è¿æ¥å‡ºç°é—®é¢˜æ—¶ï¼ŒOkHttp ä¼šè‡ªåŠ¨é€‰æ‹©å¦å¤–çš„è·¯ç”±è¿›è¡Œå°è¯•ã€‚è¿™ä½¿å¾— OkHttp å¯ä»¥è‡ªåŠ¨å¤„ç†å¯èƒ½å‡ºç°çš„ç½‘ç»œé—®é¢˜ã€‚å½“æˆåŠŸè·å–åˆ° HTTP è¯·æ±‚çš„å“åº”ä¹‹åï¼Œå½“å‰çš„è¿æ¥ä¼šè¢«æ”¾å›åˆ°è¿æ¥æ± ä¸­ï¼Œæä¾›ç»™åç»­çš„è¯·æ±‚æ¥å¤ç”¨ã€‚è¿æ¥æ± ä¼šå®šæœŸæŠŠé—²ç½®çš„è¿æ¥å…³é—­ä»¥é‡Šæ”¾èµ„æºã€‚</p>
<h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><ul>
<li><a href="http://blog.csdn.net/a109340/article/details/73887753" target="_blank" rel="noopener">OkHttpçš„åˆå§‹åŒ–</a></li>
<li><a href="http://www.jcodecraeer.com/a/anzhuokaifa/androidkaifa/2015/0326/2643.html" target="_blank" rel="noopener">OKHttpæºç è§£æ</a></li>
<li><a href="https://juejin.im/entry/597800116fb9a06baf2eeb63" target="_blank" rel="noopener">OkHttpæºç è§£æ</a> - <a href="https://link.juejin.im/?target=http%3A%2F%2Fyuqirong.me%2F2017%2F07%2F25%2FOkHttp%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%2F" target="_blank" rel="noopener">yuqirong.me</a></li>
<li><a href="https://blog.piasy.com/2016/07/11/Understand-OkHttp/" target="_blank" rel="noopener">æ‹†è½®å­ç³»åˆ—ï¼šæ‹†OkHttp</a></li>
<li><a href="https://www.ibm.com/developerworks/cn/java/j-lo-okhttp/" target="_blank" rel="noopener">OkHttpï¼šJava å¹³å°ä¸Šçš„æ–°ä¸€ä»£ HTTP å®¢æˆ·ç«¯ - IBM DeveloperWorks</a></li>
<li><a href="http://blog.csdn.net/carson_ho/article/details/52171976" target="_blank" rel="noopener">Androidä¸»æµç½‘ç»œè¯·æ±‚å¼€æºåº“çš„å¯¹æ¯”ï¼ˆAndroid-Async-Httpã€Volleyã€OkHttpã€Retrofitï¼‰</a></li>
<li><a href="https://www.jianshu.com/p/77d418e7b5d6" target="_blank" rel="noopener">OkHttp, Retrofit, Volleyåº”è¯¥é€‰æ‹©å“ªä¸€ä¸ªï¼Ÿ</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      
        <div id="donation_div"></div>

<script src="../../../../js/vdonate.js"></script>
<script>
var a = new Donate({
  title: 'å¦‚æœè§‰å¾—æˆ‘çš„æ–‡ç« å¯¹æ‚¨æœ‰ç”¨ï¼Œè¯·éšæ„æ‰“èµã€‚æ‚¨çš„æ”¯æŒå°†é¼“åŠ±æˆ‘ç»§ç»­åˆ›ä½œ!', // å¯é€‰å‚æ•°ï¼Œæ‰“èµæ ‡é¢˜
  btnText: 'æ‰“èµæ”¯æŒ', // å¯é€‰å‚æ•°ï¼Œæ‰“èµæŒ‰é’®æ–‡å­—
  el: document.getElementById('donation_div'),
  wechatImage: 'https://raw.githubusercontent.com/iTimeTraveler/iTimeTraveler.github.io/site/source/about/donate/images/WeChanQR.png',
  alipayImage: 'https://raw.githubusercontent.com/iTimeTraveler/iTimeTraveler.github.io/site/source/about/donate/images/AliPayQR.jpg'
});
</script>
      
      
        
	<div id="comment">
		<!-- æ¥å¿…åŠ›Cityç‰ˆå®‰è£…ä»£ç  -->
		<div id="lv-container" data-id="city" data-uid="MTAyMC8yOTQ4MS82MDQ5">
		<script type="text/javascript">
		   (function(d, s) {
		       var j, e = d.getElementsByTagName(s)[0];

		       if (typeof LivereTower === 'function') { return; }

		       j = d.createElement(s);
		       j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
		       j.async = true;

		       e.parentNode.insertBefore(j, e);
		   })(document, 'script');
		</script>
		<noscript>ä¸ºæ­£å¸¸ä½¿ç”¨æ¥å¿…åŠ›è¯„è®ºåŠŸèƒ½è¯·æ¿€æ´»JavaScript</noscript>
		</div>
		<!-- Cityç‰ˆå®‰è£…ä»£ç å·²å®Œæˆ -->
	</div>



      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="../../../../tags/Android/">Android</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="../../../../tags/æºç åˆ†æ/">æºç åˆ†æ</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="../../../02/13/ã€Javaã€‘çº¿ç¨‹æ± ThreadPoolExecutorå®ç°åŸç†/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">ä¸Šä¸€ç¯‡</strong>
      <div class="article-nav-title">
        
          ã€Javaã€‘çº¿ç¨‹æ± ThreadPoolExecutorå®ç°åŸç†
        
      </div>
    </a>
  
  
    <a href="../../22/ç”¨Javaå®ç°æ–­ç‚¹ç»­ä¼  (HTTP)/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">ä¸‹ä¸€ç¯‡</strong>
      <div class="article-nav-title">ç”¨Javaå®ç°æ–­ç‚¹ç»­ä¼  (HTTP)</div>
    </a>
  
</nav>

  
</article>

<!-- Table of Contents -->

  <aside id="toc-sidebar">
    <div id="toc" class="toc-article">
    <strong class="toc-title">æ–‡ç« ç›®å½•</strong>
    
        <ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#HttpClient-vs-HttpURLConnection"><span class="nav-number">1.</span> <span class="nav-text">HttpClient vs HttpURLConnection</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#äºŒè€…å¯¹æ¯”"><span class="nav-number">1.1.</span> <span class="nav-text">äºŒè€…å¯¹æ¯”</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#äºŒè€…ä¸ç½‘ç»œè¯·æ±‚åº“ä¹‹é—´çš„å…³ç³»"><span class="nav-number">1.2.</span> <span class="nav-text">äºŒè€…ä¸ç½‘ç»œè¯·æ±‚åº“ä¹‹é—´çš„å…³ç³»</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#OkHttpç®€ä»‹"><span class="nav-number">2.</span> <span class="nav-text">OkHttpç®€ä»‹</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#å¦‚ä½•ä½¿ç”¨"><span class="nav-number">3.</span> <span class="nav-text">å¦‚ä½•ä½¿ç”¨</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#åŒæ­¥Getè¯·æ±‚"><span class="nav-number">3.1.</span> <span class="nav-text">åŒæ­¥Getè¯·æ±‚</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#å¼‚æ­¥Getè¯·æ±‚"><span class="nav-number">3.2.</span> <span class="nav-text">å¼‚æ­¥Getè¯·æ±‚</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Postè¯·æ±‚"><span class="nav-number">3.3.</span> <span class="nav-text">Postè¯·æ±‚</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#æºç åˆ†æ"><span class="nav-number">4.</span> <span class="nav-text">æºç åˆ†æ</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#OkHttpClient"><span class="nav-number">4.1.</span> <span class="nav-text">OkHttpClient</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Call"><span class="nav-number">4.2.</span> <span class="nav-text">Call</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#RealCall"><span class="nav-number">4.3.</span> <span class="nav-text">RealCall</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#RealInterceptorChain"><span class="nav-number">4.4.</span> <span class="nav-text">RealInterceptorChain</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#æ‹¦æˆªå™¨Interceptor"><span class="nav-number">4.5.</span> <span class="nav-text">æ‹¦æˆªå™¨Interceptor</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#RetryAndFollowUpInterceptorï¼ˆé‡è¯•å’Œé‡å®šå‘æ‹¦æˆªå™¨ï¼‰"><span class="nav-number">4.5.1.</span> <span class="nav-text">RetryAndFollowUpInterceptorï¼ˆé‡è¯•å’Œé‡å®šå‘æ‹¦æˆªå™¨ï¼‰</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#BridgeInterceptorï¼ˆè¯·æ±‚æ„é€ æ‹¦æˆªå™¨ï¼‰"><span class="nav-number">4.5.2.</span> <span class="nav-text">BridgeInterceptorï¼ˆè¯·æ±‚æ„é€ æ‹¦æˆªå™¨ï¼‰</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#CacheInterceptorï¼ˆç¼“å­˜æ‹¦æˆªå™¨ï¼‰"><span class="nav-number">4.5.3.</span> <span class="nav-text">CacheInterceptorï¼ˆç¼“å­˜æ‹¦æˆªå™¨ï¼‰</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ConnectInterceptor"><span class="nav-number">4.5.4.</span> <span class="nav-text">ConnectInterceptor</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#CallServerInterceptor"><span class="nav-number">4.5.5.</span> <span class="nav-text">CallServerInterceptor</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#å°ç»“"><span class="nav-number">4.5.6.</span> <span class="nav-text">å°ç»“</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#å¼‚æ­¥è¯·æ±‚"><span class="nav-number">5.</span> <span class="nav-text">å¼‚æ­¥è¯·æ±‚</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#RealCall-1"><span class="nav-number">5.1.</span> <span class="nav-text">RealCall</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Dispatcher"><span class="nav-number">5.2.</span> <span class="nav-text">Dispatcher</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#AsyncCall"><span class="nav-number">5.3.</span> <span class="nav-text">AsyncCall</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#æ€»ç»“"><span class="nav-number">6.</span> <span class="nav-text">æ€»ç»“</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#HTTP-è¿æ¥"><span class="nav-number">7.</span> <span class="nav-text">HTTP è¿æ¥</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#å‚è€ƒèµ„æ–™"><span class="nav-number">8.</span> <span class="nav-text">å‚è€ƒèµ„æ–™</span></a></li></ol>
    
    </div>
  </aside>
</section>
        
      </div>
      
      <footer id="footer">
  

  <div class="container">
      	<div class="row">
	      <p> Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/iTimeTraveler/hexo-theme-hiker" target="_blank">Hexo-theme-hiker</a> </p>
	      <p id="copyRightEn">Copyright &copy; 2013 - 2018 iTimeTraveler All Rights Reserved.</p>
	      
	      
    		<p class="busuanzi_uv">
				è®¿å®¢æ•° : <span id="busuanzi_value_site_uv"></span> |  
				è®¿é—®é‡ : <span id="busuanzi_value_site_pv"></span>
		    </p>
  		   
		</div>

		
  </div>
</footer>


<!-- min height -->

<script>
    var wrapdiv = document.getElementById("wrap");
    var contentdiv = document.getElementById("content");
    var allheader = document.getElementById("allheader");

    wrapdiv.style.minHeight = document.body.offsetHeight + "px";
    if (allheader != null) {
      contentdiv.style.minHeight = document.body.offsetHeight - allheader.offsetHeight - document.getElementById("footer").offsetHeight + "px";
    } else {
      contentdiv.style.minHeight = document.body.offsetHeight - document.getElementById("footer").offsetHeight + "px";
    }
</script>
    </div>
    <!-- <nav id="mobile-nav">
  
    <a href="../../../../index.html" class="mobile-nav-link">Home</a>
  
    <a href="../../../../archives" class="mobile-nav-link">Archives</a>
  
    <a href="../../../../categories" class="mobile-nav-link">Categories</a>
  
    <a href="../../../../tags" class="mobile-nav-link">Tags</a>
  
    <a href="../../../../funnysite" class="mobile-nav-link">é…·ç«™</a>
  
    <a href="../../../../collection" class="mobile-nav-link">æ”¶è—</a>
  
    <a href="../../../../about" class="mobile-nav-link">About</a>
  
    <a href="../../../../mybooks" class="mobile-nav-link">ğŸ</a>
  
</nav> -->
    

<!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  <link rel="stylesheet" href="../../../../fancybox/jquery.fancybox.css">
  <script src="../../../../fancybox/jquery.fancybox.pack.js"></script>


<script src="../../../../js/scripts.js"></script>




  <script src="../../../../js/dialog.js"></script>








	<div style="display: none;">
    <script src="https://s95.cnzz.com/z_stat.php?id=1260716016&web_id=1260716016" language="JavaScript"></script>
  </div>



	<script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
	</script>






  </div>

  <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" style="display: none;">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title" id="myModalLabel">è®¾ç½®</h2>
      </div>
      <hr style="margin-top:0px; margin-bottom:0px; width:80%; border-top: 3px solid #000;">
      <hr style="margin-top:2px; margin-bottom:0px; width:80%; border-top: 1px solid #000;">


      <div class="modal-body">
          <div style="margin:6px;">
            <a data-toggle="collapse" data-parent="#accordion" href="#collapseOne" onclick="javascript:setFontSize();" aria-expanded="true" aria-controls="collapseOne">
              æ­£æ–‡å­—å·å¤§å°
            </a>
          </div>
          <div id="collapseOne" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingOne">
          <div class="panel-body">
            æ‚¨å·²è°ƒæ•´é¡µé¢å­—ä½“å¤§å°
          </div>
        </div>
      


          <div style="margin:6px;">
            <a data-toggle="collapse" data-parent="#accordion" href="#collapseTwo" onclick="javascript:setBackground();" aria-expanded="true" aria-controls="collapseTwo">
              å¤œé—´æŠ¤çœ¼æ¨¡å¼
            </a>
        </div>
          <div id="collapseTwo" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingTwo">
          <div class="panel-body">
            å¤œé—´æ¨¡å¼å·²ç»å¼€å¯ï¼Œå†æ¬¡å•å‡»æŒ‰é’®å³å¯å…³é—­ 
          </div>
        </div>

        <div>
            <a data-toggle="collapse" data-parent="#accordion" href="#collapseThree" aria-expanded="true" aria-controls="collapseThree">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å…³ äº&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</a>
        </div>
         <div id="collapseThree" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingThree">
          <div class="panel-body">
            iTimeTraveler
          </div>
          <div class="panel-body">
            Copyright Â© 2018 Mr.Seven All Rights Reserved.
          </div>
        </div>
      </div>


      <hr style="margin-top:0px; margin-bottom:0px; width:80%; border-top: 1px solid #000;">
      <hr style="margin-top:2px; margin-bottom:0px; width:80%; border-top: 3px solid #000;">
      <div class="modal-footer">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">Ã—</span></button>
      </div>
    </div>
  </div>
</div>
  
  <a id="rocket" href="#top" class=""></a>
  <script type="text/javascript" src="/js/totop.js?v=1.0.0" async=""></script>
  
    <a id="menu-switch"><i class="fa fa-bars fa-lg"></i></a>
  
</body>
</html>